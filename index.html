<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tennis Training</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Journal Modal Large & Responsive */
        #journalEntryModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(20, 28, 38, 0.45);
            backdrop-filter: blur(8px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            transition: opacity 0.18s;
        }
        #journalEntryModal.active {
            display: flex;
            opacity: 1;
        }
        .journal-modal-box {
            background: white;
            padding: 2.2rem 2.5rem;
            border-radius: 18px;
            box-shadow: 0 16px 40px rgba(15,23,42,0.12);
            width: 90vw;
            max-width: 900px;
            min-width: 320px;
            min-height: 200px;
            animation: journalModalPop 0.22s cubic-bezier(.4,1.4,.6,1) 1;
            transform: scale(1);
            opacity: 1;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
        @keyframes journalModalPop {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        #journalEntryTextarea {
            min-height: 250px;
            font-size: 1.08rem;
            padding: 1rem 1.2rem;
            border-radius: 12px;
            border: 1px solid #e6edf3;
            background: linear-gradient(180deg,#fff,#fcfeff);
            color: #0f2540;
            resize: vertical;
        }
        .journal-card {
            display: block;
            padding: 1rem 1.1rem;
            border-radius: 14px;
            background: linear-gradient(180deg,#ffffff,#fbfdff);
            border: 1px solid #eef4f8;
            box-shadow: 0 10px 26px rgba(15,23,42,0.07);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .journal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 14px 30px rgba(15,23,42,0.1);
        }
        .journal-preview {
            margin-top: 0.5rem;
            color: var(--muted);
            font-size: 1.01rem;
            white-space: pre-line;
            display: -webkit-box;
            line-clamp: 4;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .modal-actions{
            display:flex;
            gap:0.7rem;
            justify-content:flex-end;
        }
        .filter-bar{
            display:flex;
            gap:0.8rem;
            flex-wrap:wrap;
            margin:0 0 1rem 0;
        }
        .filter-bar input,
        .filter-bar select{
            max-width:220px;
        }
        .badge{
            display:inline-flex;
            align-items:center;
            padding:0.2rem 0.55rem;
            border-radius:999px;
            font-size:0.75rem;
            font-weight:600;
            background:#eef2f7;
            color:#3b4a5a;
        }
        .badge-accent{background:rgba(26,188,156,0.15);color:#0f766e;}
        .badge-success{background:rgba(16,185,129,0.18);color:#047857;}
        .badge-danger{background:rgba(239,68,68,0.18);color:#b91c1c;}
        .badge-warning{background:rgba(245,158,11,0.2);color:#b45309;}
        .badge-info{background:rgba(59,130,246,0.18);color:#1d4ed8;}
        #journalViewModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(20, 28, 38, 0.45);
            backdrop-filter: blur(8px);
            z-index: 110;
            align-items: center;
            justify-content: center;
        }
        #journalViewModal.active {
            display: flex;
        }
        #calendarDetailModal{
            display:none;
            position:fixed;
            top:0;left:0;width:100vw;height:100vh;
            background: rgba(20, 28, 38, 0.45);
            backdrop-filter: blur(8px);
            z-index: 115;
            align-items:center;
            justify-content:center;
        }
        #calendarDetailModal.active{display:flex;}
        .calendar-detail-box{
            background:white;
            padding:1.6rem 1.8rem;
            border-radius:16px;
            box-shadow:0 16px 40px rgba(15,23,42,0.12);
            width:90vw;
            max-width:700px;
            min-width:280px;
            animation: journalModalPop 0.22s cubic-bezier(.4,1.4,.6,1) 1;
            display:flex;
            flex-direction:column;
            gap:1rem;
        }
        .calendar-detail-section{padding:0.6rem 0;border-top:1px solid #eef4f8;}
        .calendar-detail-section:first-of-type{border-top:none;padding-top:0;}
        .calendar-detail-title{font-weight:600;color:#0f2540;margin-bottom:0.4rem;}
        .calendar-detail-item{color:var(--muted);font-size:0.95rem;margin:0.2rem 0;}
        #historyEditModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(20, 28, 38, 0.45);
            backdrop-filter: blur(8px);
            z-index: 120;
            align-items: center;
            justify-content: center;
        }
        #historyEditModal.active {
            display: flex;
        }
        .history-edit-box {
            background: white;
            padding: 1.6rem 1.8rem;
            border-radius: 16px;
            box-shadow: 0 16px 40px rgba(15,23,42,0.12);
            width: 90vw;
            max-width: 520px;
            min-width: 280px;
            animation: journalModalPop 0.22s cubic-bezier(.4,1.4,.6,1) 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .journal-view-box {
            background: white;
            padding: 2rem 2.2rem;
            border-radius: 18px;
            box-shadow: 0 16px 40px rgba(15,23,42,0.12);
            width: 90vw;
            max-width: 820px;
            min-width: 320px;
            animation: journalModalPop 0.22s cubic-bezier(.4,1.4,.6,1) 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .journal-modal-box,
        .journal-view-box,
        .history-edit-box,
        .calendar-detail-box{
            max-height:90vh;
            overflow-y:auto;
        }
        @media (max-width: 700px) {
            .journal-modal-box { padding: 1.1rem 0.7rem; max-width: 99vw; }
            #journalEntryTextarea { font-size: 1rem; }
        }
        :root{
            --bg:#f4f6f9;
            --card:#ffffff;
            --muted:#67748a;
            --accent:#1abc9c;
            --accent-600:#16a085;
            --accent-700:#128b73;
            --nav-bg:#243746;
            --radius:12px;
            --gap:1rem;
            --max-width:1100px;
            --shadow-sm: 0 6px 18px rgba(15,23,42,0.06);
            --shadow-md: 0 12px 30px rgba(15,23,42,0.10);
            --shadow-lg: 0 22px 60px rgba(15,23,42,0.18);
            --glass: rgba(255,255,255,0.6);
        }

        *{
            box-sizing:border-box;
            margin:0;
            padding:0;
            transition:
                background 0.25s cubic-bezier(.4,0,.2,1),
                box-shadow 0.25s cubic-bezier(.4,0,.2,1),
                transform 0.25s cubic-bezier(.4,0,.2,1);
        }
        html,body{height:100%}
        body{
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background:
                radial-gradient(circle at 20% 10%, rgba(26,188,156,0.08), transparent 40%),
                radial-gradient(circle at 80% 90%, rgba(59,130,246,0.08), transparent 40%),
                linear-gradient(180deg,#f7fbfd 0%, var(--bg) 100%);
            color:#12223a;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            line-height:1.55;
        }

        .navbar{
            background: rgba(20, 28, 38, 0.75);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding:0.8rem 1rem;
            position:sticky;top:0;z-index:40;
            box-shadow:
                0 8px 30px rgba(0,0,0,0.25),
                inset 0 1px 0 rgba(255,255,255,0.08);
        }

        .nav-tabs{
            display:flex;gap:0.6rem;align-items:center;max-width:var(--max-width);margin:0 auto;padding:0 1rem;overflow:auto;
        }
        .nav-tabs{
            -webkit-overflow-scrolling: touch;
        }

        .tab-button{
            white-space:nowrap;
            padding:0.65rem 1.05rem;
            border-radius:999px;
            border:none;
            background:transparent;
            color:#dbe7ef;
            font-weight:600;
            cursor:pointer;
            transition:all 0.2s ease;
            font-size:0.95rem;
        }
        .tab-button:hover{
            background:rgba(255,255,255,0.08);
            color:#fff;
            transform:translateY(-2px);
        }
        .tab-button.active{
            background: linear-gradient(180deg, var(--accent), var(--accent-600));
            color:white;
            box-shadow:
                0 6px 20px rgba(26,188,156,0.35),
                0 0 0 1px rgba(255,255,255,0.25) inset;
            transform: translateY(-1px);
        }

        .container{
            max-width:var(--max-width);
            margin:2.5rem auto;
            padding:0 1rem;
            animation: fadeIn 0.35s ease;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content{display:none;background:linear-gradient(180deg,#ffffff 0%,#fbfdff 100%);border:1px solid #eef4f8;padding:1.8rem;border-radius:var(--radius);box-shadow:var(--shadow-sm);animation:fadeIn 0.35s ease}
        .tab-content.active{display:block}

        h1{font-size:1.7rem;margin-bottom:0.85rem;color:#0f2540;font-weight:700;letter-spacing:-0.03em}
        p{color:var(--muted);margin-bottom:1rem}

        .form-group{margin-bottom:1rem}
        label{display:block;margin-bottom:.4rem;color:#233348;font-weight:600;font-size:.95rem}

        input,textarea,select{width:100%;padding:.75rem 1rem;border-radius:10px;border:1px solid #e6edf3;background:linear-gradient(180deg,#fff,#fcfeff);font-size:0.95rem;color:#0f2540;transition:all 0.2s ease}
        textarea{min-height:110px;resize:vertical}

        .submit-btn{
            position:relative;
            overflow:hidden;
            background: linear-gradient(180deg, var(--accent), var(--accent-600));
            color:white;
            padding:.75rem 1.2rem;
            border-radius:10px;
            border:none;
            font-weight:600;
            cursor:pointer;
            box-shadow: 0 10px 24px rgba(26,188,156,0.18);
            transition: all 0.2s ease;
        }
        .submit-btn::after{
            content:'';
            position:absolute;
            inset:0;
            background:linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent);
            opacity:0;
            transition:opacity 0.25s;
        }
        .submit-btn:hover{
            transform:translateY(-2px);
            box-shadow:0 14px 30px rgba(26,188,156,0.22);
        }
        .submit-btn:hover::after{
            opacity:1;
        }
        .submit-btn:active{transform:translateY(0);box-shadow:0 8px 18px rgba(26,188,156,0.18)}
        .submit-btn.btn-secondary{background:linear-gradient(180deg,#3b82f6,#2563eb);box-shadow:0 10px 24px rgba(37,99,235,0.2)}
        .submit-btn.btn-muted{background:linear-gradient(180deg,#94a3b8,#64748b);box-shadow:0 10px 24px rgba(100,116,139,0.2)}
        .submit-btn.btn-danger{background:linear-gradient(180deg,#ef4444,#dc2626);box-shadow:0 10px 24px rgba(239,68,68,0.2)}
        .submit-btn.btn-sm{padding:0.5rem 0.9rem;font-size:0.9rem}

        /* Cards & lists */
        .session-list{list-style:none;padding:0;margin:0}
        .session-list li{
            display:block;
            padding:1rem;
            border-radius:14px;
            background:linear-gradient(180deg,#ffffff,#fbfdff);
            border:1px solid #eef4f8;
            margin-bottom:0.9rem;
            box-shadow:0 10px 26px rgba(15,23,42,0.07);
            transition:all 0.2s ease;
        }
        .session-list li:hover{
            transform:translateY(-3px);
            box-shadow:0 14px 30px rgba(15,23,42,0.1);
        }
        .session-list li strong{display:block;margin-bottom:.5rem}
        .card-actions{display:flex;gap:0.6rem;flex-wrap:wrap}

        /* Design items list */
        #designItemsList li{display:flex;align-items:center;justify-content:space-between;padding:.6rem .75rem;border-radius:8px;background:linear-gradient(180deg,#fbfdff,#ffffff);border:1px solid #eef4f8;margin-bottom:.5rem}
        #designItemsList li button{background:transparent;border:1px solid #e6eef2;padding:.35rem .55rem;border-radius:8px;color:#234;color:#2b4b61;cursor:pointer}

        /* Inline design button on home */
        #designInlineBtn{padding:.75rem 1.1rem;border-radius:10px}

        /* Small helpers */
        .muted{color:var(--muted);font-size:.95rem}

        /* Actuaries Module */
        .actuary-module-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:1rem}
        .actuary-module-card{
            border:1px solid #e6edf3;
            border-radius:16px;
            padding:1.2rem;
            background:linear-gradient(180deg,#ffffff,#fbfdff);
            box-shadow:0 10px 26px rgba(15,23,42,0.07);
            cursor:pointer;
            text-align:left;
            display:flex;
            flex-direction:column;
            gap:0.35rem;
        }
        .actuary-module-card span{font-size:1.6rem}
        .actuary-module-card h3{margin:0;color:#0f2540;font-size:1.1rem}
        .actuary-module-card p{margin:0;color:var(--muted);font-size:0.9rem}
        .actuary-subject-header{display:flex;gap:1rem;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:1rem}
        .actuary-notes-list{display:flex;flex-direction:column;gap:0.8rem}
        .actuary-note-card{
            border:1px solid #eef4f8;
            border-radius:14px;
            padding:1rem;
            background:linear-gradient(180deg,#ffffff,#fbfdff);
            box-shadow:0 8px 20px rgba(15,23,42,0.06);
            display:flex;
            gap:1rem;
            align-items:center;
            justify-content:space-between;
            flex-wrap:wrap;
        }
        .actuary-note-card.dragging{opacity:0.6;transform:scale(0.98)}
        .actuary-note-meta{flex:1 1 260px;min-width:240px}
        .actuary-note-meta h4{margin:0 0 0.35rem 0;color:#0f2540}
        .actuary-progress{height:8px;background:#eef4f8;border-radius:999px;overflow:hidden}
        .actuary-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),#34d399);width:35%}
        .actuary-editor-modal{
            display:none;
            position:fixed;
            inset:0;
            background:rgba(20, 28, 38, 0.55);
            backdrop-filter: blur(10px);
            z-index:130;
            align-items:stretch;
            justify-content:center;
        }
        .actuary-editor-modal.active{display:flex}
        .actuary-editor-box{
            background:#ffffff;
            width:100%;
            max-width:1400px;
            margin:1.2rem;
            border-radius:16px;
            border:1px solid #e5e7eb;
            box-shadow:0 20px 50px rgba(15,23,42,0.15), 0 4px 12px rgba(0,0,0,0.08);
            display:flex;
            flex-direction:column;
            padding:0;
            gap:0;
            overflow:hidden;
        }
        .actuary-editor-top{
            display:flex;
            gap:0.8rem;
            align-items:center;
            justify-content:space-between;
            flex-wrap:wrap;
            padding:1.2rem 1.8rem;
            border-bottom:1px solid #e5e7eb;
            background:#fafbfc;
        }
        .actuary-editor-modes{display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center}
        .actuary-font-controls{display:flex;gap:0.4rem;align-items:center;margin-left:auto}
        .actuary-font-controls button{
            width:32px;
            height:32px;
            padding:0;
            font-size:14px;
            font-weight:600;
            border:1px solid #d1d5db;
            background:white;
            color:#374151;
            border-radius:6px;
            cursor:pointer;
            transition:all 0.15s;
        }
        .actuary-font-controls button:hover{background:#f3f4f6;border-color:#9ca3af}
        .actuary-editor-row{
            display:flex;
            gap:1rem;
            flex-wrap:wrap;
            align-items:center;
            padding:1.2rem 1.8rem;
            border-bottom:1px solid #e5e7eb;
        }
        .actuary-editor-row label{font-weight:600;color:#111827;font-size:14px}
        .actuary-editor-row input{
            flex:1 1 320px;
            border:1px solid #d1d5db;
            border-radius:8px;
            padding:0.6rem 0.9rem;
            font-size:16px;
            font-weight:500;
            color:#111827;
        }
        .actuary-editor-row input:focus{outline:2px solid #1abc9c;border-color:transparent}
        .note-container{
            flex:1 1 auto;
            max-width:1100px;
            margin:0 auto;
            width:100%;
            padding:2rem 3rem;
            min-height:70vh;
            overflow:visible;
        }
        .note-content{
            font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            font-size:17px;
            line-height:1.7;
            color:#1f2937;
            min-height:70vh;
            outline:none;
        }
        .note-content:focus{
            outline:none;
        }
        .note-content h1{
            font-size:32px;
            font-weight:700;
            margin:28px 0 14px;
            color:#111827;
            line-height:1.3;
        }
        .note-content h2{
            font-size:26px;
            font-weight:700;
            margin:24px 0 12px;
            color:#111827;
            line-height:1.35;
        }
        .note-content h3{
            font-size:21px;
            font-weight:600;
            margin:20px 0 10px;
            color:#111827;
            line-height:1.4;
        }
        .note-content p{
            margin:14px 0;
        }
        .note-content ul,
        .note-content ol{
            margin:14px 0 14px 24px;
            padding-left:8px;
        }
        .note-content li{
            margin:8px 0;
        }
        .note-content strong{
            font-weight:600;
            color:#111827;
        }
        .note-content hr{
            border:none;
            border-top:1px solid #e5e7eb;
            margin:24px 0;
        }
        .note-content blockquote{
            border-left:3px solid #1abc9c;
            padding-left:16px;
            margin:16px 0;
            color:#4b5563;
            font-style:italic;
        }
        .note-content code{
            background:#f3f4f6;
            padding:2px 6px;
            border-radius:4px;
            font-family:'Consolas', 'Monaco', monospace;
            font-size:0.9em;
            color:#dc2626;
        }
        #noteEditor{
            display:block;
        }
        #noteViewer{
            display:none;
        }
        .actuary-editor-body-wrapper{
            flex:1 1 auto;
            background:#ffffff;
            overflow-y:auto;
            overflow-x:hidden;
        }
        
        /* Text Highlighting */
        .note-highlight {
            background-color: #fff59d;
            padding: 0;
            border-radius: 0;
            cursor: pointer;
        }
        .note-highlight:hover {
            background-color: #ffe066;
        }

        /* Learn Modal */
        .learn-overlay{
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .learn-modal {
            width: 90%;
            max-width: 900px;
            min-height: 520px;
            background: white;
            border-radius: 16px;
            padding: 28px 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 18px;
            position: relative;
        }
        .learn-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .learn-modal-close{
            width:36px;
            height:36px;
            border:none;
            border-radius:999px;
            background:#f3f4f6;
            color:#374151;
            font-size:20px;
            cursor:pointer;
        }
        .learn-modal h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        .label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #444;
        }
        .card-textarea {
            width: 100%;
            min-height: 120px;
            border-radius: 12px;
            border: 1px solid #dcdcdc;
            padding: 16px;
            font-size: 18px;
            line-height: 1.6;
            resize: vertical;
            font-family: 'Inter', system-ui, sans-serif;
        }
        .card-answer {
            background: #f7f9fb;
        }
        .learn-modal-body{display:flex;flex-direction:column;gap:18px;transition:opacity 0.25s ease;}
        .answer-section{display:none;margin-top:20px}
        .card-actions {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin-top: 10px;
        }
        .font-controls {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .btn {
            border: none;
            border-radius: 10px;
            padding: 10px 18px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-green {
            background: #1f9d84;
            color: white;
        }
        .btn-red {
            background: #e74c3c;
            color: white;
        }
        .btn-grey {
            background: #6c7a89;
            color: white;
        }
        
        .actuary-editor-footer{
            display:flex;
            gap:0.8rem;
            justify-content:flex-end;
            align-items:center;
            flex-wrap:wrap;
            padding:1.2rem 1.8rem;
            border-top:1px solid #e5e7eb;
            background:#fafbfc;
        }
        .actuary-split{display:flex;gap:1rem}
        .actuary-panel{
            background:linear-gradient(180deg,#ffffff 0%,#fbfdff 100%);
            border:1px solid #eef4f8;
            border-radius:14px;
            padding:1rem;
            box-shadow:var(--shadow-sm);
            position:relative;
        }
        .actuary-left{flex:0 0 60%}
        .actuary-right{flex:0 0 40%}
        #actuaryAddQuestionPopup{
            position:absolute;
            display:none;
            z-index:20;
        }
        .actuary-question-input{
            border:1px dashed #d6e0ea;
            border-radius:12px;
            padding:0.8rem;
            background:#f8fbff;
            margin-bottom:1rem;
        }
        .actuary-answer-preview{font-size:0.9rem;color:var(--muted);margin-top:0.35rem}
        .actuary-questions-list{display:flex;flex-direction:column;gap:0.7rem}
        details.actuary-question{
            border:1px solid #e8eff5;
            border-radius:12px;
            padding:0.7rem 0.9rem;
            background:linear-gradient(180deg,#ffffff,#fbfdff);
            box-shadow:0 8px 18px rgba(15,23,42,0.05);
        }
        details.actuary-question summary{cursor:pointer;font-weight:600;color:#0f2540}
        details.actuary-question .question-answer{margin-top:0.5rem;color:var(--muted)}
        .actuary-learn-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem}
        .actuary-learn-card{
            border:1px solid #e8eff5;
            border-radius:14px;
            padding:1rem;
            background:linear-gradient(180deg,#ffffff,#fbfdff);
            box-shadow:0 10px 26px rgba(15,23,42,0.06);
        }
        .actuary-learn-card h4{margin-bottom:0.6rem;color:#0f2540}
        .actuary-learn-answer{display:none;margin-top:0.5rem;color:var(--muted)}

        /* Responsive adjustments */
        @media (max-width:800px){
            .nav-tabs{gap:.5rem;padding:0 .6rem}
            h1{font-size:1.35rem}
            .tab-content{padding:1.05rem}
            .actuary-split{flex-direction:column}
            .actuary-left,.actuary-right{flex:1 1 auto}
            .actuary-editor-box{margin:0;border-radius:0;min-height:100vh}
        }

        @media (max-width:520px){
            .nav-tabs{padding:0 .5rem;gap:.5rem}
            .tab-button{padding:.6rem .85rem;font-size:.92rem}
            .container{margin:1rem auto;padding:0 .75rem}
            #designItemsList li{flex-direction:column;align-items:flex-start}
            .session-list li{padding:.85rem}
        }

        @media (max-width:600px){
            .container{padding:0 .6rem}
            .tab-content{padding:0.85rem}
            .session-list li{margin-bottom:0.6rem}
            .journal-card{padding:0.85rem}
            .submit-btn{padding:0.9rem 1.3rem;font-size:1rem}
            .journal-modal-box,
            .journal-view-box{
                width:100vw;
                height:100vh;
                max-width:100vw;
                min-width:0;
                border-radius:0;
                padding:1.1rem 1rem;
            }
            .history-edit-box,
            .calendar-detail-box{width:100vw;height:100vh;max-width:100vw;border-radius:0;padding:1.1rem 1rem}
            .session-modal-box{padding:1.2rem 1rem}
            .modal-actions{
                position:sticky;
                bottom:0;
                background: linear-gradient(180deg, rgba(255,255,255,0.7), #ffffff 60%);
                padding:0.8rem 0;
            }
            .filter-bar input,
            .filter-bar select{
                flex:1;
                min-width:140px;
                max-width:none;
            }
        }

        /* Session Modal Styles */
        #sessionModal[style*="display: none"] {
            display: none !important;
        }

        .session-modal-box{
            background: var(--card);
            margin: 0 auto;
            max-width: 640px;
            min-height: 100vh;
            position: relative;
            padding: 2rem 1.8rem;
            box-shadow: var(--shadow-lg);
        }

        #modalItemsList li {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 10px;
            background: linear-gradient(180deg, #fbfdff, #ffffff);
            border: 1px solid #eef4f8;
            margin-bottom: 0.8rem;
            gap: 1rem;
            transition: all 0.2s ease;
        }

        #modalItemsList li input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        #modalItemsList li.checked {
            background: rgba(26, 188, 156, 0.15);
            opacity: 0.65;
            border-color: rgba(26, 188, 156, 0.3);
        }

        #modalItemsList li .item-text {
            flex: 1;
            font-size: 0.95rem;
            color: #12223a;
        }

        #finishSessionBtn:hover {
            transform: translateY(-2px);
            background: var(--accent-600);
        }
    
/* Calendar Tab Styles */
#calendar,
#mobilityCalendar{
  max-width:900px;
  margin:0 auto;
}

#calendarGrid,
#mobilityCalendarGrid{
  display:flex;
  flex-direction:column;
  align-items:center;
  width:100%;
  padding:1rem;
}

.calendar-row{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  width:100%;
  max-width:550px;
  gap:8px;
  margin-bottom:8px;
}

.calendar-cell{
  width:100%;
  aspect-ratio:1/1;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:10px;
  font-weight:600;
  font-size:0.95rem;
  background:#f1f5f9;
  color:#0f2540;
    cursor:pointer;
  transition:all 0.2s ease;
}

.calendar-cell:hover{
  transform:scale(1.05);
}

.cal-train{ background:#ef4444; color:white; }
.cal-match{ background:#3b82f6; color:white; }
.cal-mobility{ background:#22c55e; color:white; }
.cal-train:hover, .cal-match:hover, .cal-mobility:hover{ transform:scale(1.08); }

#calendar select,
#mobilityCalendar select{
  padding:0.75rem 1rem;
  border-radius:8px;
  border:1px solid #e6edf3;
  background:linear-gradient(180deg,#fff,#fcfeff);
  font-weight:600;
  margin-right:0.8rem;
  margin-bottom:1.5rem;
  cursor:pointer;
}

/* Dashboard Styles */
#dashboard {
    display: none;
    min-height: 100vh;
    background:
        radial-gradient(circle at 10% 10%, rgba(26,188,156,0.12), transparent 40%),
        radial-gradient(circle at 90% 90%, rgba(59,130,246,0.10), transparent 40%),
        linear-gradient(180deg,#f8fcff 0%, #eef3f8 100%);
    padding: 2rem 1rem;
    padding-top: 6rem;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    position: relative;
    animation: fadeIn 0.35s ease;
}
#dashboard.active {
    display: flex;
}
.dashboard-container {
    text-align: center;
    max-width: 1200px;
    width: 100%;
}
.dashboard-title {
    color: #0f2540;
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
    letter-spacing:-0.03em;
}
.dashboard-subtitle {
    color: var(--muted);
    font-size: 1.1rem;
    margin-bottom: 3rem;
}
.modules-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
    width: 100%;
}
.module-card {
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    padding: 2rem 1.2rem;
    cursor: pointer;
    transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    border: 1px solid rgba(255,255,255,0.6);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 230px;
    position: relative;
    overflow: hidden;
}
.module-card::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
        120deg,
        transparent 30%,
        rgba(255,255,255,0.35),
        transparent 70%
    );
    opacity: 0;
    transition: opacity 0.4s ease;
    pointer-events: none;
}
.module-card:hover {
    transform: translateY(-10px) scale(1.03);
    box-shadow: 0 22px 60px rgba(15, 23, 42, 0.18);
    border-color: rgba(26,188,156,0.35);
}
.module-card:hover::before {
    opacity: 1;
}
.module-icon {
    font-size: 2.8rem;
    margin-bottom: 0.8rem;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
}
.module-card:hover .module-icon {
    transform: scale(1.15) rotate(3deg);
}
.module-name {
    font-size: 1.2rem;
    font-weight: 600;
    color: #0f2540;
    margin: 0;
    letter-spacing:-0.01em;
    position: relative;
    z-index: 1;
}
@media (max-width: 768px) {
    .modules-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    .dashboard-title {
        font-size: 1.8rem;
    }
}

/* Dashboard Header Styles */
#dashboardHeader {
    display: none;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 1rem 2rem;
    background: rgba(15,37,64,0.85);
    backdrop-filter: blur(14px);
    border-bottom:1px solid rgba(255,255,255,0.08);
    box-shadow:
        0 10px 30px rgba(0,0,0,0.25),
        inset 0 -1px 0 rgba(255,255,255,0.08);
    position: absolute;
    top: 0;
    left: 0;
    z-index: 10;
}
#dashboardHeader.active {
    display: flex;
}
.dashboard-header-left {
    font-size: 1.4rem;
    font-weight: 700;
    color: #fff;
}
.dashboard-header-right {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}
.dashboard-header-user {
    color: #e0e7ff;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.dashboard-header-logout {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.45rem 0.9rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(.4,0,.2,1);
}
.dashboard-header-logout:hover {
    background: #dc2626;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
}
@media (max-width: 768px) {
    #dashboardHeader {
        padding: 0.8rem 1rem;
    }
    .dashboard-header-left {
        font-size: 1.1rem;
    }
    .dashboard-header-right {
        gap: 1rem;
    }
    .dashboard-header-user {
        font-size: 0.85rem;
    }
    .dashboard-header-logout {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }
    #dashboard {
        padding-top: 5rem;
    }
}

</style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(180deg,#f7fbfd 0%,var(--bg) 100%);padding:1rem;">
        <div style="background:var(--card);padding:2rem;border-radius:12px;box-shadow:0 20px 60px rgba(15,23,42,0.12), 0 0 0 1px rgba(255,255,255,0.4);max-width:400px;width:100%;">
            <h1 style="text-align:center;color:#0f2540;margin-bottom:2rem;">Personal System</h1>
            
            <!-- Sign In Form -->
            <div id="signInForm">
                <h2 style="font-size:1.3rem;color:#0f2540;margin-bottom:1.5rem;">Sign In</h2>
                <div class="form-group">
                    <label for="signInEmail">Email:</label>
                    <input type="text" id="signInEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signInPassword">Password:</label>
                    <input type="password" id="signInPassword" placeholder="Enter your password">
                </div>
                <button class="submit-btn" style="width:100%;" onclick="handleSignIn()">Sign In</button>
                <p style="text-align:center;color:var(--muted);font-size:0.9rem;margin-top:1rem;">
                    Enter username and password to sign in. <br>
                </p>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard" style="display:none;">
        <!-- Dashboard Header -->
        <div id="dashboardHeader">
            <div class="dashboard-header-left">Welcome</div>
            <div class="dashboard-header-right">
                <div class="dashboard-header-user">
                    <span>üë§</span>
                    <span id="dashboardUserEmail">user@example.com</span>
                </div>
                <button class="dashboard-header-logout" onclick="window.firebaseLogout()">Logout</button>
            </div>
        </div>

        <div class="dashboard-container">
            <h1 class="dashboard-title">Modules</h1>
            <p class="dashboard-subtitle">Select a module to get started</p>
            <div class="modules-grid">
                <div class="module-card" onclick="selectModule('Tennis')">
                    <div class="module-icon">üéæ</div>
                    <h3 class="module-name">Tennis</h3>
                </div>
                <div class="module-card" onclick="selectModule('AI_ML_DS')">
                    <div class="module-icon">ü§ñ</div>
                    <h3 class="module-name">AI / ML / DS</h3>
                </div>
                <div class="module-card" onclick="selectModule('Actuaries')">
                    <div class="module-icon">üìä</div>
                    <h3 class="module-name">Actuaries</h3>
                </div>
                <div class="module-card" onclick="selectModule('Insurance')">
                    <div class="module-icon">üõ°Ô∏è</div>
                    <h3 class="module-name">Insurance</h3>
                </div>
                <div class="module-card" onclick="selectModule('Mobility - Physio')">
                    <div class="module-icon">üí™</div>
                    <h3 class="module-name">Mobility - Physio</h3>
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar" id="navbar" style="display:none;">
        <div class="nav-tabs">
            <button class="tab-button" data-tab="dashboard" onclick="showDashboard()" style="font-weight:600;color:#3b82f6;">‚Üê Dashboard</button>
            <button class="tab-button active" data-tab="home" onclick="switchTab('home', this)">Home</button>
            <button class="tab-button" data-tab="mobilityHome" onclick="switchTab('mobilityHome', this)" style="display:none;">Home</button>
            <button class="tab-button" data-tab="mobilitySessions" onclick="switchTab('mobilitySessions', this)" style="display:none;">Sessions</button>
            <button class="tab-button" data-tab="mobilityTemplates" onclick="switchTab('mobilityTemplates', this)" style="display:none;">Exercise Templates</button>
            <button class="tab-button" data-tab="mobilityCalendar" onclick="switchTab('mobilityCalendar', this)" style="display:none;">Calendar</button>
            <button class="tab-button" data-tab="sessions" onclick="switchTab('sessions', this)">Sessions</button>
            <button class="tab-button" data-tab="match" onclick="switchTab('match', this)">Match</button>
            <button class="tab-button" data-tab="history" onclick="switchTab('history', this)">History</button>
            <button class="tab-button" data-tab="calendar" onclick="switchTab('calendar', this)">Calendar</button>
            <button class="tab-button" data-tab="journal" onclick="switchTab('journal', this)">Journal</button>
            <button class="tab-button" data-tab="actuaryNotes" onclick="switchTab('actuaryNotes', this)" style="display:none;">Notes</button>
            <button class="tab-button" data-tab="actuaryLearn" onclick="switchTab('actuaryLearn', this)" style="display:none;">Learn</button>
            <span id="currentUserDisplay" style="margin-left:auto;padding:0.5rem 1rem;color:var(--text);font-size:0.9rem;align-self:center;"></span>
            <button class="submit-btn btn-danger btn-sm" onclick="handleLogout()">Logout</button>
        </div>
    </nav>

    <div class="container" id="mainContainer" style="display:none;">
        <!-- Home Tab -->
        <div id="home" class="tab-content active">
            <!-- Tennis Home Section -->
            <div id="tennisHomeSection" style="display:block;">
                <h1>Welcome to My Tennis Training</h1>
                <p style="margin-bottom:1rem;color:#555">Use the button below to design a new session.</p>
                <div style="margin-top:1rem;">
                    <button class="submit-btn" id="designInlineBtn" onclick="switchTab('design', this)">Design Your Session</button>
                </div>
            </div>

            <!-- Generic Module Section -->
            <div id="moduleHomeSection" style="display:none;">
                <div style="text-align:center;padding:2rem 1rem;">
                    <div style="font-size:2.5rem;margin-bottom:1rem;color:#666;">üìã</div>
                    <h1 id="moduleHomeName" style="color:#0f2540;margin:0 0 0.5rem 0;"></h1>
                    <p style="color:#999;font-size:1rem;margin:0;">This module is under development</p>
                </div>
            </div>
        </div>

        <div id="mobilityHome" class="tab-content">
            <h1>Mobility &amp; Physio</h1>
            <p style="margin-bottom:1rem;color:#555">Build and execute your mobility routines.</p>
            <div style="margin-top:1rem;">
                <button class="submit-btn" onclick="openMobilityDesignSessionModal()">Design Session</button>
            </div>
        </div>

        <div id="mobilitySessions" class="tab-content">
            <h1>Upcoming Mobility Sessions</h1>
            <ul class="session-list" id="mobilitySessionsList"></ul>
        </div>

        <div id="mobilityTemplates" class="tab-content">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;">
                <h1 style="margin:0;">Mobility Templates</h1>
                <button class="submit-btn" onclick="openMobilityTemplateBuilder()">+ Create Template</button>
            </div>
            <ul class="session-list" id="mobilityTemplatesList"></ul>
        </div>

        <div id="mobilityCalendar" class="tab-content">
            <h1>Calendar</h1>
            <div style="display:flex;gap:1rem;margin-bottom:1rem;">
                <select id="mobilityCalMonth"></select>
                <select id="mobilityCalYear"></select>
            </div>
            <div id="mobilityCalendarGrid"></div>
        </div>

        <!-- Actuaries Notes Tab -->
        <div id="actuaryNotes" class="tab-content">
            <h1>Actuaries Notes</h1>

            <div id="actuaryHomeView">
                <p class="muted">Choose a subject to manage your study notes.</p>
                <div class="actuary-module-grid">
                    <div class="actuary-module-card" role="button" tabindex="0" onclick="showSubjectNotes('SP1')">
                        <span>üìò</span>
                        <h3>SP1</h3>
                        <p>Core principles and practice</p>
                    </div>
                    <div class="actuary-module-card" role="button" tabindex="0" onclick="showSubjectNotes('SP2')">
                        <span>üìô</span>
                        <h3>SP2</h3>
                        <p>Advanced models and applications</p>
                    </div>
                </div>
            </div>

            <div id="actuarySubjectView" style="display:none;">
                <div class="actuary-subject-header">
                    <button class="submit-btn btn-muted btn-sm" onclick="showActuaryModules()">‚Üê Actuaries Home</button>
                    <div>
                        <h2 id="actuarySubjectTitle" style="margin:0;color:#0f2540;"></h2>
                        <p class="muted" style="margin:0.2rem 0 0 0;">All notes for this subject</p>
                    </div>
                    <button class="submit-btn btn-sm" onclick="openNoteEditor()">+ Add New Note</button>
                </div>
                <div id="actuaryNotesList" class="actuary-notes-list"></div>
            </div>
        </div>

        <!-- Actuaries Learn Tab -->
        <div id="actuaryLearn" class="tab-content">
            <h1>Actuaries Learn</h1>
            <div class="actuary-toolbar">
                <div>
                    <label for="actuaryLearnSubject">Subject</label>
                    <select id="actuaryLearnSubject" onchange="loadLearnQuestions(this.value)"></select>
                </div>
            </div>
            <div id="actuaryLearnList" class="actuary-learn-grid"></div>
        </div>

        <!-- Design Tab -->
        <div id="design" class="tab-content">
            <h1>Design Your Session</h1>
            <form id="designForm" onsubmit="return false;">
                <div class="form-group">
                    <label for="designDate">Date:</label>
                    <input type="date" id="designDate">
                </div>
                <div class="form-group">
                    <label for="designType">Type:</label>
                    <select id="designType" onchange="onDesignTypeChange()">
                        <option value="">Select type...</option>
                        <option value="Conditioning">Conditioning</option>
                        <option value="Tennis Drills">Tennis Drills</option>
                        <option value="Rallies">Rallies</option>
                        <option value="Match Points">Match Points</option>
                    </select>
                </div>
                <div class="form-group" id="exerciseGroup" style="display:none;">
                    <label id="exerciseLabel" for="designExercise">Exercise:</label>
                    <input type="text" id="designExercise" placeholder="Enter exercise name">
                </div>
                <div class="form-group" id="durationGroup" style="display:none;">
                    <label for="designDuration">Time to allocate (minutes):</label>
                    <input type="number" id="designDuration" min="1" placeholder="e.g., 15">
                </div>
                <div class="form-group">
                    <button type="button" class="submit-btn" onclick="addDesignItem()">Add Type to Session</button>
                </div>
            </form>

            <h3>Current Items</h3>
            <ul id="designItemsList" style="list-style:none;padding-left:0;"></ul>

            <div id="morePrompt" style="display:none;margin-top:1rem;">
                <p>Would you like to add any more type?</p>
                <button class="submit-btn" style="margin-right:1rem;" onclick="addAnother()">Yes, add another</button>
                <button class="submit-btn" onclick="finalizeDesignSession()">No, finalize session</button>
            </div>
        </div>

        <!-- Sessions Tab -->
        <div id="sessions" class="tab-content">
            <h1>Upcoming Sessions</h1>
            <ul class="session-list" id="sessionsList"></ul>
        </div>

        <!-- Match Tab -->
        <div id="match" class="tab-content">
            <h1>Match Records</h1>
            <form id="matchForm" onsubmit="return false;">
                <div class="form-group">
                    <label for="matchDate">Date:</label>
                    <input type="date" id="matchDate">
                </div>
                <div class="form-group">
                    <label for="opponentName">Opponent Name:</label>
                    <input type="text" id="opponentName" placeholder="Enter opponent's name">
                </div>
                <div class="form-group">
                    <label for="matchScore">Score (e.g., 6-4, 3-6, 7-5):</label>
                    <input type="text" id="matchScore" placeholder="Enter your score">
                </div>
                <div class="form-group">
                    <label for="matchResult">Result:</label>
                    <select id="matchResult">
                        <option value="">Select result...</option>
                        <option value="Win">Win</option>
                        <option value="Loss">Loss</option>
                        <option value="Draw">Draw</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="button" class="submit-btn" id="matchSaveBtn" onclick="saveMatchRecord()">Save Match Record</button>
                    <button type="button" class="submit-btn btn-muted btn-sm" id="matchCancelEditBtn" style="display:none;margin-left:0.5rem;" onclick="cancelMatchEdit()">Cancel</button>
                </div>
            </form>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <h1>Training History</h1>
            <div class="filter-bar">
                <input type="text" id="historySearchInput" placeholder="Search history..." oninput="applyHistoryFilters()">
                <input type="date" id="historyDateFilter" onchange="applyHistoryFilters()">
                <select id="historyTypeFilter" onchange="applyHistoryFilters()">
                    <option value="all">All Types</option>
                    <option value="sessions">Sessions</option>
                    <option value="matches">Matches</option>
                </select>
            </div>
            
            <!-- Training Sessions Section -->
            <div style="margin-bottom:2rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h3 style="color:#0f2540;margin:0;">Training Sessions</h3>
                    <button class="submit-btn" style="background:#ef4444;padding:0.5rem 1rem;font-size:0.9rem;" onclick="clearTrainingHistory()">Clear History</button>
                </div>
                <ul class="session-list" id="historyList"></ul>
            </div>
            
            <!-- Match Records Section -->
            <div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h3 style="color:#0f2540;margin:0;">Match Records</h3>
                    <button class="submit-btn" style="background:#ef4444;padding:0.5rem 1rem;font-size:0.9rem;" onclick="clearMatchHistory()">Clear History</button>
                </div>
                <ul class="session-list" id="matchHistoryList"></ul>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div id="calendar" class="tab-content">
            <h1>Calendar</h1>
            <div style="display:flex;gap:1rem;margin-bottom:1rem;">
                <select id="calMonth"></select>
                <select id="calYear"></select>
            </div>
            <div id="calendarGrid"></div>
        </div>

        <!-- Journal Tab -->
        <div id="journal" class="tab-content">
            <h1>Journal Entries</h1>
            <div class="filter-bar">
                <input type="text" id="journalSearchInput" placeholder="Search journals..." oninput="applyJournalFilters()">
                <input type="date" id="journalDateFilter" onchange="applyJournalFilters()">
                <select id="journalTypeFilter" onchange="applyJournalFilters()">
                    <option value="all">All Types</option>
                    <option value="session">Session</option>
                    <option value="match">Match</option>
                </select>
            </div>
            <ul id="journalList" class="session-list"></ul>
        </div>
    </div>
    </div>

<!-- Session Execution Modal Overlay -->
    <div id="sessionModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;">
        <div class="session-modal-box">
            <!-- Back Button -->
            <button id="modalBackBtn" style="background:transparent;border:none;color:var(--accent);font-weight:700;cursor:pointer;font-size:1rem;padding:0.5rem 0;margin-bottom:1.5rem;" onclick="closeSessionModal()">‚Üê Back</button>
            
            <!-- Session Header -->
            <div id="modalSessionHeader" style="margin-bottom:2rem;">
                <p id="modalSessionDate" style="color:var(--muted);font-size:0.9rem;margin-bottom:0.5rem;"></p>
                <h2 id="modalSessionTitle" style="font-size:1.4rem;color:#0f2540;margin:0;"></h2>
            </div>
            
            <!-- Items Checklist -->
            <ul id="modalItemsList" style="list-style:none;padding:0;margin:0 0 2rem 0;"></ul>
            
            <!-- Finish Session Button -->
            <button id="finishSessionBtn" style="width:100%;background:var(--accent);color:white;padding:1rem;border-radius:10px;border:none;font-weight:700;font-size:1rem;cursor:pointer;box-shadow:0 8px 20px rgba(26,188,156,0.12);transition:transform .12s ease,box-shadow .12s ease;margin-top:1rem;" onclick="finishSession()">
                Finish Session
            </button>
        </div>
    </div>

    <div id="mobilityTemplateBuilderModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(20,28,38,0.45);backdrop-filter:blur(8px);z-index:108;align-items:center;justify-content:center;">
        <div class="journal-modal-box" style="max-width:720px;">
            <h2 id="mobilityTemplateModalTitle">Create Template</h2>
            <div class="form-group">
                <label for="mobilityTemplateName">Template Name</label>
                <input type="text" id="mobilityTemplateName" placeholder="Enter template name">
            </div>
            <h3 style="margin:0.2rem 0 0.4rem 0;">Exercise Builder</h3>
            <div class="form-group">
                <label for="mobilityTemplateExerciseName">Exercise Name</label>
                <input type="text" id="mobilityTemplateExerciseName" placeholder="Enter exercise name">
            </div>
            <div class="form-group">
                <label for="mobilityTemplateExerciseInstructions">Instructions</label>
                <textarea id="mobilityTemplateExerciseInstructions" placeholder="Enter exercise instructions"></textarea>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.8rem;">
                <div class="form-group">
                    <label for="mobilityTemplateExerciseSets">Sets</label>
                    <input type="number" id="mobilityTemplateExerciseSets" min="1" placeholder="e.g., 3">
                </div>
                <div class="form-group">
                    <label for="mobilityTemplateExerciseReps">Reps</label>
                    <input type="number" id="mobilityTemplateExerciseReps" min="1" placeholder="e.g., 10">
                </div>
            </div>
            <div class="form-group" style="margin-top:0.1rem;">
                <button class="submit-btn btn-secondary" onclick="addMobilityTemplateExercise()">Add Exercise</button>
            </div>
            <ul id="mobilityTemplateExercisesList" style="list-style:none;padding-left:0;margin-top:0.35rem;"></ul>
            <div class="modal-actions">
                <button class="submit-btn" onclick="saveMobilityTemplateFromModal()">Save Template</button>
                <button class="submit-btn btn-muted" onclick="closeMobilityTemplateBuilder()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="mobilityDesignSessionModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(20,28,38,0.45);backdrop-filter:blur(8px);z-index:109;align-items:center;justify-content:center;">
        <div class="journal-modal-box" style="max-width:560px;">
            <h2>Design Session</h2>
            <div class="form-group">
                <label for="mobilityDesignSessionDate">Date</label>
                <input type="date" id="mobilityDesignSessionDate">
            </div>
            <div class="form-group">
                <label for="mobilityDesignTemplateSelect">Template</label>
                <select id="mobilityDesignTemplateSelect">
                    <option value="">Select template...</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="submit-btn" onclick="createMobilitySessionFromDesign()">Create Session</button>
                <button class="submit-btn btn-muted" onclick="closeMobilityDesignSessionModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="mobilitySessionModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1010;overflow-y:auto;">
        <div class="session-modal-box">
            <button style="background:transparent;border:none;color:var(--accent);font-weight:700;cursor:pointer;font-size:1rem;padding:0.5rem 0;margin-bottom:1.5rem;" onclick="closeMobilitySessionModal()">‚Üê Back</button>
            <div style="margin-bottom:2rem;">
                <p id="mobilityModalSessionDate" style="color:var(--muted);font-size:0.9rem;margin-bottom:0.5rem;"></p>
                <p id="mobilityModalTemplateName" style="color:var(--muted);font-size:0.9rem;margin-bottom:0.5rem;"></p>
                <h2 style="font-size:1.4rem;color:#0f2540;margin:0;">Mobility Session</h2>
            </div>
            <ul id="mobilityModalItemsList" style="list-style:none;padding:0;margin:0 0 2rem 0;"></ul>
            <button style="width:100%;background:var(--accent);color:white;padding:1rem;border-radius:10px;border:none;font-weight:700;font-size:1rem;cursor:pointer;box-shadow:0 8px 20px rgba(26,188,156,0.12);margin-top:1rem;" onclick="finishMobilitySession()">
                Finish Session
            </button>
        </div>
    </div>

    <div id="historyEditModal">
        <div class="history-edit-box">
            <h2>Edit Training Session</h2>
            <div class="form-group">
                <label for="historyEditDate">Date</label>
                <input type="date" id="historyEditDate">
            </div>
            <div class="modal-actions">
                <button class="submit-btn" onclick="saveHistoryEdit()">Save</button>
                <button class="submit-btn btn-muted" onclick="closeHistoryEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="calendarDetailModal">
        <div class="calendar-detail-box">
            <h2 id="calendarDetailTitle">Date</h2>
            <div id="calendarDetailContent"></div>
            <div class="modal-actions">
                <button class="submit-btn btn-muted" onclick="closeCalendarDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tabName, el) {
            const contents = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');

            contents.forEach(content => content.classList.remove('active'));
            buttons.forEach(button => button.classList.remove('active'));

            const target = document.getElementById(tabName);
            if (target) target.classList.add('active');

            // Initialize calendar when calendar tab is opened
            if (tabName === 'calendar') {
                setTimeout(() => {
                    initCalendar();
                }, 50);
            }

            // Render journal list when journal tab is opened
            if (tabName === 'journal') {
                setTimeout(async () => {
                    await window.firebaseRenderJournalList();
                }, 50);
            }

            if (tabName === 'mobilitySessions') {
                setTimeout(async () => {
                    if (window.firebaseRenderMobilitySessions) await window.firebaseRenderMobilitySessions();
                }, 50);
            }

            if (tabName === 'mobilityTemplates') {
                setTimeout(async () => {
                    if (window.firebaseRenderMobilityTemplates) await window.firebaseRenderMobilityTemplates();
                }, 50);
            }

            if (tabName === 'mobilityCalendar') {
                setTimeout(() => {
                    if (window.initMobilityCalendar) window.initMobilityCalendar();
                }, 50);
            }

            if (tabName === 'actuaryNotes') {
                setTimeout(() => {
                    if (window.initializeActuariesUI) window.initializeActuariesUI();
                    if (window.showActuaryModules) window.showActuaryModules();
                }, 50);
            }

            if (tabName === 'actuaryLearn') {
                setTimeout(() => {
                    if (window.loadLearnQuestions) window.loadLearnQuestions();
                }, 50);
            }

            // If an element was provided (nav button or inline button), mark it active
            if (el) {
                el.classList.add('active');
                // If the element is a nav button with data-tab, nothing else to do
                return;
            }

            // Otherwise try to find a nav button that matches the tabName and mark it active
            const navBtn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.dataset.tab === tabName);
            if (navBtn) navBtn.classList.add('active');
        }

        let designItems = [];
        let editingSessionIndex = null;
        let sessionDataMap = {}; // Map to store session data by ID
        let mobilityTemplateExercises = [];
        let mobilityTemplateEditingId = null;
        let mobilitySessionDataMap = {};
        let mobilityTemplatesCache = [];
        let currentMobilitySessionData = null;
        let currentMobilitySessionId = null;
        let mobilitySessionCheckedItems = {};

        // Make these globally accessible
        window.designItems = designItems;
        window.editingSessionIndex = editingSessionIndex;
        window.sessionDataMap = sessionDataMap;
        window.mobilityTemplateExercises = mobilityTemplateExercises;
        window.mobilityTemplateEditingId = mobilityTemplateEditingId;
        window.mobilitySessionDataMap = mobilitySessionDataMap;
        window.mobilityTemplatesCache = mobilityTemplatesCache;

        function onDesignTypeChange() {
            const type = document.getElementById('designType').value;
            const exerciseGroup = document.getElementById('exerciseGroup');
            const durationGroup = document.getElementById('durationGroup');
            const exerciseLabel = document.getElementById('exerciseLabel');
            if (!type) {
                exerciseGroup.style.display = 'none';
                durationGroup.style.display = 'none';
                return;
            }
            exerciseGroup.style.display = 'block';
            durationGroup.style.display = 'block';
            if (type === 'Conditioning') exerciseLabel.textContent = 'Conditioning Exercise:';
            else if (type === 'Tennis Drills') exerciseLabel.textContent = 'Drill:';
            else if (type === 'Rallies') exerciseLabel.textContent = 'Rally Type:';
            else if (type === 'Match Points') exerciseLabel.textContent = 'Point Drill:';
        }

        function addDesignItem() {
            const type = document.getElementById('designType').value;
            const exercise = document.getElementById('designExercise').value.trim();
            const minutes = parseInt(document.getElementById('designDuration').value, 10);
            if (!type) { alert('Please select a type'); return; }
            if (!exercise) { alert('Please enter the exercise/drill name'); return; }
            if (!minutes || minutes <= 0) { alert('Please enter a valid time in minutes'); return; }
            window.designItems.push({type, exercise, minutes});
            renderDesignItems();
            document.getElementById('morePrompt').style.display = 'block';
        }

        function renderDesignItems() {
            const list = document.getElementById('designItemsList');
            if (!list) return;
            if (window.designItems.length === 0) {
                list.innerHTML = '<li style="color:#666">No items yet</li>';
                return;
            }
            list.innerHTML = window.designItems.map((it,i) => `\n                <li style="margin-bottom:0.5rem;">\n                  <strong>${it.type}</strong> ‚Äî ${it.exercise} ‚Äî ${it.minutes} min\n                  <button style="margin-left:0.75rem;" onclick="removeDesignItem(${i})">Remove</button>\n                </li>`).join('');
        }

        function removeDesignItem(index) {
            window.designItems.splice(index,1);
            renderDesignItems();
            if (window.designItems.length === 0) document.getElementById('morePrompt').style.display = 'none';
        }

        function addAnother() {
            document.getElementById('designExercise').value = '';
            document.getElementById('designDuration').value = '';
            document.getElementById('morePrompt').style.display = 'none';
            document.getElementById('designExercise').focus();
        }

        function finalizeDesignSession() {
            // This will be defined in the module script
            window.firebaseFinalizeDesignSession();
        }

        async function openMobilityTemplateBuilder(templateId = null) {
            const modal = document.getElementById('mobilityTemplateBuilderModal');
            const title = document.getElementById('mobilityTemplateModalTitle');
            const templateNameEl = document.getElementById('mobilityTemplateName');
            if (!modal || !templateNameEl) return;

            window.mobilityTemplateEditingId = templateId;
            const existingTemplate = templateId
                ? (window.mobilityTemplatesCache || []).find(t => t.id === templateId)
                : null;

            if (title) title.textContent = existingTemplate ? 'Edit Template' : 'Create Template';
            templateNameEl.value = existingTemplate?.name || '';
            window.mobilityTemplateExercises = (existingTemplate?.exercises || []).map(exercise => ({
                name: exercise.name || '',
                instructions: exercise.instructions || '',
                sets: Number(exercise.sets) || 1,
                reps: Number(exercise.reps) || 1
            }));

            const nameInput = document.getElementById('mobilityTemplateExerciseName');
            const instructionsInput = document.getElementById('mobilityTemplateExerciseInstructions');
            const setsInput = document.getElementById('mobilityTemplateExerciseSets');
            const repsInput = document.getElementById('mobilityTemplateExerciseReps');
            if (nameInput) nameInput.value = '';
            if (instructionsInput) instructionsInput.value = '';
            if (setsInput) setsInput.value = '';
            if (repsInput) repsInput.value = '';

            renderMobilityTemplateExercises();
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeMobilityTemplateBuilder() {
            const modal = document.getElementById('mobilityTemplateBuilderModal');
            if (modal) modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            window.mobilityTemplateEditingId = null;
            window.mobilityTemplateExercises = [];
        }

        function addMobilityTemplateExercise() {
            const name = document.getElementById('mobilityTemplateExerciseName')?.value.trim() || '';
            const instructions = document.getElementById('mobilityTemplateExerciseInstructions')?.value.trim() || '';
            const sets = parseInt(document.getElementById('mobilityTemplateExerciseSets')?.value || '0', 10);
            const reps = parseInt(document.getElementById('mobilityTemplateExerciseReps')?.value || '0', 10);

            if (!name || !instructions || !sets || !reps || sets <= 0 || reps <= 0) {
                alert('Please fill Exercise Name, Instructions, Sets, and Reps with valid values.');
                return;
            }

            window.mobilityTemplateExercises.push({ name, instructions, sets, reps });
            renderMobilityTemplateExercises();

            document.getElementById('mobilityTemplateExerciseName').value = '';
            document.getElementById('mobilityTemplateExerciseInstructions').value = '';
            document.getElementById('mobilityTemplateExerciseSets').value = '';
            document.getElementById('mobilityTemplateExerciseReps').value = '';
        }

        function removeMobilityTemplateExercise(index) {
            window.mobilityTemplateExercises.splice(index, 1);
            renderMobilityTemplateExercises();
        }

        function renderMobilityTemplateExercises() {
            const listEl = document.getElementById('mobilityTemplateExercisesList');
            if (!listEl) return;

            if (!window.mobilityTemplateExercises || window.mobilityTemplateExercises.length === 0) {
                listEl.innerHTML = '<li style="color:#666;padding:0.5rem 0;">No exercises added yet.</li>';
                return;
            }

            listEl.innerHTML = window.mobilityTemplateExercises.map((exercise, index) => `
                <li style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.7rem;padding:0.65rem 0.8rem;border:1px solid #eef4f8;border-radius:8px;margin-bottom:0.55rem;background:linear-gradient(180deg,#fbfdff,#ffffff);">
                    <div>
                        <div style="font-weight:600;color:#0f2540;">${exercise.name}</div>
                        <div style="font-size:0.9rem;color:var(--muted);">Sets: ${exercise.sets} | Reps: ${exercise.reps}</div>
                    </div>
                    <button class="submit-btn btn-danger btn-sm" onclick="removeMobilityTemplateExercise(${index})">Remove</button>
                </li>
            `).join('');
        }

        async function saveMobilityTemplateFromModal() {
            const name = document.getElementById('mobilityTemplateName')?.value.trim() || '';
            if (!name) {
                alert('Template Name is required.');
                return;
            }
            if (!window.mobilityTemplateExercises || window.mobilityTemplateExercises.length === 0) {
                alert('Please add at least one exercise.');
                return;
            }

            const payload = {
                name,
                exercises: window.mobilityTemplateExercises.map(exercise => ({
                    name: exercise.name,
                    instructions: exercise.instructions,
                    sets: exercise.sets,
                    reps: exercise.reps
                }))
            };

            if (window.mobilityTemplateEditingId) {
                await window.firebaseUpdateMobilityTemplate(window.mobilityTemplateEditingId, payload);
            } else {
                await window.firebaseAddMobilityTemplate(payload);
            }

            closeMobilityTemplateBuilder();
            if (window.firebaseRenderMobilityTemplates) await window.firebaseRenderMobilityTemplates();
        }

        async function populateMobilityDesignTemplateSelect(selectedTemplateId = '') {
            const selectEl = document.getElementById('mobilityDesignTemplateSelect');
            if (!selectEl) return;

            let templates = window.mobilityTemplatesCache || [];
            if (!templates.length && window.firebaseGetMobilityTemplates) {
                templates = await window.firebaseGetMobilityTemplates();
                window.mobilityTemplatesCache = templates;
            }

            selectEl.innerHTML = '<option value="">Select template...</option>';
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name || 'Untitled Template';
                selectEl.appendChild(option);
            });

            if (selectedTemplateId) {
                selectEl.value = selectedTemplateId;
            }
        }

        async function openMobilityDesignSessionModal(templateId = '') {
            const modal = document.getElementById('mobilityDesignSessionModal');
            const dateEl = document.getElementById('mobilityDesignSessionDate');
            if (!modal || !dateEl) return;

            await populateMobilityDesignTemplateSelect(templateId);
            dateEl.value = new Date().toISOString().split('T')[0];
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeMobilityDesignSessionModal() {
            const modal = document.getElementById('mobilityDesignSessionModal');
            if (modal) modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function createMobilitySessionFromDesign() {
            const date = document.getElementById('mobilityDesignSessionDate')?.value || '';
            const templateId = document.getElementById('mobilityDesignTemplateSelect')?.value || '';

            if (!date) return alert('Please select a date.');
            if (!templateId) return alert('Please select a template.');

            await window.firebaseCreateMobilitySession(templateId, date);
            closeMobilityDesignSessionModal();
            const btn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.dataset.tab === 'mobilitySessions');
            switchTab('mobilitySessions', btn || null);
        }

        function openMobilitySessionExecution(sessionData, sessionId = null) {
            if (!sessionData) {
                alert('Mobility session data not found');
                return;
            }

            currentMobilitySessionId = sessionId;
            currentMobilitySessionData = sessionData;
            mobilitySessionCheckedItems = {};

            const dateEl = document.getElementById('mobilityModalSessionDate');
            const listEl = document.getElementById('mobilityModalItemsList');
            const modal = document.getElementById('mobilitySessionModal');

            if (!dateEl || !listEl || !modal) return;

            const templateEl = document.getElementById('mobilityModalTemplateName');
            dateEl.textContent = sessionData.date || '';
            if (templateEl) templateEl.textContent = sessionData.templateName || '';
            listEl.innerHTML = (sessionData.exercises || []).map((item, idx) => `
                <li id="mobility-item-${idx}" style="display:flex;align-items:flex-start;gap:0.85rem;padding:0.95rem;border-radius:10px;background:linear-gradient(180deg,#fbfdff,#ffffff);border:1px solid #eef4f8;margin-bottom:0.8rem;">
                    <input type="checkbox" style="width:20px;height:20px;margin-top:0.1rem;" onchange="toggleMobilityItemCheck(${idx})">
                    <div>
                        <div style="font-weight:600;color:#0f2540;">${item.name}</div>
                        <div style="font-size:0.92rem;color:var(--muted);">Sets: ${item.sets} | Reps: ${item.reps}</div>
                        <div style="font-size:0.85rem;color:var(--muted);margin-top:0.25rem;">${item.instructions || 'No instructions added.'}</div>
                    </div>
                </li>
            `).join('');

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function startMobilitySession(sessionId) {
            const sessionData = window.mobilitySessionDataMap[sessionId];
            openMobilitySessionExecution(sessionData, sessionId);
        }

        function editMobilitySessionDate(sessionId) {
            const session = window.mobilitySessionDataMap[sessionId];
            if (!session) return;

            const nextDate = prompt('Update session date (YYYY-MM-DD):', session.date || '');
            if (nextDate === null) return;
            const trimmedDate = nextDate.trim();
            if (!trimmedDate) {
                alert('Date is required.');
                return;
            }

            window.firebaseUpdateMobilitySession(sessionId, { date: trimmedDate });
        }

        function toggleMobilityItemCheck(index) {
            const itemEl = document.getElementById(`mobility-item-${index}`);
            const checkbox = itemEl?.querySelector('input[type="checkbox"]');
            if (!itemEl || !checkbox) return;

            if (checkbox.checked) {
                mobilitySessionCheckedItems[index] = true;
                itemEl.style.opacity = '0.65';
                itemEl.style.background = 'rgba(26, 188, 156, 0.15)';
            } else {
                delete mobilitySessionCheckedItems[index];
                itemEl.style.opacity = '1';
                itemEl.style.background = 'linear-gradient(180deg,#fbfdff,#ffffff)';
            }
        }

        function closeMobilitySessionModal() {
            const modal = document.getElementById('mobilitySessionModal');
            if (modal) modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            currentMobilitySessionData = null;
            currentMobilitySessionId = null;
            mobilitySessionCheckedItems = {};
        }

        async function finishMobilitySession() {
            if (!currentMobilitySessionData) {
                alert('No mobility session loaded');
                return;
            }

            const totalCount = (currentMobilitySessionData.exercises || []).length;
            const completedCount = Object.keys(mobilitySessionCheckedItems).length;

            if (completedCount < totalCount) {
                if (!confirm(`You still have ${totalCount - completedCount} unfinished item(s). Finish anyway?`)) {
                    return;
                }
            }

            if (currentMobilitySessionId) {
                await window.firebaseUpdateMobilitySession(currentMobilitySessionId, { status: 'completed' });
            }
            closeMobilitySessionModal();
            if (window.firebaseRenderMobilitySessions) await window.firebaseRenderMobilitySessions();
            if (window.initMobilityCalendar) window.initMobilityCalendar();
        }

        function renderSessionsList() {
            // This will be defined in the module script
            window.firebaseRenderSessionsList();
        }

        function editSession(docId) {
            // This will be defined in the module script
            window.firebaseEditSession(docId);
        }

        function deleteSession(docId) {
            // This will be defined in the module script
            window.firebaseDeleteSession(docId);
        }

        function planSession() {
            const name = document.getElementById('sessionName').value;
            const date = document.getElementById('sessionDate').value;
            const duration = document.getElementById('sessionDuration').value;
            const type = document.getElementById('sessionType').value;
            
            if (!name || !date || !duration) {
                alert('Please fill in all required fields');
                return;
            }
            
            alert(`Session "${name}" planned for ${date}!`);
            document.querySelector('form').reset();
        }

        // Session Modal Functions
        let currentSessionData = null;
        let currentSessionId = null; // Store the session ID for deletion
        let sessionCheckedItems = {};

        function startSessionById(sessionId) {
            const sessionData = window.sessionDataMap[sessionId];
            if (!sessionData) {
                alert('Session data not found');
                return;
            }
            currentSessionId = sessionId; // Store the ID
            openSessionModal(sessionData);
        }

        function openSessionModal(sessionData) {
            currentSessionData = sessionData;
            sessionCheckedItems = {};

            // Populate header
            document.getElementById('modalSessionDate').textContent = sessionData.date;
            document.getElementById('modalSessionTitle').textContent = 'Session Checklist';

            // Render items
            const list = document.getElementById('modalItemsList');
            list.innerHTML = sessionData.items.map((item, idx) => `
                <li id="item-${idx}">
                    <input type="checkbox" onchange="toggleItemCheck(${idx})">
                    <span class="item-text">${item.type} ‚Äî ${item.exercise} ‚Äî ${item.minutes} min</span>
                </li>
            `).join('');

            // Show modal
            document.getElementById('sessionModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeSessionModal() {
            document.getElementById('sessionModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentSessionData = null;
            currentSessionId = null; // Clear the ID
            sessionCheckedItems = {};
        }

        function toggleItemCheck(index) {
            const checkbox = document.querySelector(`#item-${index} input[type="checkbox"]`);
            const item = document.getElementById(`item-${index}`);

            if (checkbox.checked) {
                sessionCheckedItems[index] = true;
                item.classList.add('checked');
            } else {
                delete sessionCheckedItems[index];
                item.classList.remove('checked');
            }
        }

        function finishSession() {
            if (!currentSessionData) {
                alert('No session data loaded');
                return;
            }
            const totalItems = currentSessionData.items.length;
            const checkedCount = Object.keys(sessionCheckedItems).length;

            if (checkedCount < totalItems) {
                // Show confirm dialog
                const confirmText = `You have ${totalItems - checkedCount} unfinished item(s). Finish anyway?`;
                if (!confirm(confirmText)) {
                    return;
                }
            }

            // Save to history collection
            window.firebaseSaveSessionToHistory(currentSessionData, checkedCount, totalItems, currentSessionId);
        }

        async function saveMatchRecord() {
            const date = document.getElementById('matchDate').value;
            const opponent = document.getElementById('opponentName').value.trim();
            const score = document.getElementById('matchScore').value.trim();
            const result = document.getElementById('matchResult').value;

            if (!date) { alert('Please select a match date'); return; }
            if (!opponent) { alert('Please enter opponent name'); return; }
            if (!score) { alert('Please enter the score'); return; }
            if (!result) { alert('Please select the match result'); return; }

            if (currentMatchEditId) {
                await window.firebaseUpdateMatchRecord(currentMatchEditId, {
                    date,
                    opponent,
                    score,
                    result
                });
                currentMatchEditId = null;
                document.getElementById('matchForm').reset();
                setMatchEditMode(false);
            } else {
                window.firebaseSaveMatchRecord({
                    date,
                    opponent,
                    score,
                    result
                });
            }
        }

        function setMatchEditMode(isEditing) {
            const saveBtn = document.getElementById('matchSaveBtn');
            const cancelBtn = document.getElementById('matchCancelEditBtn');
            if (!saveBtn || !cancelBtn) return;
            if (isEditing) {
                saveBtn.textContent = 'Update Match Record';
                cancelBtn.style.display = 'inline-block';
            } else {
                saveBtn.textContent = 'Save Match Record';
                cancelBtn.style.display = 'none';
            }
        }

        function cancelMatchEdit() {
            currentMatchEditId = null;
            document.getElementById('matchForm').reset();
            setMatchEditMode(false);
        }

        function clearTrainingHistory() {
            if (!confirm('Are you sure you want to clear all training session history? This action cannot be undone.')) {
                return;
            }
            window.firebaseClearTrainingHistory();
        }

        function clearMatchHistory() {
            if (!confirm('Are you sure you want to clear all match records? This action cannot be undone.')) {
                return;
            }
            window.firebaseClearMatchHistory();
        }

        function applyHistoryFilters() {
            if (window.firebaseRenderHistoryList) window.firebaseRenderHistoryList();
            if (window.firebaseRenderMatchHistory) window.firebaseRenderMatchHistory();
        }

        function applyJournalFilters() {
            if (window.firebaseRenderJournalList) window.firebaseRenderJournalList();
        }

        // Authentication Functions
        let currentUserId = null;
        let currentUsername = null;
        let currentModule = null;
        let currentMatchEditId = null;
        let currentHistoryEditId = null;

        function handleSignIn() {
            const email = document.getElementById('signInEmail').value.trim();
            const password = document.getElementById('signInPassword').value.trim();

            if (!email) { alert('Please enter email'); return; }
            if (!password) { alert('Please enter password'); return; }

            window.firebaseSignIn(email, password);
        }

        function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            window.firebaseLogout();
        }

        function selectModule(moduleName) {
            currentModule = moduleName;
            showApp();
            
            // Update navbar and home tab for module
            updateNavbarForModule(moduleName);
            updateHomeForModule(moduleName);
            
            // Switch to home tab
            const defaultHomeTab = moduleName === 'Mobility - Physio' ? 'mobilityHome' : 'home';
            const homeBtn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.dataset.tab === defaultHomeTab);
            if (homeBtn) switchTab(defaultHomeTab, homeBtn);
            
            if (currentModule === 'Tennis') {
                // Load Tennis module data
                hideModulePlaceholder();
                enableTennisTabs();
                setTimeout(async () => {
                    await fetchJournalsForUser();
                    renderSessionsList();
                    window.firebaseRenderHistoryList();
                    window.firebaseRenderMatchHistory();
                    await window.firebaseRenderJournalList();
                    initCalendar();
                }, 100);
            } else if (currentModule === 'Actuaries') {
                hideModulePlaceholder();
                setTimeout(() => {
                    if (window.initializeActuariesUI) window.initializeActuariesUI();
                    if (window.showActuaryModules) window.showActuaryModules();
                    const btn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.dataset.tab === 'actuaryNotes');
                    switchTab('actuaryNotes', btn || null);
                }, 100);
            } else if (currentModule === 'Mobility - Physio') {
                hideModulePlaceholder();
                setTimeout(async () => {
                    if (window.firebaseRenderMobilitySessions) await window.firebaseRenderMobilitySessions();
                    if (window.firebaseRenderMobilityTemplates) await window.firebaseRenderMobilityTemplates();
                    if (window.initMobilityCalendar) window.initMobilityCalendar();
                }, 100);
            } else {
                // Show placeholder for other modules
                showModulePlaceholder(moduleName);
                disableTennisTabs();
            }
        }

        function updateNavbarForModule(moduleName) {
            const tennisTabs = ['home', 'sessions', 'match', 'history', 'calendar', 'journal'];
            const actuaryTabs = ['actuaryNotes', 'actuaryLearn'];
            const mobilityTabs = ['mobilityHome', 'mobilitySessions', 'mobilityTemplates', 'mobilityCalendar'];
            const tabButtons = document.querySelectorAll('.tab-button');
            
            tabButtons.forEach(button => {
                const tabName = button.dataset.tab;
                
                if (moduleName === 'Tennis') {
                    // Show all tabs for Tennis module
                    if (tennisTabs.includes(tabName) || tabName === 'dashboard') {
                        button.style.display = 'inline-flex';
                    }
                    if (actuaryTabs.includes(tabName)) {
                        button.style.display = 'none';
                    }
                    if (mobilityTabs.includes(tabName)) {
                        button.style.display = 'none';
                    }
                } else if (moduleName === 'Actuaries') {
                    if (actuaryTabs.includes(tabName) || tabName === 'dashboard') {
                        button.style.display = 'inline-flex';
                    }
                    if (tennisTabs.includes(tabName)) {
                        button.style.display = 'none';
                    }
                    if (mobilityTabs.includes(tabName)) {
                        button.style.display = 'none';
                    }
                } else if (moduleName === 'Mobility - Physio') {
                    if (mobilityTabs.includes(tabName) || tabName === 'dashboard') {
                        button.style.display = 'inline-flex';
                    }
                    if (tennisTabs.includes(tabName) || actuaryTabs.includes(tabName)) {
                        button.style.display = 'none';
                    }
                } else {
                    // For other modules: hide Tennis tabs, keep dashboard
                    if (tennisTabs.includes(tabName)) {
                        button.style.display = 'none';
                    } else if (actuaryTabs.includes(tabName)) {
                        button.style.display = 'none';
                    } else if (mobilityTabs.includes(tabName)) {
                        button.style.display = 'none';
                    } else if (tabName === 'dashboard') {
                        button.style.display = 'inline-flex';
                    }
                }
            });
        }

        function updateHomeForModule(moduleName) {
            const tennisSection = document.getElementById('tennisHomeSection');
            const moduleSection = document.getElementById('moduleHomeSection');
            const moduleNameEl = document.getElementById('moduleHomeName');
            
            if (moduleName === 'Tennis') {
                // Show Tennis content, hide generic module content
                if (tennisSection) tennisSection.style.display = 'block';
                if (moduleSection) moduleSection.style.display = 'none';
            } else if (moduleName === 'Actuaries') {
                if (tennisSection) tennisSection.style.display = 'none';
                if (moduleSection) moduleSection.style.display = 'none';
            } else if (moduleName === 'Mobility - Physio') {
                if (tennisSection) tennisSection.style.display = 'none';
                if (moduleSection) moduleSection.style.display = 'none';
            } else {
                // Hide Tennis content, show generic module content
                if (tennisSection) tennisSection.style.display = 'none';
                if (moduleSection) moduleSection.style.display = 'block';
                // Update module name with proper formatting
                if (moduleNameEl) {
                    const displayName = moduleName.replace(/_/g, ' ');
                    moduleNameEl.textContent = displayName;
                }
            }
        }

        function showModulePlaceholder(moduleName) {
            const homeContent = document.getElementById('home');
            if (!homeContent) return;
            
            const placeholderId = 'modulePlaceholder';
            let placeholder = document.getElementById(placeholderId);
            
            if (!placeholder) {
                placeholder = document.createElement('div');
                placeholder.id = placeholderId;
                placeholder.style.cssText = 'text-align: center; padding: 3rem 1rem; min-height: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center;';
                homeContent.appendChild(placeholder);
            }
            
            const displayName = moduleName.replace(/_/g, ' ');
            placeholder.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1.5rem;">üîÑ</div>
                <h2 style="color: #0f2540; font-size: 1.8rem; margin: 0 0 0.5rem 0;">${displayName}</h2>
                <p style="color: #999; font-size: 1.1rem; margin: 0;">This module is under development</p>
            `;
            placeholder.style.display = 'block';
        }

        function hideModulePlaceholder() {
            const placeholder = document.getElementById('modulePlaceholder');
            if (placeholder) placeholder.style.display = 'none';
        }

        function enableTennisTabs() {
            const tabs = document.querySelectorAll('[data-tab]');
            tabs.forEach(tab => {
                tab.style.opacity = '1';
                tab.style.pointerEvents = 'auto';
            });
        }

        function disableTennisTabs() {
            const tabs = document.querySelectorAll('[data-tab]');
            const disabledTabs = ['design', 'sessions', 'match', 'history', 'calendar', 'journal'];
            tabs.forEach(tab => {
                if (disabledTabs.includes(tab.dataset.tab)) {
                    tab.style.opacity = '0.5';
                    tab.style.pointerEvents = 'none';
                }
            });
        }

        function showDashboard() {
            document.getElementById('dashboard').style.display = 'flex';
            document.getElementById('dashboardHeader').style.display = 'flex';
            document.getElementById('dashboardUserEmail').textContent = currentUsername || 'user@example.com';
            document.getElementById('navbar').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'none';
            currentModule = null;
        }

        function showApp() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('dashboardHeader').style.display = 'none';
            document.getElementById('navbar').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function() {
            window.checkAuthState();
        });

    </script>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, where, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAJTqOvwqp8v5t4ev4q2jQoJU7YR5yYAsY",
    authDomain: "tennis-planner-7dd13.firebaseapp.com",
    projectId: "tennis-planner-7dd13",
    storageBucket: "tennis-planner-7dd13.firebasestorage.app",
    messagingSenderId: "912382977591",
    appId: "1:912382977591:web:62110a00fff74b263101b2",
    measurementId: "G-RFV0PV3T43"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);

  // Initialize Firestore
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

window.db = db;
window.storage = storage;
window.addDoc = addDoc;
window.getDocs = getDocs;
window.collection = collection;
window.doc = doc;
window.getDoc = getDoc;
window.updateDoc = updateDoc;
window.deleteDoc = deleteDoc;
window.query = query;
window.where = where;
window.setDoc = setDoc;
window.orderBy = orderBy;
window.ref = ref;
window.uploadBytes = uploadBytes;
window.getDownloadURL = getDownloadURL;

// Authentication Functions
window.checkAuthState = function() {
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
            currentUsername = user.email;
            document.getElementById('currentUserDisplay').textContent = `üë§ ${currentUsername}`;
            
            // Hide login, show dashboard
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
            document.getElementById('dashboardHeader').style.display = 'flex';
            document.getElementById('dashboardUserEmail').textContent = currentUsername;
            document.getElementById('navbar').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'none';
            
        } else {
            // Show login, hide everything else
            currentUserId = null;
            currentUsername = null;
            currentModule = null;
            document.getElementById('currentUserDisplay').textContent = '';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('dashboardHeader').style.display = 'none';
            document.getElementById('navbar').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'none';
        }
    });
};

window.firebaseSignIn = async function(email, password) {
    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        currentUserId = user.uid;
        currentUsername = user.email;
        document.getElementById('currentUserDisplay').textContent = `üë§ ${currentUsername}`;
        
        // Hide login, show app
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('navbar').style.display = 'block';
        document.getElementById('mainContainer').style.display = 'block';
        
        document.getElementById('signInEmail').value = '';
        document.getElementById('signInPassword').value = '';
    } catch (error) {
        alert('Login failed: ' + error.message);
        console.error(error);
    }
};

window.firebaseLogout = async function() {
    try {
        await signOut(auth);
        
        currentUserId = null;
        currentUsername = null;
        document.getElementById('currentUserDisplay').textContent = '';
        
        // Show login, hide app and dashboard
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('dashboardHeader').style.display = 'none';
        document.getElementById('navbar').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'none';
    } catch (error) {
        alert('Logout failed: ' + error.message);
        console.error(error);
    }
};
window.query = query;
window.where = where;

// Firebase-dependent functions
window.firebaseFinalizeDesignSession = async function() {
    const date = document.getElementById('designDate').value;
    if (!date) { alert('Please select a date for the session'); return; }
    if (!window.designItems || window.designItems.length === 0) { alert('Please add at least one type/exercise'); return; }
    
    try {
        const sessionData = {
            date,
            items: (window.designItems || []).slice(),
            created: Date.now(),
            userId: currentUserId,
            module: currentModule
        };
        
        if (window.editingSessionIndex !== null) {
            // Update existing document - validate userId first
            const existingDoc = await getDoc(doc(db, 'sessions', window.editingSessionIndex));
            if (existingDoc.exists() && existingDoc.data().userId !== currentUserId) {
                alert('You do not have permission to edit this session!');
                return;
            }
            await updateDoc(doc(db, 'sessions', window.editingSessionIndex), sessionData);
        } else {
            // Create new document
            await addDoc(collection(db, 'sessions'), sessionData);
        }
        
        window.designItems = [];
        renderDesignItems();
        document.getElementById('designForm').reset();
        document.getElementById('morePrompt').style.display = 'none';
        await window.firebaseRenderSessionsList();
        const btn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.dataset.tab === 'sessions');
        window.editingSessionIndex = null;
        switchTab('sessions', btn || null);
    } catch (error) {
        alert('Error saving session: ' + error.message);
        console.error(error);
    }
};

window.firebaseRenderSessionsList = async function() {
    const listEl = document.getElementById('sessionsList');
    if (!listEl) return;

    const q = query(collection(db, "sessions"), where("userId", "==", currentUserId), where("module", "==", currentModule));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
        listEl.innerHTML = '<li>No sessions planned yet.</li>';
        return;
    }

    let html = "";

    snapshot.forEach(docSnap => {
        const s = docSnap.data();
        const id = docSnap.id;

        const items = (s.items || [])
            .map(it => `<div>${it.type}: ${it.exercise} ‚Äî ${it.minutes} min</div>`)
            .join('');

        // Store session data in map using document ID
        window.sessionDataMap[id] = {date: s.date, items: s.items};

        html += `
    <li>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${s.date}</strong>
        <div>
          <button onclick="window.startSessionById('${id}')" class="submit-btn" style="background:var(--accent);">Start Session</button>
          <button onclick="editSession('${id}')" class="submit-btn">Edit</button>
          <button onclick="deleteSession('${id}')" style="background:#ef4444;border:none;padding:.55rem .8rem;border-radius:8px;color:#fff;cursor:pointer">Delete</button>
        </div>
      </div>
      <div style="margin-top:0.5rem;">${items}</div>
    </li>
`;
    });

    listEl.innerHTML = html;
};

window.firebaseEditSession = async function(docId) {
    try {
        const docRef = doc(db, 'sessions', docId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return alert('Session not found');
        
        const s = docSnap.data();
        
        // Validate userId - prevent users from editing others' sessions
        if (s.userId !== currentUserId) {
            alert('You do not have permission to edit this session!');
            return;
        }
        
        document.getElementById('designDate').value = s.date;
        window.designItems = s.items.slice();
        window.editingSessionIndex = docId;
        renderDesignItems();
        const btn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.dataset.tab === 'design');
        switchTab('design', btn || null);
    } catch (error) {
        alert('Error loading session: ' + error.message);
        console.error(error);
    }
};

window.firebaseDeleteSession = async function(docId) {
    try {
        const docRef = doc(db, 'sessions', docId);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) {
            alert('Session not found!');
            return;
        }
        
        const s = docSnap.data();
        
        // Validate userId - prevent users from deleting others' sessions
        if (s.userId !== currentUserId) {
            alert('You do not have permission to delete this session!');
            return;
        }
        
        if (!confirm('Delete this planned session?')) return;
        
        await deleteDoc(doc(db, 'sessions', docId));
        await window.firebaseRenderSessionsList();
    } catch (error) {
        alert('Error deleting session: ' + error.message);
        console.error(error);
    }
};

window.firebaseSaveSessionToHistory = async function(sessionData, completedCount, totalItems, sessionId) {
    try {
        const historyData = {
            date: sessionData.date,
            items: sessionData.items,
            completedItemsCount: completedCount,
            totalItems: totalItems,
            finishedAtTimestamp: Date.now(),
            userId: currentUserId,
            module: currentModule
        };

        await addDoc(collection(db, 'history'), historyData);

        // Delete the session from sessions collection using the stored ID
        if (sessionId) {
            await deleteDoc(doc(db, 'sessions', sessionId));
        }

        alert('Session saved to history!');
        closeSessionModal();
        await window.firebaseRenderSessionsList(); // Refresh sessions list
        await window.firebaseRenderHistoryList(); // Refresh history list
    } catch (error) {
        alert('Error saving session: ' + error.message);
        console.error(error);
    }
};

window.firebaseAddMobilityTemplate = async function(data) {
    try {
        if (!currentUserId) return;
        const exercises = (data.exercises || []).map(exercise => ({
            name: exercise.name,
            instructions: exercise.instructions,
            sets: exercise.sets,
            reps: exercise.reps
        }));

        await addDoc(collection(db, 'mobilityTemplates'), {
            userId: currentUserId,
            name: data.name,
            exercises,
            createdAt: Date.now()
        });
    } catch (error) {
        alert('Error adding mobility template: ' + error.message);
        console.error(error);
    }
};

window.firebaseGetMobilityTemplates = async function() {
    if (!currentUserId) return [];

    const snapshot = await getDocs(query(
        collection(db, 'mobilityTemplates'),
        where('userId', '==', currentUserId)
    ));

    const templates = [];
    snapshot.forEach(docSnap => {
        templates.push({ id: docSnap.id, ...docSnap.data() });
    });

    templates.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    return templates;
};

window.firebaseUpdateMobilityTemplate = async function(id, data) {
    try {
        const refDoc = doc(db, 'mobilityTemplates', id);
        const docSnap = await getDoc(refDoc);
        if (!docSnap.exists()) return alert('Template not found');
        const existing = docSnap.data();
        if (existing.userId !== currentUserId) return alert('You do not have permission to edit this template');

        await updateDoc(refDoc, {
            name: data.name,
            exercises: (data.exercises || []).map(exercise => ({
                name: exercise.name,
                instructions: exercise.instructions,
                sets: exercise.sets,
                reps: exercise.reps
            }))
        });
    } catch (error) {
        alert('Error updating mobility template: ' + error.message);
        console.error(error);
    }
};

window.firebaseDeleteMobilityTemplate = async function(id) {
    try {
        if (!confirm('Delete this mobility template?')) return;

        const refDoc = doc(db, 'mobilityTemplates', id);
        const docSnap = await getDoc(refDoc);
        if (!docSnap.exists()) return alert('Template not found');
        const existing = docSnap.data();
        if (existing.userId !== currentUserId) return alert('You do not have permission to delete this template');

        await deleteDoc(refDoc);
        await window.firebaseRenderMobilityTemplates();
    } catch (error) {
        alert('Error deleting mobility template: ' + error.message);
        console.error(error);
    }
};

window.firebaseRenderMobilityTemplates = async function() {
    const listEl = document.getElementById('mobilityTemplatesList');
    if (!listEl) return;

    const templates = await window.firebaseGetMobilityTemplates();
    window.mobilityTemplatesCache = templates;

    if (!templates.length) {
        listEl.innerHTML = '<li style="color:#666;padding:1rem;">No mobility templates yet. Create your first template.</li>';
        return;
    }

    listEl.innerHTML = templates.map(template => {
        const exerciseCount = (template.exercises || []).length;
        return `
            <li>
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.8rem;flex-wrap:wrap;">
                    <div style="flex:1;min-width:0;">
                        <strong>${template.name || 'Untitled Template'}</strong>
                        <p style="color:var(--muted);font-size:0.92rem;margin:0.35rem 0 0 0;">${exerciseCount} exercise${exerciseCount === 1 ? '' : 's'}</p>
                    </div>
                    <div class="card-actions">
                        <button class="submit-btn btn-sm" onclick="openMobilityDesignSessionModal('${template.id}')">Use Template</button>
                        <button class="submit-btn btn-sm" onclick="openMobilityTemplateBuilder('${template.id}')">Edit</button>
                        <button class="submit-btn btn-danger btn-sm" onclick="window.firebaseDeleteMobilityTemplate('${template.id}')">Delete</button>
                    </div>
                </div>
            </li>
        `;
    }).join('');
};

window.firebaseCreateMobilitySession = async function(templateId, date) {
    try {
        const template = (window.mobilityTemplatesCache || []).find(t => t.id === templateId)
            || (await window.firebaseGetMobilityTemplates()).find(t => t.id === templateId);

        if (!template) return alert('Template not found');

        await addDoc(collection(db, 'mobilitySessions'), {
            userId: currentUserId,
            templateId,
            templateName: template.name || 'Untitled Template',
            date,
            exercises: (template.exercises || []).map(exercise => ({
                name: exercise.name,
                instructions: exercise.instructions,
                sets: exercise.sets,
                reps: exercise.reps
            })),
            status: 'planned',
            createdAt: Date.now()
        });

        await window.firebaseRenderMobilitySessions();
    } catch (error) {
        alert('Error creating mobility session: ' + error.message);
        console.error(error);
    }
};

window.firebaseGetMobilitySessions = async function() {
    if (!currentUserId) return [];

    const snapshot = await getDocs(query(
        collection(db, 'mobilitySessions'),
        where('userId', '==', currentUserId)
    ));

    const sessions = [];
    snapshot.forEach(docSnap => {
        sessions.push({ id: docSnap.id, ...docSnap.data() });
    });

    sessions.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
    return sessions;
};

window.firebaseUpdateMobilitySession = async function(id, data) {
    try {
        const refDoc = doc(db, 'mobilitySessions', id);
        const docSnap = await getDoc(refDoc);
        if (!docSnap.exists()) return alert('Session not found');
        const existing = docSnap.data();
        if (existing.userId !== currentUserId) return alert('You do not have permission to edit this session');

        await updateDoc(refDoc, data);
        await window.firebaseRenderMobilitySessions();
        if (window.initMobilityCalendar) window.initMobilityCalendar();
    } catch (error) {
        alert('Error updating mobility session: ' + error.message);
        console.error(error);
    }
};

window.firebaseRenderMobilitySessions = async function() {
    const listEl = document.getElementById('mobilitySessionsList');
    if (!listEl || !currentUserId) return;

    const sessions = await window.firebaseGetMobilitySessions();
    const upcoming = sessions.filter(session => (session.status || 'planned') === 'planned');

    window.mobilitySessionDataMap = {};

    if (!upcoming.length) {
        listEl.innerHTML = '<li style="color:#666;padding:1rem;">No upcoming mobility sessions.</li>';
        return;
    }

    listEl.innerHTML = upcoming.map(session => {
        window.mobilitySessionDataMap[session.id] = session;
        const exerciseCount = (session.exercises || []).length;
        return `
            <li>
                <div style="display:flex;justify-content:space-between;align-items:center;gap:0.8rem;flex-wrap:wrap;">
                    <div>
                        <strong>${session.date || ''}</strong>
                        <p style="color:var(--muted);font-size:0.9rem;margin:0.2rem 0 0 0;">${session.templateName || 'Untitled Template'}</p>
                        <p style="color:var(--muted);font-size:0.9rem;margin:0.2rem 0 0 0;">${exerciseCount} exercise${exerciseCount === 1 ? '' : 's'}</p>
                    </div>
                    <div class="card-actions">
                        <button class="submit-btn btn-sm" onclick="startMobilitySession('${session.id}')">Start</button>
                        <button class="submit-btn btn-sm" onclick="editMobilitySessionDate('${session.id}')">Edit Date</button>
                        <button class="submit-btn btn-danger btn-sm" onclick="window.firebaseDeleteMobilitySession('${session.id}')">Delete</button>
                    </div>
                </div>
            </li>
        `;
    }).join('');
};

window.firebaseDeleteMobilitySession = async function(id) {
    try {
        if (!confirm('Delete this planned mobility session?')) return;

        const refDoc = doc(db, 'mobilitySessions', id);
        const docSnap = await getDoc(refDoc);
        if (!docSnap.exists()) return alert('Session not found');
        const session = docSnap.data();
        if (session.userId !== currentUserId) return alert('You do not have permission to delete this session');

        await deleteDoc(refDoc);
        await window.firebaseRenderMobilitySessions();
        if (window.initMobilityCalendar) window.initMobilityCalendar();
    } catch (error) {
        alert('Error deleting mobility session: ' + error.message);
        console.error(error);
    }
};

window.firebaseRenderHistoryList = async function() {
    const listEl = document.getElementById('historyList');
    if (!listEl) return;

    const typeFilter = (document.getElementById('historyTypeFilter')?.value || 'all');
    const dateFilter = document.getElementById('historyDateFilter')?.value || '';
    const searchQuery = (document.getElementById('historySearchInput')?.value || '').trim().toLowerCase();

    if (typeFilter === 'matches') {
        listEl.innerHTML = '<li style="color:#666;padding:1rem;">Filtered to match records.</li>';
        return;
    }

    const q = query(collection(db, 'history'), where("userId", "==", currentUserId), where("module", "==", currentModule));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
        listEl.innerHTML = '<li style="color:#666;padding:1rem;">No completed sessions yet.</li>';
        return;
    }

        let html = "";
        await fetchJournalsForUser();
        snapshot.forEach(docSnap => {
                const h = docSnap.data();
                if (dateFilter && h.date !== dateFilter) return;
                const completionPercentage = h.totalItems > 0 ? Math.round((h.completedItemsCount / h.totalItems) * 100) : 0;
                const finishedDate = new Date(h.finishedAtTimestamp).toLocaleString();
                const items = (h.items || [])
                        .map(it => `<div>${it.type}: ${it.exercise} ‚Äî ${it.minutes} min</div>`)
                        .join('');
                const combinedText = `${h.date} ${items}`.toLowerCase();
                if (searchQuery && !combinedText.includes(searchQuery)) return;
                const journalBtnText = journalMapByRecordId[docSnap.id] ? 'Edit Journal' : 'Add Journal';
                const journalBtn = `<button class='submit-btn btn-secondary btn-sm' style='margin-top:0.5rem;' onclick='openJournalForRecord("session", "${docSnap.id}", "${h.date}")'>${journalBtnText}</button>`;
                const editBtn = `<button class='submit-btn btn-sm' onclick='editHistorySession("${docSnap.id}")'>Edit</button>`;
                const deleteBtn = `<button class='submit-btn btn-danger btn-sm' onclick='deleteHistorySession("${docSnap.id}")'>Delete</button>`;
                html += `
        <li>
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                    <strong>${h.date}</strong>
                    <p style="color:var(--muted);font-size:0.85rem;margin:0.3rem 0 0 0;">Completed: ${h.completedItemsCount}/${h.totalItems} items <span class="badge badge-accent">${completionPercentage}%</span></p>
                    <p style="color:var(--muted);font-size:0.8rem;margin:0.2rem 0 0 0;">${finishedDate}</p>
                    ${journalBtn}
                </div>
                <div class="card-actions">
                    ${editBtn}
                    ${deleteBtn}
                </div>
            </div>
            <div style="margin-top:0.5rem;">${items}</div>
        </li>
`;
        });
        listEl.innerHTML = html || '<li style="color:#666;padding:1rem;">No sessions match the filters.</li>';
};

window.firebaseSaveMatchRecord = async function(matchData) {
    try {
        const matchRecord = {
            date: matchData.date,
            opponent: matchData.opponent,
            score: matchData.score,
            result: matchData.result,
            savedAtTimestamp: Date.now(),
            userId: currentUserId,
            module: currentModule
        };

        await addDoc(collection(db, 'matches'), matchRecord);

        alert('Match record saved!');
        document.getElementById('matchForm').reset();
        await window.firebaseRenderMatchHistory(); initCalendar();
    } catch (error) {
        alert('Error saving match record: ' + error.message);
        console.error(error);
    }
};

window.firebaseUpdateMatchRecord = async function(docId, matchData) {
    try {
        await updateDoc(doc(db, 'matches', docId), {
            date: matchData.date,
            opponent: matchData.opponent,
            score: matchData.score,
            result: matchData.result
        });
        alert('Match record updated!');
        await window.firebaseRenderMatchHistory();
        initCalendar();
    } catch (error) {
        alert('Error updating match record: ' + error.message);
        console.error(error);
    }
};

window.firebaseRenderMatchHistory = async function() {
    const listEl = document.getElementById('matchHistoryList');
    if (!listEl) return;

        const typeFilter = (document.getElementById('historyTypeFilter')?.value || 'all');
        const dateFilter = document.getElementById('historyDateFilter')?.value || '';
        const searchQuery = (document.getElementById('historySearchInput')?.value || '').trim().toLowerCase();

        if (typeFilter === 'sessions') {
                listEl.innerHTML = '<li style="color:#666;padding:1rem;">Filtered to training sessions.</li>';
                return;
        }

    const q = query(collection(db, 'matches'), where("userId", "==", currentUserId), where("module", "==", currentModule));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
        listEl.innerHTML = '<li style="color:#666;padding:1rem;">No match records yet.</li>';
        return;
    }


        let html = "";
        await fetchJournalsForUser();
        snapshot.forEach(docSnap => {
            const m = docSnap.data();
            const savedDate = new Date(m.savedAtTimestamp).toLocaleString();
                        if (dateFilter && m.date !== dateFilter) return;
                        const resultBadgeClass = m.result === 'Win' ? 'badge-success' : m.result === 'Loss' ? 'badge-danger' : 'badge-warning';
                        const combinedText = `${m.date} ${m.opponent} ${m.score} ${m.result}`.toLowerCase();
                        if (searchQuery && !combinedText.includes(searchQuery)) return;
            const journalBtnText = journalMapByRecordId[docSnap.id] ? 'Edit Journal' : 'Add Journal';
            const journalBtn = `<button class='submit-btn btn-secondary btn-sm' style='margin-top:0.5rem;' onclick='openJournalForRecord("match", "${docSnap.id}", "${m.date}")'>${journalBtnText}</button>`;
            const editBtn = `<button class='submit-btn btn-sm' onclick='editMatchRecord("${docSnap.id}")'>Edit</button>`;
            const deleteBtn = `<button class='submit-btn btn-danger btn-sm' onclick='deleteMatchRecord("${docSnap.id}")'>Delete</button>`;
            html += `
        <li>
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="flex:1;">
              <strong>${m.date}</strong> vs <strong>${m.opponent}</strong>
              <p style="color:var(--muted);font-size:0.85rem;margin:0.3rem 0 0 0;">Score: ${m.score}</p>
                            <div style="margin:0.3rem 0 0 0;"><span class="badge ${resultBadgeClass}">${m.result}</span></div>
              <p style="color:var(--muted);font-size:0.8rem;margin:0.2rem 0 0 0;">${savedDate}</p>
              ${journalBtn}
            </div>
            <div class="card-actions">
              ${editBtn}
              ${deleteBtn}
            </div>
          </div>
        </li>
    `;
        });
                listEl.innerHTML = html || '<li style="color:#666;padding:1rem;">No matches match the filters.</li>';
};

window.deleteJournalsForRecord = async function(recordId) {
    const q = query(collection(db, 'journals'), where('userId', '==', currentUserId), where('module', '==', currentModule), where('recordId', '==', recordId));
    const snapshot = await getDocs(q);
    const deletePromises = [];
    snapshot.forEach(docSnap => {
        deletePromises.push(deleteDoc(doc(db, 'journals', docSnap.id)));
    });
    await Promise.all(deletePromises);
};

window.editHistorySession = async function(docId) {
    try {
        const docRef = doc(db, 'history', docId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return alert('Session not found');
        const h = docSnap.data();
        if (h.userId !== currentUserId) return alert('You do not have permission to edit this session!');
        openHistoryEditModal(docId, h.date || '');
    } catch (error) {
        alert('Error editing session: ' + error.message);
        console.error(error);
    }
};

window.openHistoryEditModal = function(docId, dateValue) {
    currentHistoryEditId = docId;
    const modal = document.getElementById('historyEditModal');
    const dateInput = document.getElementById('historyEditDate');
    if (dateInput) dateInput.value = dateValue;
    if (modal) modal.classList.add('active');
};

window.closeHistoryEditModal = function() {
    const modal = document.getElementById('historyEditModal');
    if (modal) modal.classList.remove('active');
    currentHistoryEditId = null;
};

window.saveHistoryEdit = async function() {
    const dateInput = document.getElementById('historyEditDate');
    const newDate = dateInput ? dateInput.value : '';
    if (!currentHistoryEditId) return;
    if (!newDate) { alert('Please select a date'); return; }
    try {
        await updateDoc(doc(db, 'history', currentHistoryEditId), { date: newDate });
        closeHistoryEditModal();
        await window.firebaseRenderHistoryList();
        initCalendar();
    } catch (error) {
        alert('Error editing session: ' + error.message);
        console.error(error);
    }
};

window.deleteHistorySession = async function(docId) {
    if (!confirm('This will delete the session and all associated journal entries. Continue?')) return;
    try {
        const docRef = doc(db, 'history', docId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return alert('Session not found');
        const h = docSnap.data();
        if (h.userId !== currentUserId) return alert('You do not have permission to delete this session!');
        await deleteJournalsForRecord(docId);
        await deleteDoc(docRef);
        await window.firebaseRenderHistoryList();
        initCalendar();
    } catch (error) {
        alert('Error deleting session: ' + error.message);
        console.error(error);
    }
};

window.editMatchRecord = async function(docId) {
    try {
        const docRef = doc(db, 'matches', docId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return alert('Match record not found');
        const m = docSnap.data();
        if (m.userId !== currentUserId) return alert('You do not have permission to edit this match!');
        document.getElementById('matchDate').value = m.date || '';
        document.getElementById('opponentName').value = m.opponent || '';
        document.getElementById('matchScore').value = m.score || '';
        document.getElementById('matchResult').value = m.result || '';
        currentMatchEditId = docId;
        setMatchEditMode(true);
        const btn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.dataset.tab === 'match');
        switchTab('match', btn || null);
    } catch (error) {
        alert('Error editing match: ' + error.message);
        console.error(error);
    }
};

window.deleteMatchRecord = async function(docId) {
    if (!confirm('This will delete the match record and all associated journal entries. Continue?')) return;
    try {
        const docRef = doc(db, 'matches', docId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return alert('Match record not found');
        const m = docSnap.data();
        if (m.userId !== currentUserId) return alert('You do not have permission to delete this match!');
        await deleteJournalsForRecord(docId);
        await deleteDoc(docRef);
        await window.firebaseRenderMatchHistory();
        initCalendar();
    } catch (error) {
        alert('Error deleting match: ' + error.message);
        console.error(error);
    }
};

window.firebaseClearTrainingHistory = async function() {
    try {
        const q = query(collection(db, 'history'), where("userId", "==", currentUserId));
        const snapshot = await getDocs(q);
        const deletePromises = [];
        
        snapshot.forEach(docSnap => {
            deletePromises.push(deleteDoc(doc(db, 'history', docSnap.id)));
        });
        
        await Promise.all(deletePromises);
        
        alert('Training history cleared!');
        await window.firebaseRenderHistoryList();
    } catch (error) {
        alert('Error clearing training history: ' + error.message);
        console.error(error);
    }
};

window.firebaseClearMatchHistory = async function() {
    try {
        const q = query(collection(db, 'matches'), where("userId", "==", currentUserId));
        const snapshot = await getDocs(q);
        const deletePromises = [];
        
        snapshot.forEach(docSnap => {
            deletePromises.push(deleteDoc(doc(db, 'matches', docSnap.id)));
        });
        
        await Promise.all(deletePromises);
        
        alert('Match history cleared!');
        await window.firebaseRenderMatchHistory(); initCalendar();
    } catch (error) {
        alert('Error clearing match history: ' + error.message);
        console.error(error);
    }
};

// Actuaries Module
const actuarySubjects = ['SP1', 'SP2'];
const actuaryState = {
    subject: null,
    noteId: null,
    mode: 'edit',
    lastOrder: 0
};

let actuaryUiInitialized = false;
let actuarySortable = null;
window.actuaryState = actuaryState;

function setActuaryNotesStatus(message, isError) {
    const statusEl = document.getElementById('actuaryNotesStatus');
    if (!statusEl) return;
    statusEl.textContent = message || '';
    statusEl.style.color = isError ? '#ef4444' : 'var(--muted)';
}

function setActuaryView(viewId) {
    const homeView = document.getElementById('actuaryHomeView');
    const subjectView = document.getElementById('actuarySubjectView');
    if (homeView) homeView.style.display = viewId === 'home' ? 'block' : 'none';
    if (subjectView) subjectView.style.display = viewId === 'subject' ? 'block' : 'none';
}

window.closeActuaryNoteModal = function() {
    const modal = document.getElementById('actuaryNoteModal');
    if (modal) modal.classList.remove('active');
    actuaryState.noteId = null;
};

window.addQuestionFromHighlight = function(text) {
    if (!text) return;
    console.log('Highlight captured:', text);
};

window.initializeActuariesUI = function() {
    if (actuaryUiInitialized) return;
    const editor = document.getElementById('noteEditor');
    const viewer = document.getElementById('noteViewer');
    if (!editor || !viewer) return;

    // Add mouseup listener to both editor and viewer for question highlighting
    const addHighlightListener = (element) => {
        element.addEventListener('mouseup', () => {
            if (actuaryState.mode !== 'read') return;
            const selection = window.getSelection();
            if (!selection || selection.isCollapsed) return;
            const text = selection.toString().trim();
            if (!text) return;
            window.addQuestionFromHighlight(text);
        });
    };
    
    addHighlightListener(editor);
    addHighlightListener(viewer);

    actuaryUiInitialized = true;
};

window.showActuaryModules = function() {
    actuaryState.subject = null;
    actuaryState.noteId = null;
    setActuaryView('home');
};

window.showSubjectNotes = async function(subject) {
    if (!subject) return;
    actuaryState.subject = subject;
    const titleEl = document.getElementById('actuarySubjectTitle');
    if (titleEl) titleEl.textContent = `${subject} Notes`;
    setActuaryView('subject');
    await window.loadNotes();
};

window.loadNotesForSubject = async function(subject) {
    await window.showSubjectNotes(subject);
};

window.loadNotes = async function() {
    const listEl = document.getElementById('actuaryNotesList');
    if (!listEl) return;
    if (!currentUserId || !actuaryState.subject) {
        listEl.innerHTML = '<div class="muted">Sign in to view notes.</div>';
        return;
    }

    listEl.innerHTML = '<div class="muted">Loading notes...</div>';

    try {
        console.log('Loading notes for:', {
            userId: currentUserId,
            subject: actuaryState.subject
        });

        const q = query(
            collection(db, 'actuary_notes'),
            where('userId', '==', currentUserId),
            where('subject', '==', actuaryState.subject),
            orderBy('order', 'asc')
        );
        const snapshot = await getDocs(q);
        console.log('Notes loaded:', snapshot.size, 'documents');
        
        listEl.innerHTML = '';
        actuaryState.lastOrder = 0;

        if (snapshot.empty) {
            listEl.innerHTML = '<div class="muted">No notes yet. Create your first note.</div>';
            return;
        }

        snapshot.forEach((docSnap, index) => {
            const data = docSnap.data();
            const orderValue = typeof data.order === 'number' ? data.order : index;
            actuaryState.lastOrder = Math.max(actuaryState.lastOrder, orderValue);

            const card = document.createElement('div');
            card.className = 'actuary-note-card';
            card.setAttribute('data-note-id', docSnap.id);

            const meta = document.createElement('div');
            meta.className = 'actuary-note-meta';
            const title = document.createElement('h4');
            title.textContent = data.title || 'Untitled Note';
            const progress = document.createElement('div');
            progress.className = 'actuary-progress';
            const progressBar = document.createElement('div');
            progressBar.className = 'actuary-progress-bar';
            progress.appendChild(progressBar);
            meta.appendChild(title);
            meta.appendChild(progress);

            const actions = document.createElement('div');
            actions.className = 'card-actions';
            const editBtn = document.createElement('button');
            editBtn.className = 'submit-btn btn-sm';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                window.openNoteEditor(docSnap.id);
            });
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'submit-btn btn-danger btn-sm';
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                window.deleteNote(docSnap.id);
            });
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);

            card.appendChild(meta);
            card.appendChild(actions);
            card.addEventListener('click', () => window.openNoteEditor(docSnap.id));

            listEl.appendChild(card);
        });

        enableDragSorting();
    } catch (error) {
        console.error('Error loading notes:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
        
        let errorMsg = 'Unable to load notes.';
        if (error.code === 'failed-precondition') {
            errorMsg += ' Please create a Firestore index. Check the console for the index creation link.';
        } else if (error.message) {
            errorMsg += ' ' + error.message;
        }
        
        listEl.innerHTML = `<div class="muted">${errorMsg}</div>`;
    }
};

window.openNoteEditor = async function(noteId) {
    const modal = document.getElementById('actuaryNoteModal');
    const titleInput = document.getElementById('actuaryNoteTitle');
    const editor = document.getElementById('noteEditor');
    const viewer = document.getElementById('noteViewer');
    const modeButtons = document.getElementById('actuaryModeButtons');
    if (!modal || !titleInput || !editor || !viewer) return;
    if (!currentUserId) return alert('Please sign in to view notes.');

    setActuaryNotesStatus('');
    modal.classList.add('active');

    if (noteId) {
        try {
            const noteRef = doc(db, 'actuary_notes', noteId);
            const snap = await getDoc(noteRef);
            if (!snap.exists()) {
                alert('Note not found');
                window.closeActuaryNoteModal();
                return;
            }
            const data = snap.data();
            if (data.userId !== currentUserId) {
                alert('You do not have permission to view this note.');
                window.closeActuaryNoteModal();
                return;
            }
            actuaryState.noteId = noteId;
            actuaryState.subject = data.subject;
            titleInput.value = data.title || '';
            
            // Apply highlights to content
            const contentWithHighlights = window.applyHighlights(data.content || '', data.highlights || []);
            
            editor.innerHTML = data.content || '';
            viewer.innerHTML = contentWithHighlights;
            if (modeButtons) modeButtons.style.display = 'flex';
            toggleMode('read');
        } catch (error) {
            console.error('Error loading note', error);
            alert('Error loading note: ' + error.message);
        }
    } else {
        // Creating a new note - ensure subject is set
        if (!actuaryState.subject) {
            alert('Please select a subject first by clicking on a subject card.');
            window.closeActuaryNoteModal();
            return;
        }
        actuaryState.noteId = null;
        titleInput.value = '';
        editor.innerHTML = '';
        viewer.innerHTML = '';
        if (modeButtons) modeButtons.style.display = 'none';
        toggleMode('edit');
    }
};

window.saveNote = async function() {
    const titleInput = document.getElementById('actuaryNoteTitle');
    const editor = document.getElementById('noteEditor');
    const viewer = document.getElementById('noteViewer');
    
    if (!titleInput || !editor || !viewer) {
        console.error('Save failed: Required elements not found');
        return;
    }
    if (!currentUserId) {
        console.error('Save failed: No user logged in');
        return alert('Please sign in to save notes.');
    }
    if (!actuaryState.subject) {
        console.error('Save failed: No subject set', actuaryState);
        return alert('Select a subject first.');
    }

    const title = titleInput.value.trim() || 'Untitled Note';
    
    // Get plain content (without highlight spans)
    let content;
    if (actuaryState.mode === 'edit') {
        content = editor.innerHTML.trim();
    } else {
        // If saving from read mode, strip highlights
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = viewer.innerHTML;
        tempDiv.querySelectorAll('.note-highlight').forEach(span => {
            span.replaceWith(span.textContent);
        });
        content = tempDiv.innerHTML.trim();
    }

    console.log('Saving note:', {
        noteId: actuaryState.noteId,
        subject: actuaryState.subject,
        title: title.substring(0, 30),
        contentLength: content.length
    });

    try {
        if (actuaryState.noteId) {
            console.log('Updating existing note:', actuaryState.noteId);
            
            // Get existing highlights to preserve them
            const noteRef = doc(db, 'actuary_notes', actuaryState.noteId);
            const snap = await getDoc(noteRef);
            const existingHighlights = snap.exists() ? (snap.data().highlights || []) : [];
            
            await updateDoc(noteRef, {
                title,
                content,
                highlights: existingHighlights, // Preserve existing highlights
                updatedAt: Date.now()
            });
            console.log('Note updated successfully');
        } else {
            const newOrder = (actuaryState.lastOrder || 0) + 1;
            console.log('Creating new note with order:', newOrder);
            const docRef = await addDoc(collection(db, 'actuary_notes'), {
                userId: currentUserId,
                subject: actuaryState.subject,
                title,
                content,
                order: newOrder,
                highlights: [], // Initialize empty highlights array
                createdAt: Date.now()
            });
            console.log('Note created successfully:', docRef.id);
        }
        setActuaryNotesStatus('Saved.', false);
        await window.loadNotes();
    } catch (error) {
        console.error('Error saving note', error);
        setActuaryNotesStatus('Error saving note: ' + error.message, true);
        alert('Error saving note: ' + error.message);
    }
};

window.deleteNote = async function(noteId) {
    if (!noteId) return;
    if (!confirm('Delete this note?')) return;
    try {
        const noteRef = doc(db, 'actuary_notes', noteId);
        const snap = await getDoc(noteRef);
        if (!snap.exists()) return alert('Note not found');
        const data = snap.data();
        if (data.userId !== currentUserId) return alert('You do not have permission to delete this note.');
        await deleteDoc(noteRef);
        await window.loadNotes();
    } catch (error) {
        console.error('Error deleting note', error);
        alert('Error deleting note: ' + error.message);
    }
};

window.enableDragSorting = function() {
    const listEl = document.getElementById('actuaryNotesList');
    if (!listEl || typeof Sortable === 'undefined') return;
    if (actuarySortable) {
        actuarySortable.destroy();
        actuarySortable = null;
    }

    actuarySortable = Sortable.create(listEl, {
        animation: 150,
        onStart: (evt) => evt.item.classList.add('dragging'),
        onEnd: async (evt) => {
            evt.item.classList.remove('dragging');
            await updateOrderInFirestore();
        }
    });
};

window.updateOrderInFirestore = async function() {
    const listEl = document.getElementById('actuaryNotesList');
    if (!listEl) return;
    const cards = Array.from(listEl.querySelectorAll('.actuary-note-card'));
    if (cards.length === 0) return;

    const updates = cards.map((card, index) => {
        const noteId = card.getAttribute('data-note-id');
        return updateDoc(doc(db, 'actuary_notes', noteId), { order: index + 1 });
    });

    try {
        await Promise.all(updates);
    } catch (error) {
        console.error('Error updating order', error);
    }
};

let currentFontSize = 17;
let selectedRange = null;
let currentHighlightSelection = null;

// Text Selection Detection for Highlighting (Read Mode Only)
document.addEventListener('mouseup', function(e) {
    const viewer = document.getElementById('noteViewer');
    const popup = document.getElementById('highlightCommentPopup');
    
    if (!viewer || viewer.style.display === 'none') {
        if (popup) popup.style.display = 'none';
        return;
    }
    
    // Don't show popup if clicking inside the popup itself
    if (popup && popup.contains(e.target)) return;
    
    // Don't show popup if clicking on existing highlight
    if (e.target.classList.contains('note-highlight')) {
        popup.style.display = 'none';
        return;
    }
    
    const selection = window.getSelection();
    
    if (selection && selection.toString().trim().length > 0) {
        // Check if selection is within viewer
        const range = selection.getRangeAt(0);
        if (!viewer.contains(range.commonAncestorContainer)) {
            popup.style.display = 'none';
            return;
        }
        
        selectedRange = range;
        currentHighlightSelection = selection.toString().trim();
        
        const rect = range.getBoundingClientRect();
        popup.style.left = Math.min(rect.left + window.scrollX, window.innerWidth - 280) + 'px';
        popup.style.top = (rect.bottom + window.scrollY + 8) + 'px';
        popup.style.display = 'block';
        
        // Focus the textarea
        setTimeout(() => {
            document.getElementById('highlightQuestionInput')?.focus();
        }, 50);
    } else {
        popup.style.display = 'none';
    }
});

// Hide popup when clicking outside
document.addEventListener('mousedown', function(e) {
    const popup = document.getElementById('highlightCommentPopup');
    if (popup && popup.style.display === 'block' && !popup.contains(e.target)) {
        // Check if not clicking within noteViewer text
        const viewer = document.getElementById('noteViewer');
        if (!viewer || !viewer.contains(e.target)) {
            popup.style.display = 'none';
        }
    }
});

// Click on highlight to show question
let currentHighlightElement = null;
let currentLearnId = null;
let currentLearnSubject = 'SP1';

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('note-highlight')) {
        const question = e.target.getAttribute('data-question');
        if (question) {
            currentHighlightElement = e.target;
            showHighlightQuestion(question);
        }
    }
});

window.getSelectedHtml = function() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return '';
    
    const container = document.createElement('div');
    container.appendChild(selection.getRangeAt(0).cloneContents());
    
    return container.innerHTML;
};

window.showHighlightQuestion = function(question) {
    const modal = document.getElementById('highlightQuestionModal');
    const textDiv = document.getElementById('highlightQuestionText');
    if (modal && textDiv) {
        textDiv.textContent = question;
        modal.style.display = 'flex';
    }
};

window.closeHighlightModal = function() {
    const modal = document.getElementById('highlightQuestionModal');
    if (modal) modal.style.display = 'none';
    currentHighlightElement = null;
};

window.deleteQuestion = async function() {
    if (!currentHighlightElement) return;
    if (!confirm('Delete this question?')) return;

    try {
        const textNode = document.createTextNode(currentHighlightElement.textContent || '');
        currentHighlightElement.replaceWith(textNode);
        await saveHighlightsToFirestore();
        window.closeHighlightModal();
    } catch (error) {
        console.error('Error deleting highlight:', error);
        alert('Error deleting highlight: ' + error.message);
    }
};

window.addHighlightToLearn = async function() {
    const question = document.getElementById('highlightQuestionText')?.textContent;

    if (!question || !currentHighlightElement) return;

    if (!currentUserId || !actuaryState.noteId) {
        alert('Please sign in and open a note first.');
        return;
    }

    try {
        const questionText = question;
        const answerHtml = currentHighlightElement.innerHTML || '';

        await addDoc(collection(db, 'actuary_questions'), {
            userId: currentUserId,
            noteId: actuaryState.noteId,
            question: questionText,
            answer: answerHtml,
            createdAt: Date.now()
        });

        alert('‚úÖ Added to Learn cards!');
        window.closeHighlightModal();

    } catch (error) {
        console.error('Error adding to learn:', error);
        alert('Error adding: ' + error.message);
    }
};

window.cancelHighlight = function() {
    const popup = document.getElementById('highlightCommentPopup');
    if (popup) popup.style.display = 'none';
    document.getElementById('highlightQuestionInput').value = '';
    selectedRange = null;
    currentHighlightSelection = null;
};

window.saveHighlightComment = async function() {
    const question = document.getElementById('highlightQuestionInput').value.trim();
    const popup = document.getElementById('highlightCommentPopup');
    
    if (!question || !selectedRange) return;
    
    try {
        const span = document.createElement('span');
        span.className = 'note-highlight';
        span.setAttribute('data-question', question);
        
        // Use extractContents + insertNode for complex selections
        // This works across multiple DOM nodes (lists, paragraphs, headings)
        const extracted = selectedRange.extractContents();
        span.appendChild(extracted);
        selectedRange.insertNode(span);
        
        popup.style.display = 'none';
        document.getElementById('highlightQuestionInput').value = '';
        
        // Save to Firestore
        await saveHighlightsToFirestore();
        
        // Clear selection
        window.getSelection()?.removeAllRanges();
        selectedRange = null;
        currentHighlightSelection = null;
    } catch (error) {
        console.error('Error adding highlight:', error);
        alert('Could not add highlight. Please try again or select a different text range.');
    }
};

window.saveHighlightsToFirestore = async function() {
    if (!actuaryState.noteId) return;
    
    const viewer = document.getElementById('noteViewer');
    if (!viewer) return;
    
    const highlights = Array.from(viewer.querySelectorAll('.note-highlight')).map(el => ({
        text: el.innerText,
        question: el.getAttribute('data-question')
    }));
    
    try {
        const docRef = doc(db, 'actuary_notes', actuaryState.noteId);
        await updateDoc(docRef, {
            highlights: highlights
        });
        console.log('Highlights saved:', highlights.length);
    } catch (error) {
        console.error('Error saving highlights:', error);
    }
};

window.applyHighlights = function(content, highlights) {
    if (!highlights || highlights.length === 0) return content;
    
    let result = content;
    highlights.forEach(h => {
        if (h.text && h.question) {
            const highlightedHTML = `<span class="note-highlight" data-question="${h.question.replace(/"/g, '&quot;')}">${h.text}</span>`;
            // Replace first occurrence only to avoid nested replacements
            result = result.replace(h.text, highlightedHTML);
        }
    });
    
    return result;
};

window.adjustFontSize = function(delta) {
    currentFontSize = Math.max(12, Math.min(24, currentFontSize + delta));
    const editor = document.getElementById('noteEditor');
    const viewer = document.getElementById('noteViewer');
    if (editor) editor.style.fontSize = currentFontSize + 'px';
    if (viewer) viewer.style.fontSize = currentFontSize + 'px';
};

window.toggleMode = function(mode) {
    const editor = document.getElementById('noteEditor');
    const viewer = document.getElementById('noteViewer');
    const readBtn = document.getElementById('actuaryReadModeBtn');
    const editBtn = document.getElementById('actuaryEditModeBtn');
    const popup = document.getElementById('highlightCommentPopup');
    if (!editor || !viewer) return;
    
    actuaryState.mode = mode;
    const isRead = mode === 'read';
    
    // Hide highlight popup when switching modes
    if (popup) popup.style.display = 'none';
    
    // Sync content between editor and viewer
    if (isRead) {
        // When switching to read mode, preserve highlights if they exist
        if (viewer.innerHTML && viewer.querySelector('.note-highlight')) {
            // Keep viewer as is (has highlights)
        } else {
            viewer.innerHTML = editor.innerHTML;
        }
        editor.style.display = 'none';
        viewer.style.display = 'block';
    } else {
        // When switching to edit mode, use plain content without highlights
        editor.innerHTML = viewer.innerHTML.replace(/<span class="note-highlight"[^>]*>(.*?)<\/span>/g, '$1');
        editor.style.display = 'block';
        viewer.style.display = 'none';
    }
    
    if (readBtn) readBtn.classList.toggle('active', isRead);
    if (editBtn) editBtn.classList.toggle('active', !isRead);
};

window.loadLearnQuestions = async function(subjectOverride) {
    const listEl = document.getElementById('actuaryLearnList');
    const subjectSelect = document.getElementById('actuaryLearnSubject');
    if (!listEl || !subjectSelect) return;
    if (!currentUserId) {
        listEl.innerHTML = '<div class="muted">Sign in to view questions.</div>';
        return;
    }

    if (subjectSelect.options.length === 0) {
        subjectSelect.innerHTML = actuarySubjects.map(subject => `<option value="${subject}">${subject}</option>`).join('');
    }

    const subject = subjectOverride || subjectSelect.value || actuarySubjects[0];
    subjectSelect.value = subject;
    currentLearnSubject = subject;

    try {
        const learnSnap = await getDocs(query(
            collection(db, 'actuary_learn'),
            where('userId', '==', currentUserId),
            where('subject', '==', subject),
            orderBy('createdAt', 'desc')
        ));

        if (learnSnap.empty) {
            listEl.innerHTML = '<div class="muted">No learn items yet for this subject.</div>';
            return;
        }

        listEl.innerHTML = '';
        learnSnap.forEach((docSnap) => {
            const data = docSnap.data();
            const card = document.createElement('div');
            card.className = 'actuary-learn-card';
            
            const title = document.createElement('h4');
            title.textContent = data.question || 'Question';
            
            const answer = document.createElement('div');
            answer.className = 'actuary-learn-answer';
            answer.innerHTML = data.extractHtml || '';
            answer.style.display = 'none';
            
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.5rem;';
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'submit-btn btn-sm';
            toggleBtn.textContent = 'Show Answer';
            toggleBtn.addEventListener('click', () => {
                const isVisible = answer.style.display === 'block';
                answer.style.display = isVisible ? 'none' : 'block';
                toggleBtn.textContent = isVisible ? 'Show Answer' : 'Hide Answer';
            });
            
            const editBtn = document.createElement('button');
            editBtn.className = 'submit-btn btn-sm';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', () => {
                openLearnEditor(docSnap.id, data);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'submit-btn btn-danger btn-sm';
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', () => {
                deleteLearnItem(docSnap.id);
            });
            
            btnContainer.appendChild(toggleBtn);
            btnContainer.appendChild(editBtn);
            btnContainer.appendChild(deleteBtn);
            
            card.appendChild(title);
            card.appendChild(btnContainer);
            card.appendChild(answer);
            listEl.appendChild(card);
        });
    } catch (error) {
        console.error('Error loading learn questions:', error);
        listEl.innerHTML = '<div class="muted">Unable to load questions.</div>';
    }
};

window.openLearnEditor = function(learnId, data) {
    currentLearnId = learnId;
    const modal = document.getElementById('learnEditorModal');
    const questionInput = document.getElementById('learnQuestionInput');
    const extractEditor = document.getElementById('learnExtractEditor');
    
    if (modal && questionInput && extractEditor) {
        questionInput.value = data.question || '';
        extractEditor.innerHTML = data.extractHtml || '';
        modal.style.display = 'flex';
    }
};

window.closeLearnEditor = function() {
    const modal = document.getElementById('learnEditorModal');
    if (modal) modal.style.display = 'none';
    currentLearnId = null;
};

window.saveLearnEdit = async function() {
    if (!currentLearnId) return;
    
    const question = document.getElementById('learnQuestionInput').value.trim();
    const extractHtml = document.getElementById('learnExtractEditor').innerHTML.trim();
    
    if (!question) {
        alert('Please enter a question');
        return;
    }
    
    try {
        await updateDoc(doc(db, 'actuary_learn', currentLearnId), {
            question: question,
            extractHtml: extractHtml,
            updatedAt: Date.now()
        });
        
        closeLearnEditor();
        await loadLearnQuestions(currentLearnSubject);
        alert('‚úÖ Saved successfully!');
    } catch (error) {
        console.error('Error saving learn item:', error);
        alert('Error saving: ' + error.message);
    }
};

window.deleteCurrentLearn = async function() {
    if (!currentLearnId) return;
    
    if (!confirm('Delete this learn item?')) return;
    
    try {
        await deleteDoc(doc(db, 'actuary_learn', currentLearnId));
        closeLearnEditor();
        await loadLearnQuestions(currentLearnSubject);
    } catch (error) {
        console.error('Error deleting learn item:', error);
        alert('Error deleting: ' + error.message);
    }
};

window.deleteLearnItem = async function(learnId) {
    if (!learnId) return;
    
    if (!confirm('Delete this learn item?')) return;
    
    try {
        await deleteDoc(doc(db, 'actuary_learn', learnId));
        await loadLearnQuestions(currentLearnSubject);
    } catch (error) {
        console.error('Error deleting learn item:', error);
        alert('Error deleting: ' + error.message);
    }
};

let learnModalOpen = false;
let cardsArray = [];
let currentCardIndex = 0;
let cardFontSize = 18;

window.applyCardFontSize = function() {
    document.querySelectorAll('.card-textarea').forEach(el => {
        el.style.fontSize = cardFontSize + 'px';
    });
};

window.increaseCardFont = function() {
    cardFontSize += 1;
    applyCardFontSize();
};

window.decreaseCardFont = function() {
    cardFontSize = Math.max(14, cardFontSize - 1);
    applyCardFontSize();
};

function setCardControlsDisabled(disabled) {
    const editBtn = document.getElementById('editCardBtn');
    const deleteBtn = document.getElementById('deleteCardBtn');
    const saveBtn = document.getElementById('saveCardBtn');
    const toggleBtn = document.getElementById('toggleAnswerBtn');
    const prevBtn = document.querySelector('#learnModal .learn-modal-footer button[onclick="prevCard()"]');
    const nextBtn = document.querySelector('#learnModal .learn-modal-footer button[onclick="nextCard()"]');

    [editBtn, deleteBtn, saveBtn, toggleBtn, prevBtn, nextBtn].forEach(btn => {
        if (btn) btn.disabled = !!disabled;
    });
}

window.openLearnModal = async function() {
    if (!currentUserId || !actuaryState.noteId) {
        alert('Please sign in and open a note first.');
        return;
    }
    const modal = document.getElementById('learnModal');
    if (!modal) return;
    modal.style.display = 'flex';
    learnModalOpen = true;
    await loadCardsForNote();
};

window.closeLearnModal = function() {
    const modal = document.getElementById('learnModal');
    if (modal) modal.style.display = 'none';
    learnModalOpen = false;
};

window.loadCardsForNote = async function() {
    const statusEl = document.getElementById('learnStatus');
    if (statusEl) statusEl.textContent = 'Loading...';

    cardsArray = [];
    console.log('Loading cards for:');
    console.log('User:', currentUserId);
    console.log('Note:', actuaryState.noteId);

    if (!actuaryState.noteId) {
        if (statusEl) statusEl.textContent = 'No note selected.';
        renderCard();
        return;
    }

    try {
        const q = query(
            collection(db, 'actuary_questions'),
            where('userId', '==', currentUserId),
            where('noteId', '==', actuaryState.noteId)
        );
        const snapshot = await getDocs(q);
        console.log('Cards found:', snapshot.size);
        cardsArray = snapshot.docs.map(docSnap => ({
            id: docSnap.id,
            ...docSnap.data()
        }));
        currentCardIndex = 0;
        renderCard();
        if (statusEl) {
            statusEl.textContent = cardsArray.length ? '' : 'No cards yet for this note.';
        }
    } catch (error) {
        console.error('Error loading cards:', error);
        if (statusEl) statusEl.textContent = 'Failed to load cards.';
    }
};

window.renderCard = function() {
    const counterEl = document.getElementById('cardCounter');
    const questionDisplay = document.getElementById('cardQuestionDisplay');
    const questionEdit = document.getElementById('cardQuestionEdit');
    const answerDisplay = document.getElementById('cardAnswerDisplay');
    const answerEdit = document.getElementById('cardAnswerEdit');
    const answerSection = document.getElementById('answerSection');
    const toggleBtn = document.getElementById('toggleAnswerBtn');
    const editBtn = document.getElementById('editCardBtn');
    const saveBtn = document.getElementById('saveCardBtn');
    const deleteBtn = document.getElementById('deleteCardBtn');
    const bodyEl = document.getElementById('learnCardBody');

    if (!counterEl || !questionDisplay || !questionEdit || !answerDisplay || !answerEdit || !answerSection) return;

    if (!cardsArray.length) {
        counterEl.textContent = 'Card 0 of 0';
        questionDisplay.textContent = 'No cards yet for this note.';
        questionEdit.value = '';
        answerDisplay.textContent = '';
        answerEdit.value = '';
        answerSection.style.display = 'none';
        if (toggleBtn) toggleBtn.textContent = 'Show Answer';
        if (editBtn) editBtn.style.display = 'inline-block';
        if (deleteBtn) deleteBtn.style.display = 'inline-block';
        if (saveBtn) saveBtn.style.display = 'none';
        setCardEditMode(false);
        setCardControlsDisabled(true);
        return;
    }

    const card = cardsArray[currentCardIndex];
    counterEl.textContent = `Card ${currentCardIndex + 1} of ${cardsArray.length}`;
    questionDisplay.textContent = card.question || '';
    questionEdit.value = card.question || '';
    answerDisplay.innerHTML = card.answer || '';
    answerEdit.value = card.answer || '';
    answerSection.style.display = 'none';
    if (toggleBtn) toggleBtn.textContent = 'Show Answer';
    if (editBtn) editBtn.style.display = 'inline-block';
    if (deleteBtn) deleteBtn.style.display = 'inline-block';
    if (saveBtn) saveBtn.style.display = 'none';
    setCardEditMode(false);
    setCardControlsDisabled(false);

    applyCardFontSize();

    if (bodyEl) {
        bodyEl.style.opacity = '0';
        requestAnimationFrame(() => {
            bodyEl.style.opacity = '1';
        });
    }
};

window.toggleAnswer = function() {
    const answerSection = document.getElementById('answerSection');
    const toggleBtn = document.getElementById('toggleAnswerBtn');
    if (!answerSection || !toggleBtn) return;
    const isVisible = answerSection.style.display === 'block';
    answerSection.style.display = isVisible ? 'none' : 'block';
    toggleBtn.textContent = isVisible ? 'Show Answer' : 'Hide Answer';
};

window.nextCard = function() {
    if (currentCardIndex < cardsArray.length - 1) {
        currentCardIndex += 1;
        renderCard();
    }
};

window.prevCard = function() {
    if (currentCardIndex > 0) {
        currentCardIndex -= 1;
        renderCard();
    }
};

window.enableCardEdit = function() {
    const questionEdit = document.getElementById('cardQuestionEdit');
    const answerEdit = document.getElementById('cardAnswerEdit');
    const saveBtn = document.getElementById('saveCardBtn');
    const editBtn = document.getElementById('editCardBtn');
    if (!questionEdit || !answerEdit) return;

    setCardEditMode(true);
    if (saveBtn) saveBtn.style.display = 'inline-block';
    if (editBtn) editBtn.style.display = 'none';
};

window.saveCardEdit = async function() {
    const card = cardsArray[currentCardIndex];
    if (!card) return;

    const questionEdit = document.getElementById('cardQuestionEdit');
    const answerEdit = document.getElementById('cardAnswerEdit');
    const saveBtn = document.getElementById('saveCardBtn');
    const editBtn = document.getElementById('editCardBtn');
    const statusEl = document.getElementById('learnStatus');

    try {
        await updateDoc(doc(db, 'actuary_questions', card.id), {
            question: questionEdit.value.trim(),
            answer: answerEdit.value.trim()
        });
        cardsArray[currentCardIndex] = {
            ...card,
            question: questionEdit.value.trim(),
            answer: answerEdit.value.trim()
        };
        setCardEditMode(false);
        if (saveBtn) saveBtn.style.display = 'none';
        if (editBtn) editBtn.style.display = 'inline-block';
        if (statusEl) statusEl.textContent = 'Saved.';
    } catch (error) {
        console.error('Error updating card:', error);
        if (statusEl) statusEl.textContent = 'Save failed.';
    }
};

function setCardEditMode(isEdit) {
    const questionDisplay = document.getElementById('cardQuestionDisplay');
    const questionEdit = document.getElementById('cardQuestionEdit');
    const answerDisplay = document.getElementById('cardAnswerDisplay');
    const answerEdit = document.getElementById('cardAnswerEdit');

    if (!questionDisplay || !questionEdit || !answerDisplay || !answerEdit) return;

    questionDisplay.style.display = isEdit ? 'none' : 'block';
    questionEdit.style.display = isEdit ? 'block' : 'none';
    answerDisplay.style.display = isEdit ? 'none' : 'block';
    answerEdit.style.display = isEdit ? 'block' : 'none';
}

window.deleteCard = async function() {
    const card = cardsArray[currentCardIndex];
    const statusEl = document.getElementById('learnStatus');
    if (!card) return;

    if (!confirm('Delete this card permanently?')) return;

    try {
        await deleteDoc(doc(db, 'actuary_questions', card.id));
        cardsArray.splice(currentCardIndex, 1);

        if (!cardsArray.length) {
            if (statusEl) statusEl.textContent = 'Card deleted.';
            closeLearnModal();
            alert('Card deleted');
            return;
        }

        if (currentCardIndex >= cardsArray.length) {
            currentCardIndex = cardsArray.length - 1;
        }
        renderCard();
        if (statusEl) statusEl.textContent = 'Card deleted.';
    } catch (error) {
        console.error('Error deleting card:', error);
        if (statusEl) statusEl.textContent = 'Delete failed.';
    }
}

document.addEventListener('keydown', (e) => {
    if (!learnModalOpen) return;
    const activeTag = document.activeElement?.tagName || '';
    const isEditable = ['INPUT', 'TEXTAREA'].includes(activeTag) && !document.activeElement.readOnly;
    if (isEditable) return;

    if (e.key === 'ArrowRight') {
        nextCard();
    } else if (e.key === 'ArrowLeft') {
        prevCard();
    } else if (e.code === 'Space') {
        e.preventDefault();
        toggleAnswer();
    }
});

// TEST FUNCTIONS
window.saveSession = async function(session){
    await addDoc(collection(db,"sessions"), session);
    console.log("Saved:", session);
}

window.loadSessions = async function(){
    const snapshot = await getDocs(collection(db,"sessions"));
    snapshot.forEach(doc => console.log(doc.data()));
}

</script>

<!-- Journal Modal HTML (replaces previous modal if any) -->
<div id="journalEntryModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:100;align-items:center;justify-content:center;">
    <div id="journalModalBox" class="journal-modal-box">
        <h2 id="journalModalTitle">Journal Entry</h2>
        <textarea id="journalEntryTextarea" placeholder="Write your thoughts..."></textarea>
        <div style="display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center;">
            <button class="submit-btn" id="startDictationBtn" style="background:#3b82f6;" onclick="startDictation()">Start Dictation</button>
            <span id="dictationStatus" style="color:#3b82f6;font-weight:600;font-size:0.9rem;display:none;">Listening...</span>
        </div>
            <div class="modal-actions">
            <button class="submit-btn" id="saveJournalBtn" onclick="saveJournalEntry()">Save</button>
            <button class="submit-btn" style="background:#67748a;" onclick="closeJournalEntryModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="journalViewModal">
    <div class="journal-view-box">
        <h2 id="journalViewTitle">Journal Entry</h2>
        <div id="journalViewText" style="white-space:pre-line;color:#0f2540;font-size:1.02rem;"></div>
        <div class="modal-actions">
            <button class="submit-btn" id="journalViewEditBtn" onclick="editJournalFromView()">Edit</button>
            <button class="submit-btn" style="background:#67748a;" onclick="closeJournalViewModal()">Close</button>
        </div>
    </div>
</div>

<!-- Actuaries Notes Modal -->
<div id="actuaryNoteModal" class="actuary-editor-modal">
    <div class="actuary-editor-box">
        <div class="actuary-editor-top">
            <button class="submit-btn btn-muted btn-sm" onclick="closeActuaryNoteModal()">‚Üê Back</button>
            <div class="actuary-editor-modes" id="actuaryModeButtons" style="display:none;">
                <button class="submit-btn btn-muted btn-sm" id="actuaryReadModeBtn" onclick="toggleMode('read')">üëÅÔ∏è Read</button>
                <button class="submit-btn btn-sm" id="actuaryEditModeBtn" onclick="toggleMode('edit')">‚úèÔ∏è Edit</button>
                <button class="submit-btn btn-sm" onclick="openLearnModal()">üìö Learn</button>
                <div class="actuary-font-controls">
                    <button onclick="adjustFontSize(-1)" title="Decrease font size">A-</button>
                    <button onclick="adjustFontSize(1)" title="Increase font size">A+</button>
                </div>
            </div>
        </div>
        <div class="actuary-editor-row">
            <label for="actuaryNoteTitle">Title</label>
            <input id="actuaryNoteTitle" type="text" placeholder="Note title">
        </div>
        <div class="actuary-editor-body-wrapper">
            <div class="note-container">
                <div id="noteEditor" class="note-content" contenteditable="true"></div>
                <div id="noteViewer" class="note-content"></div>
            </div>
        </div>
        <div class="actuary-editor-footer">
            <span class="muted" id="actuaryNotesStatus"></span>
            <button class="submit-btn" onclick="saveNote()">Save Notes</button>
        </div>
    </div>
    
    <!-- Highlight Comment Popup -->
    <div id="highlightCommentPopup" style="
        position:fixed;
        display:none;
        z-index:999;
        background:white;
        border:1px solid #e5e7eb;
        border-radius:8px;
        padding:12px;
        box-shadow:0 10px 25px rgba(0,0,0,0.15);
    ">
        <textarea id="highlightQuestionInput"
            placeholder="Enter your question..."
            style="width:240px;height:70px;border:1px solid #d1d5db;border-radius:6px;padding:8px;font-family:inherit;resize:none;"></textarea>
        <div style="margin-top:8px;text-align:right;display:flex;gap:6px;justify-content:flex-end;">
            <button class="submit-btn btn-muted btn-sm" onclick="cancelHighlight()">Cancel</button>
            <button class="submit-btn btn-sm" onclick="saveHighlightComment()">Add Comment</button>
        </div>
    </div>
    
    <!-- Highlight Question Viewer Modal -->
    <div id="highlightQuestionModal" style="
        position:fixed;
        display:none;
        inset:0;
        background:rgba(20, 28, 38, 0.45);
        backdrop-filter:blur(8px);
        z-index:999;
        align-items:center;
        justify-content:center;
    ">
        <div style="
            background:white;
            padding:1.5rem 2rem;
            border-radius:12px;
            box-shadow:0 20px 50px rgba(0,0,0,0.2);
            max-width:500px;
            width:90%;
        ">
            <h3 style="margin:0 0 0.5rem 0;color:#0f2540;font-size:18px;">üí° Question</h3>
            <div id="highlightQuestionText" style="
                background:#f8f9fa;
                padding:12px 14px;
                border-radius:8px;
                margin-bottom:1rem;
                border-left:3px solid #1abc9c;
                color:#1f2937;
                line-height:1.6;
            "></div>
            <div style="display:flex;gap:0.6rem;justify-content:flex-end;">
                <button class="submit-btn btn-muted btn-sm" onclick="closeHighlightModal()">Close</button>
                <button class="submit-btn btn-sm" onclick="addHighlightToLearn()">üìö Add to Learn Tab</button>
                <button class="submit-btn btn-danger btn-sm" onclick="deleteQuestion()">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Learn Extract Editor Modal -->
    <div id="learnEditorModal" style="
        position:fixed;
        display:none;
        inset:0;
        background:rgba(20, 28, 38, 0.45);
        backdrop-filter:blur(8px);
        z-index:999;
        align-items:center;
        justify-content:center;
    ">
        <div style="
            background:white;
            padding:1.5rem 2rem;
            border-radius:12px;
            box-shadow:0 20px 50px rgba(0,0,0,0.2);
            max-width:600px;
            width:90%;
            max-height:80vh;
            overflow-y:auto;
        ">
            <h3 style="margin:0 0 0.5rem 0;color:#0f2540;font-size:18px;">üìù Edit Learn Extract</h3>
            <div style="margin-bottom:1rem;">
                <label style="display:block;margin-bottom:0.3rem;color:#374151;font-weight:500;font-size:14px;">Question</label>
                <input id="learnQuestionInput" type="text" placeholder="Enter question..." style="
                    width:100%;
                    padding:0.6rem;
                    border:1px solid #d1d5db;
                    border-radius:6px;
                    font-size:15px;
                ">
            </div>
            <div style="margin-bottom:1rem;">
                <label style="display:block;margin-bottom:0.3rem;color:#374151;font-weight:500;font-size:14px;">Extract Content</label>
                <div id="learnExtractEditor" contenteditable="true" style="
                    min-height:150px;
                    padding:0.8rem;
                    border:1px solid #d1d5db;
                    border-radius:6px;
                    background:#fafbfc;
                    font-size:15px;
                    line-height:1.6;
                    outline:none;
                "></div>
            </div>
            <div style="display:flex;gap:0.6rem;justify-content:flex-end;">
                <button class="submit-btn btn-muted btn-sm" onclick="closeLearnEditor()">Cancel</button>
                <button class="submit-btn btn-danger btn-sm" onclick="deleteCurrentLearn()">Delete</button>
                <button class="submit-btn btn-sm" onclick="saveLearnEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Learn Card Reviewer Modal -->
    <div id="learnModal" class="learn-overlay" style="display:none;">
        <div class="learn-modal">
            <div class="learn-header">
                <div id="cardCounter">Card 0 of 0</div>
                <button class="learn-modal-close" onclick="closeLearnModal()">‚úï</button>
            </div>
            <div id="learnCardBody" class="learn-modal-body">
                <div>
                    <div class="label">Question</div>
                    <div id="cardQuestionDisplay" class="card-textarea"></div>
                    <textarea id="cardQuestionEdit" class="card-textarea" style="display:none;"></textarea>
                </div>
                <div>
                    <button class="btn btn-grey" id="toggleAnswerBtn" onclick="toggleAnswer()">Show Answer</button>
                </div>
                <div id="answerSection" class="answer-section">
                    <div class="label">Answer</div>
                    <div id="cardAnswerDisplay" class="card-textarea card-answer"></div>
                    <textarea id="cardAnswerEdit" class="card-textarea card-answer" style="display:none;"></textarea>
                </div>
                <div class="font-controls">
                    <button class="btn btn-grey" onclick="decreaseCardFont()">A-</button>
                    <button class="btn btn-grey" onclick="increaseCardFont()">A+</button>
                </div>
            </div>
            <div class="card-actions">
                <button class="btn btn-grey" onclick="prevCard()">Previous</button>
                <button class="btn btn-green" id="editCardBtn" onclick="enableCardEdit()">Edit</button>
                <button class="btn btn-red" id="deleteCardBtn" onclick="deleteCard()">Delete</button>
                <button class="btn btn-green" id="saveCardBtn" onclick="saveCardEdit()" style="display:none;">Save</button>
                <button class="btn btn-grey" onclick="nextCard()">Next</button>
            </div>
            <div class="muted" id="learnStatus" style="min-width:140px;text-align:right;"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// --- Journal Global State ---
let currentJournalContext = null; // { type, recordId, date }
let currentJournalDocId = null;
let journalMapByRecordId = {}; // { [recordId]: { docId, ...data } }
let currentJournalViewContext = null; // { type, recordId, date }
let dictationRecognition = null;
let isDictating = false;

// --- Modal UI Functions ---
function openJournalForRecord(type, recordId, date) {
    currentJournalContext = { type, recordId, date };
    currentJournalDocId = null;
    const modal = document.getElementById('journalEntryModal');
    const textarea = document.getElementById('journalEntryTextarea');
    const title = document.getElementById('journalModalTitle');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('active');
        textarea.focus();
        window.scrollTo({top:0,behavior:'smooth'});
    }, 10);
    // Title
    title.textContent = (journalMapByRecordId[recordId]) ? 'Edit Journal' : 'Add Journal';
    textarea.value = '';
    // Query Firestore for existing journal
    const journal = journalMapByRecordId[recordId];
    if (journal) {
        textarea.value = journal.text;
        currentJournalDocId = journal.docId;
    } else {
        textarea.value = '';
        currentJournalDocId = null;
    }
}

function closeJournalEntryModal() {
    const modal = document.getElementById('journalEntryModal');
    modal.classList.remove('active');
    setTimeout(() => { modal.style.display = 'none'; }, 180);
    currentJournalContext = null;
    currentJournalDocId = null;
    stopDictation();
}

function openJournalViewModal(type, recordId, date, text) {
    currentJournalViewContext = { type, recordId, date };
    const modal = document.getElementById('journalViewModal');
    const title = document.getElementById('journalViewTitle');
    const textEl = document.getElementById('journalViewText');
    title.textContent = `${date} (${type})`;
    textEl.textContent = text || '';
    modal.classList.add('active');
}

function openJournalViewModalFromCard(cardEl) {
    if (!cardEl) return;
    const type = cardEl.getAttribute('data-type') || '';
    const recordId = cardEl.getAttribute('data-record-id') || '';
    const date = cardEl.getAttribute('data-date') || '';
    const text = decodeURIComponent(cardEl.getAttribute('data-text') || '');
    openJournalViewModal(type, recordId, date, text);
}

function closeJournalViewModal() {
    const modal = document.getElementById('journalViewModal');
    modal.classList.remove('active');
    currentJournalViewContext = null;
}

function editJournalFromView() {
    if (!currentJournalViewContext) return;
    const { type, recordId, date } = currentJournalViewContext;
    closeJournalViewModal();
    openJournalForRecord(type, recordId, date);
}

function getSpeechRecognition() {
    return window.SpeechRecognition || window.webkitSpeechRecognition;
}

function startDictation() {
    const RecognitionConstructor = getSpeechRecognition();
    const statusEl = document.getElementById('dictationStatus');
    const textarea = document.getElementById('journalEntryTextarea');
    if (!RecognitionConstructor) {
        alert('Dictation is not supported in this browser.');
        return;
    }
    if (isDictating) {
        return;
    }
    dictationRecognition = new RecognitionConstructor();
    dictationRecognition.continuous = false;
    dictationRecognition.interimResults = false;
    dictationRecognition.maxAlternatives = 1;
    dictationRecognition.lang = navigator.language || 'en-US';
    isDictating = true;
    statusEl.style.display = 'inline';

    dictationRecognition.onresult = (event) => {
        const transcript = Array.from(event.results)
            .map(result => result[0].transcript)
            .join(' ')
            .trim();
        if (transcript) {
            const separator = textarea.value && !textarea.value.endsWith(' ') ? ' ' : '';
            textarea.value = `${textarea.value}${separator}${transcript}`;
        }
        dictationRecognition.stop();
    };

    dictationRecognition.onerror = (event) => {
        console.error('Dictation error', event);
        alert('Dictation error: ' + event.error);
    };

    dictationRecognition.onend = () => {
        isDictating = false;
        statusEl.style.display = 'none';
    };

    try {
        dictationRecognition.start();
    } catch (error) {
        console.error('Dictation start failed', error);
        alert('Unable to start dictation.');
        isDictating = false;
        statusEl.style.display = 'none';
    }
}

function stopDictation() {
    if (dictationRecognition && isDictating) {
        dictationRecognition.stop();
    }
}

async function saveJournalEntry() {
    const textarea = document.getElementById('journalEntryTextarea');
    let text = textarea.value.trim();
    if (!text) { textarea.focus(); alert('Please add text'); return; }
    
    const { type, recordId, date } = currentJournalContext;
    
    const journalsRef = collection(db, 'journals');
    if (currentJournalDocId) {
        // Update
        const updateData = { text };
        await updateDoc(doc(db, 'journals', currentJournalDocId), updateData);
    } else {
        // Add
        const docData = {
            userId: currentUserId,
            type,
            recordId,
            date,
            text,
            createdAt: Date.now(),
            module: currentModule
        };
        await addDoc(journalsRef, docData);
    }
    closeJournalEntryModal();
    await refreshAllJournalUI();
}

// --- Refresh Logic ---
async function refreshAllJournalUI() {
    await fetchJournalsForUser();
    if (window.firebaseRenderHistoryList) await window.firebaseRenderHistoryList();
    if (window.firebaseRenderMatchHistory) await window.firebaseRenderMatchHistory();
    if (window.firebaseRenderJournalList) await window.firebaseRenderJournalList();
}

// --- Fetch all journals for user and build map ---
async function fetchJournalsForUser() {
    journalMapByRecordId = {};
    const q = query(collection(db, 'journals'), where('userId', '==', currentUserId), where('module', '==', currentModule));
    const snapshot = await getDocs(q);
    snapshot.forEach(docSnap => {
        const data = docSnap.data();
        journalMapByRecordId[data.recordId] = { ...data, docId: docSnap.id };
    });
}

// --- Journal Tab Renderer ---
window.firebaseRenderJournalList = async function() {
    const listEl = document.getElementById('journalList');
    if (!listEl) return;
    
    try {
        const q = query(collection(db, 'journals'), where('userId', '==', currentUserId), where('module', '==', currentModule));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            listEl.innerHTML = '<li style="color:#666;padding:1.5rem;text-align:center;">No journal entries yet.</li>';
            return;
        }
        
        const typeFilter = (document.getElementById('journalTypeFilter')?.value || 'all');
        const dateFilter = document.getElementById('journalDateFilter')?.value || '';
        const searchQuery = (document.getElementById('journalSearchInput')?.value || '').trim().toLowerCase();

        const journalArray = snapshot.docs.map(docSnap => ({
            ...docSnap.data(),
            docId: docSnap.id
        }));
        
        // Sort by createdAt descending in JavaScript
        journalArray.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        
        let html = '';
        const filteredArray = journalArray.filter(j => {
            if (typeFilter !== 'all' && j.type !== typeFilter) return false;
            if (dateFilter && j.date !== dateFilter) return false;
            const combinedText = `${j.date} ${j.text || ''}`.toLowerCase();
            if (searchQuery && !combinedText.includes(searchQuery)) return false;
            return true;
        });

        if (filteredArray.length === 0) {
            listEl.innerHTML = '<li style="color:#666;padding:1.5rem;text-align:center;">No journal entries match the filters.</li>';
            return;
        }

        filteredArray.forEach(j => {
            const typeColor = j.type === 'session' ? '#ef4444' : '#3b82f6';
                        const encodedText = encodeURIComponent(j.text || '');
            html += `<li>
                            <div class='journal-card' role='button' tabindex='0' onclick='openJournalViewModalFromCard(this)' data-type='${j.type}' data-record-id='${j.recordId}' data-date='${j.date}' data-text='${encodedText}'>
                                <div style='font-size:1.08rem;font-weight:600;color:#0f2540;'>${j.date} <span style='background:${typeColor};color:white;padding:0.3rem 0.6rem;border-radius:6px;font-size:0.85rem;font-weight:500;'>${j.type}</span></div>
                                <div class='journal-preview'>${j.text || ''}</div>
                            </div>
            </li>`;
        });
        listEl.innerHTML = html;
    } catch (error) {
        console.error('Error rendering journal list:', error);
        listEl.innerHTML = '<li style="color:#ef4444;padding:1.5rem;text-align:center;">Error loading journal entries. Check console.</li>';
    }
}
</script>

<script>
let calTrainDates={}, calMatchDates={}, calTrainDetails={}, calMatchDetails={};
let calMobilityDates={}, calMobilityDetails={};

function initCalendar(){
    const m=document.getElementById("calMonth");
    const y=document.getElementById("calYear");
    if(!m || !y) {
        console.error('Calendar elements not found');
        return;
    }
    
    // Clear previous options
    m.innerHTML = '';
    y.innerHTML = '';
    
    const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    months.forEach((mo,i)=>{
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = mo;
        m.appendChild(opt);
    });
    
    const cy=new Date().getFullYear();
    for(let yr=cy-2;yr<=cy+2;yr++) {
        const opt = document.createElement('option');
        opt.value = yr;
        opt.textContent = yr;
        y.appendChild(opt);
    }
    
    const now=new Date();
    m.value=now.getMonth(); 
    y.value=now.getFullYear();
    
    m.onchange=renderCalendar; 
    y.onchange=renderCalendar;
    
    loadCalendarData();
}

async function loadCalendarData(){
    try {
        calTrainDates={}; 
        calMatchDates={};
        calTrainDetails={};
        calMatchDetails={};
        
        if(!currentUserId) {
            console.log('No user logged in');
            renderCalendar();
            return;
        }
        
        const hSnap=await getDocs(query(collection(db,"history"), where("userId","==",currentUserId), where("module","==",currentModule)));
        hSnap.forEach(d=> {
            const h = d.data();
            const dateStr = h.date;
            if(dateStr) {
                calTrainDates[dateStr]=true;
                if (!calTrainDetails[dateStr]) calTrainDetails[dateStr]=[];
                calTrainDetails[dateStr].push(h);
                console.log('Training date:', dateStr);
            }
        });
        
        const mSnap=await getDocs(query(collection(db,"matches"), where("userId","==",currentUserId), where("module","==",currentModule)));
        mSnap.forEach(d=> {
            const m = d.data();
            const dateStr = m.date;
            if(dateStr) {
                calMatchDates[dateStr]=true;
                if (!calMatchDetails[dateStr]) calMatchDetails[dateStr]=[];
                calMatchDetails[dateStr].push(m);
                console.log('Match date:', dateStr);
            }
        });
        
        renderCalendar();
    } catch (error) {
        console.error('Error loading calendar data:', error);
        renderCalendar();
    }
}

function renderCalendar(){
    const monthEl=document.getElementById("calMonth");
    const yearEl=document.getElementById("calYear");
    
    if(!monthEl || !yearEl) {
        console.error('Calendar selectors not found');
        return;
    }
    
    const month=parseInt(monthEl.value);
    const year=parseInt(yearEl.value);
    
    const first=new Date(year,month,1);
    const last=new Date(year,month+1,0);
    const start=first.getDay();
    const days=last.getDate();
    const grid=document.getElementById("calendarGrid");
    
    if(!grid) {
        console.error('Calendar grid not found');
        return;
    }
    
    grid.innerHTML="";
    
    // Create header row with day names
    const headerRow=document.createElement("div"); 
    headerRow.className="calendar-row";
    const dayNames=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    dayNames.forEach(day=>{
        const dayCell=document.createElement("div");
        dayCell.className="calendar-cell";
        dayCell.textContent=day;
        dayCell.style.fontWeight="700";
        dayCell.style.color="#0f2540";
        dayCell.style.background="transparent";
        headerRow.appendChild(dayCell);
    });
    grid.appendChild(headerRow);
    
    let row=document.createElement("div"); 
    row.className="calendar-row";
    
    // Add empty cells for days before month starts
    for(let i=0;i<start;i++) {
        const emptyCell=document.createElement("div");
        emptyCell.className="calendar-cell";
        emptyCell.style.background='transparent';
        row.appendChild(emptyCell);
    }
    
    // Add date cells
    for(let d=1;d<=days;d++){
        const key=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const cell=document.createElement("div");
        cell.className="calendar-cell";
        
        if(calTrainDates[key]) {
            cell.classList.add("cal-train");
        } else if(calMatchDates[key]) {
            cell.classList.add("cal-match");
        }
        
        cell.textContent=d;
        cell.addEventListener('click', () => openCalendarDetail(key));
        row.appendChild(cell);
        
        if((start+d)%7===0){ 
            grid.appendChild(row); 
            row=document.createElement("div"); 
            row.className="calendar-row"; 
        }
    }
    
    // Append final row if it has cells
    if(row.children.length > 0) grid.appendChild(row);
    
    console.log('Calendar rendered for', month, year);
}

function openCalendarDetail(dateStr) {
    const modal = document.getElementById('calendarDetailModal');
    const title = document.getElementById('calendarDetailTitle');
    const content = document.getElementById('calendarDetailContent');
    if (!modal || !title || !content) return;
    title.textContent = dateStr;
    const sessions = calTrainDetails[dateStr] || [];
    const matches = calMatchDetails[dateStr] || [];
    let html = '';

    if (sessions.length === 0 && matches.length === 0) {
        html = '<p class="muted">No sessions or matches for this date.</p>';
    }

    if (sessions.length > 0) {
        html += '<div class="calendar-detail-section"><div class="calendar-detail-title">Training Sessions</div>';
        sessions.forEach(s => {
            const itemsText = (s.items || []).map(it => `${it.type}: ${it.exercise} ‚Äî ${it.minutes} min`).join(' | ');
            html += `<div class="calendar-detail-item">${itemsText || 'Session completed'}</div>`;
        });
        html += '</div>';
    }

    if (matches.length > 0) {
        html += '<div class="calendar-detail-section"><div class="calendar-detail-title">Matches</div>';
        matches.forEach(m => {
            const resultBadgeClass = m.result === 'Win' ? 'badge-success' : m.result === 'Loss' ? 'badge-danger' : 'badge-warning';
            html += `<div class="calendar-detail-item">${m.opponent} ‚Äî ${m.score} <span class="badge ${resultBadgeClass}">${m.result}</span></div>`;
        });
        html += '</div>';
    }

    content.innerHTML = html;
    modal.classList.add('active');
}

function closeCalendarDetailModal() {
    const modal = document.getElementById('calendarDetailModal');
    if (modal) modal.classList.remove('active');
}

function initMobilityCalendar() {
    const m = document.getElementById('mobilityCalMonth');
    const y = document.getElementById('mobilityCalYear');
    if (!m || !y) return;

    m.innerHTML = '';
    y.innerHTML = '';

    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    months.forEach((monthName, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = monthName;
        m.appendChild(option);
    });

    const currentYear = new Date().getFullYear();
    for (let year = currentYear - 2; year <= currentYear + 2; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        y.appendChild(option);
    }

    const now = new Date();
    m.value = now.getMonth();
    y.value = now.getFullYear();

    m.onchange = renderMobilityCalendar;
    y.onchange = renderMobilityCalendar;

    loadMobilityCalendarData();
}

async function loadMobilityCalendarData() {
    calMobilityDates = {};
    calMobilityDetails = {};

    if (!currentUserId || !window.db || !window.getDocs || !window.query || !window.collection || !window.where) {
        renderMobilityCalendar();
        return;
    }

    try {
        const sessionsSnapshot = await window.getDocs(window.query(
            window.collection(window.db, 'mobilitySessions'),
            window.where('userId', '==', currentUserId),
            window.where('status', '==', 'completed')
        ));

        sessionsSnapshot.forEach(docSnap => {
            const session = docSnap.data();
            if (!session.date) return;
            calMobilityDates[session.date] = true;
            if (!calMobilityDetails[session.date]) calMobilityDetails[session.date] = [];
            calMobilityDetails[session.date].push(session);
        });
    } catch (error) {
        console.error('Error loading mobility calendar data:', error);
    }

    renderMobilityCalendar();
}

function renderMobilityCalendar() {
    const monthEl = document.getElementById('mobilityCalMonth');
    const yearEl = document.getElementById('mobilityCalYear');
    const grid = document.getElementById('mobilityCalendarGrid');
    if (!monthEl || !yearEl || !grid) return;

    const month = parseInt(monthEl.value, 10);
    const year = parseInt(yearEl.value, 10);

    const first = new Date(year, month, 1);
    const last = new Date(year, month + 1, 0);
    const start = first.getDay();
    const days = last.getDate();

    grid.innerHTML = '';

    const headerRow = document.createElement('div');
    headerRow.className = 'calendar-row';
    ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(dayName => {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-cell';
        dayCell.textContent = dayName;
        dayCell.style.fontWeight = '700';
        dayCell.style.color = '#0f2540';
        dayCell.style.background = 'transparent';
        headerRow.appendChild(dayCell);
    });
    grid.appendChild(headerRow);

    let row = document.createElement('div');
    row.className = 'calendar-row';

    for (let i = 0; i < start; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-cell';
        emptyCell.style.background = 'transparent';
        row.appendChild(emptyCell);
    }

    for (let day = 1; day <= days; day++) {
        const key = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        if (calMobilityDates[key]) {
            cell.classList.add('cal-train');
        }
        cell.textContent = day;
        cell.addEventListener('click', () => openMobilityCalendarDetail(key));
        row.appendChild(cell);

        if ((start + day) % 7 === 0) {
            grid.appendChild(row);
            row = document.createElement('div');
            row.className = 'calendar-row';
        }
    }

    if (row.children.length > 0) grid.appendChild(row);
}

function openMobilityCalendarDetail(dateStr) {
    const modal = document.getElementById('calendarDetailModal');
    const title = document.getElementById('calendarDetailTitle');
    const content = document.getElementById('calendarDetailContent');
    if (!modal || !title || !content) return;

    title.textContent = dateStr;
    const sessions = calMobilityDetails[dateStr] || [];

    if (!sessions.length) {
        content.innerHTML = '<p class="muted">No mobility sessions for this date.</p>';
        modal.classList.add('active');
        return;
    }

    let html = '<div class="calendar-detail-section"><div class="calendar-detail-title">Mobility Session Completed</div>';
    sessions.forEach(session => {
        html += `<div class="calendar-detail-item"><strong>${session.templateName || 'Untitled Template'}</strong></div>`;
        html += '<div class="calendar-detail-item" style="margin-top:0.3rem;">';
        html += (session.exercises || []).map(item => `${item.name} (${item.sets} x ${item.reps})`).join(' | ') || 'No exercise details';
        html += '</div>';
    });
    html += '</div>';

    content.innerHTML = html;
    modal.classList.add('active');
}

window.initMobilityCalendar = initMobilityCalendar;
</script>

</body>
</html>
