<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tennis Training</title>
    <style>
        /* Journal Modal Large & Responsive */
        #journalEntryModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(20, 28, 38, 0.55);
            z-index: 100;
            align-items: center;
            justify-content: center;
            transition: opacity 0.18s;
        }
        #journalEntryModal.active {
            display: flex;
            opacity: 1;
        }
        .journal-modal-box {
            background: white;
            padding: 2.2rem 2.5rem;
            border-radius: 18px;
            box-shadow: 0 12px 30px rgba(15,23,42,0.13);
            width: 90vw;
            max-width: 900px;
            min-width: 320px;
            min-height: 200px;
            animation: journalModalPop 0.22s cubic-bezier(.4,1.4,.6,1) 1;
            transform: scale(1);
            opacity: 1;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
        @keyframes journalModalPop {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        #journalEntryTextarea {
            min-height: 250px;
            font-size: 1.08rem;
            padding: 1rem 1.2rem;
            border-radius: 12px;
            border: 1px solid #e6edf3;
            background: linear-gradient(180deg,#fff,#fcfeff);
            color: #0f2540;
            resize: vertical;
        }
        @media (max-width: 700px) {
            .journal-modal-box { padding: 1.1rem 0.7rem; max-width: 99vw; }
            #journalEntryTextarea { font-size: 1rem; }
        }
        :root{
            --bg:#f4f6f9;
            --card:#ffffff;
            --muted:#67748a;
            --accent:#1abc9c;
            --accent-600:#16a085;
            --nav-bg:#243746;
            --radius:12px;
            --gap:1rem;
            --max-width:1100px;
            --shadow-sm: 0 4px 12px rgba(15,23,42,0.06);
            --shadow-lg: 0 12px 30px rgba(15,23,42,0.09);
            --glass: rgba(255,255,255,0.6);
        }

        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%}
        body{
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: linear-gradient(180deg,#f7fbfd 0%, var(--bg) 100%);
            color:#12223a;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            line-height:1.45;
        }

        .navbar{
            background:var(--nav-bg);
            padding:0.75rem 1rem;
            position:sticky;top:0;z-index:40;
            box-shadow:var(--shadow-sm);
        }

        .nav-tabs{
            display:flex;gap:0.6rem;align-items:center;max-width:var(--max-width);margin:0 auto;padding:0 1rem;overflow:auto;
        }

        .tab-button{
            white-space:nowrap;padding:0.6rem 1rem;border-radius:10px;border:none;background:transparent;color:#dbe7ef;font-weight:600;cursor:pointer;transition:all .18s ease;font-size:0.95rem;
        }

        .tab-button.active{background:linear-gradient(180deg,var(--accent),var(--accent-600));color:white;box-shadow:var(--shadow-lg);transform:translateY(-2px)}

        .container{max-width:var(--max-width);margin:2rem auto;padding:0 1rem}

        .tab-content{display:none;background:var(--card);padding:1.5rem;border-radius:var(--radius);box-shadow:var(--shadow-sm)}
        .tab-content.active{display:block}

        h1{font-size:1.6rem;margin-bottom:0.75rem;color:#0f2540}
        p{color:var(--muted);margin-bottom:1rem}

        .form-group{margin-bottom:1rem}
        label{display:block;margin-bottom:.4rem;color:#233348;font-weight:600;font-size:.95rem}

        input,textarea,select{width:100%;padding:.75rem 1rem;border-radius:10px;border:1px solid #e6edf3;background:linear-gradient(180deg,#fff,#fcfeff);font-size:0.95rem;color:#0f2540}
        textarea{min-height:110px;resize:vertical}

        .submit-btn{background:var(--accent);color:white;padding:.7rem 1.15rem;border-radius:10px;border:none;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(26,188,156,0.12);transition:transform .12s ease,box-shadow .12s ease}
        .submit-btn:hover{transform:translateY(-2px);background:var(--accent-600)}

        /* Cards & lists */
        .session-list{list-style:none;padding:0;margin:0}
        .session-list li{display:block;padding:1rem;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #eef4f8;margin-bottom:0.9rem;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
        .session-list li strong{display:block;margin-bottom:.5rem}

        /* Design items list */
        #designItemsList li{display:flex;align-items:center;justify-content:space-between;padding:.6rem .75rem;border-radius:8px;background:linear-gradient(180deg,#fbfdff,#ffffff);border:1px solid #eef4f8;margin-bottom:.5rem}
        #designItemsList li button{background:transparent;border:1px solid #e6eef2;padding:.35rem .55rem;border-radius:8px;color:#234;color:#2b4b61;cursor:pointer}

        /* Inline design button on home */
        #designInlineBtn{padding:.75rem 1.1rem;border-radius:10px}

        /* Small helpers */
        .muted{color:var(--muted);font-size:.95rem}

        /* Responsive adjustments */
        @media (max-width:800px){
            .nav-tabs{gap:.5rem;padding:0 .6rem}
            h1{font-size:1.35rem}
            .tab-content{padding:1rem}
        }

        @media (max-width:520px){
            .nav-tabs{padding:0 .5rem;gap:.5rem}
            .tab-button{padding:.6rem .85rem;font-size:.92rem}
            .container{margin:1rem auto;padding:0 .75rem}
            #designItemsList li{flex-direction:column;align-items:flex-start}
            .session-list li{padding:.85rem}
        }

        /* Session Modal Styles */
        #sessionModal[style*="display: none"] {
            display: none !important;
        }

        #modalItemsList li {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 10px;
            background: linear-gradient(180deg, #fbfdff, #ffffff);
            border: 1px solid #eef4f8;
            margin-bottom: 0.8rem;
            gap: 1rem;
            transition: all 0.2s ease;
        }

        #modalItemsList li input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        #modalItemsList li.checked {
            background: rgba(26, 188, 156, 0.15);
            opacity: 0.65;
            border-color: rgba(26, 188, 156, 0.3);
        }

        #modalItemsList li .item-text {
            flex: 1;
            font-size: 0.95rem;
            color: #12223a;
        }

        #finishSessionBtn:hover {
            transform: translateY(-2px);
            background: var(--accent-600);
        }
    
/* Calendar Tab Styles */
#calendar{
  max-width:900px;
  margin:0 auto;
}

#calendarGrid{
  display:flex;
  flex-direction:column;
  align-items:center;
  width:100%;
  padding:1rem;
}

.calendar-row{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  width:100%;
  max-width:550px;
  gap:8px;
  margin-bottom:8px;
}

.calendar-cell{
  width:100%;
  aspect-ratio:1/1;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:10px;
  font-weight:600;
  font-size:0.95rem;
  background:#f1f5f9;
  color:#0f2540;
  cursor:default;
  transition:all 0.2s ease;
}

.calendar-cell:hover{
  transform:scale(1.05);
}

.cal-train{ background:#ef4444; color:white; }
.cal-match{ background:#3b82f6; color:white; }
.cal-train:hover, .cal-match:hover{ transform:scale(1.08); }

#calendar select{
  padding:0.75rem 1rem;
  border-radius:8px;
  border:1px solid #e6edf3;
  background:linear-gradient(180deg,#fff,#fcfeff);
  font-weight:600;
  margin-right:0.8rem;
  margin-bottom:1.5rem;
  cursor:pointer;
}

</style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(180deg,#f7fbfd 0%,var(--bg) 100%);padding:1rem;">
        <div style="background:var(--card);padding:2rem;border-radius:12px;box-shadow:0 12px 30px rgba(15,23,42,0.09);max-width:400px;width:100%;">
            <h1 style="text-align:center;color:#0f2540;margin-bottom:2rem;">Tennis Training App</h1>
            
            <!-- Sign In Form -->
            <div id="signInForm">
                <h2 style="font-size:1.3rem;color:#0f2540;margin-bottom:1.5rem;">Sign In</h2>
                <div class="form-group">
                    <label for="signInEmail">Username:</label>
                    <input type="text" id="signInEmail" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="signInPassword">Password:</label>
                    <input type="password" id="signInPassword" placeholder="Enter your password">
                </div>
                <button class="submit-btn" style="width:100%;" onclick="handleSignIn()">Sign In</button>
                <p style="text-align:center;color:var(--muted);font-size:0.9rem;margin-top:1rem;">
                    Enter username and password to sign in. <br>
                </p>
            </div>
        </div>
    </div>

    <nav class="navbar" id="navbar" style="display:none;">
        <div class="nav-tabs">
            <button class="tab-button active" data-tab="home" onclick="switchTab('home', this)">Home</button>
            <button class="tab-button" data-tab="sessions" onclick="switchTab('sessions', this)">Sessions</button>
            <button class="tab-button" data-tab="match" onclick="switchTab('match', this)">Match</button>
            <button class="tab-button" data-tab="history" onclick="switchTab('history', this)">History</button>
            <button class="tab-button" data-tab="calendar" onclick="switchTab('calendar', this)">Calendar</button>
            <button class="tab-button" data-tab="journal" onclick="switchTab('journal', this)">Journal</button>
            <span id="currentUserDisplay" style="margin-left:auto;padding:0.5rem 1rem;color:var(--text);font-size:0.9rem;align-self:center;"></span>
            <button class="submit-btn" style="background:#ef4444;padding:0.5rem 1rem;font-size:0.9rem;" onclick="handleLogout()">Logout</button>
        </div>
    </nav>

    <div class="container" id="mainContainer" style="display:none;">
        <!-- Home Tab -->
        <div id="home" class="tab-content active">
            <h1>Welcome to My Tennis Training</h1>
            <p style="margin-bottom:1rem;color:#555">Use the button below to design a new session.</p>
            <div style="margin-top:1rem;">
                <button class="submit-btn" id="designInlineBtn" onclick="switchTab('design', this)">Design Your Session</button>
            </div>
        </div>

        <!-- Design Tab -->
        <div id="design" class="tab-content">
            <h1>Design Your Session</h1>
            <form id="designForm" onsubmit="return false;">
                <div class="form-group">
                    <label for="designDate">Date:</label>
                    <input type="date" id="designDate">
                </div>
                <div class="form-group">
                    <label for="designType">Type:</label>
                    <select id="designType" onchange="onDesignTypeChange()">
                        <option value="">Select type...</option>
                        <option value="Conditioning">Conditioning</option>
                        <option value="Tennis Drills">Tennis Drills</option>
                        <option value="Rallies">Rallies</option>
                        <option value="Match Points">Match Points</option>
                    </select>
                </div>
                <div class="form-group" id="exerciseGroup" style="display:none;">
                    <label id="exerciseLabel" for="designExercise">Exercise:</label>
                    <input type="text" id="designExercise" placeholder="Enter exercise name">
                </div>
                <div class="form-group" id="durationGroup" style="display:none;">
                    <label for="designDuration">Time to allocate (minutes):</label>
                    <input type="number" id="designDuration" min="1" placeholder="e.g., 15">
                </div>
                <div class="form-group">
                    <button type="button" class="submit-btn" onclick="addDesignItem()">Add Type to Session</button>
                </div>
            </form>

            <h3>Current Items</h3>
            <ul id="designItemsList" style="list-style:none;padding-left:0;"></ul>

            <div id="morePrompt" style="display:none;margin-top:1rem;">
                <p>Would you like to add any more type?</p>
                <button class="submit-btn" style="margin-right:1rem;" onclick="addAnother()">Yes, add another</button>
                <button class="submit-btn" onclick="finalizeDesignSession()">No, finalize session</button>
            </div>
        </div>

        <!-- Sessions Tab -->
        <div id="sessions" class="tab-content">
            <h1>Upcoming Sessions</h1>
            <ul class="session-list" id="sessionsList"></ul>
        </div>

        <!-- Match Tab -->
        <div id="match" class="tab-content">
            <h1>Match Records</h1>
            <form id="matchForm" onsubmit="return false;">
                <div class="form-group">
                    <label for="matchDate">Date:</label>
                    <input type="date" id="matchDate">
                </div>
                <div class="form-group">
                    <label for="opponentName">Opponent Name:</label>
                    <input type="text" id="opponentName" placeholder="Enter opponent's name">
                </div>
                <div class="form-group">
                    <label for="matchScore">Score (e.g., 6-4, 3-6, 7-5):</label>
                    <input type="text" id="matchScore" placeholder="Enter your score">
                </div>
                <div class="form-group">
                    <label for="matchResult">Result:</label>
                    <select id="matchResult">
                        <option value="">Select result...</option>
                        <option value="Win">Win</option>
                        <option value="Loss">Loss</option>
                        <option value="Draw">Draw</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="button" class="submit-btn" onclick="saveMatchRecord()">Save Match Record</button>
                </div>
            </form>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <h1>Training History</h1>
            
            <!-- Training Sessions Section -->
            <div style="margin-bottom:2rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h3 style="color:#0f2540;margin:0;">Training Sessions</h3>
                    <button class="submit-btn" style="background:#ef4444;padding:0.5rem 1rem;font-size:0.9rem;" onclick="clearTrainingHistory()">Clear History</button>
                </div>
                <ul class="session-list" id="historyList"></ul>
            </div>
            
            <!-- Match Records Section -->
            <div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h3 style="color:#0f2540;margin:0;">Match Records</h3>
                    <button class="submit-btn" style="background:#ef4444;padding:0.5rem 1rem;font-size:0.9rem;" onclick="clearMatchHistory()">Clear History</button>
                </div>
                <ul class="session-list" id="matchHistoryList"></ul>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div id="calendar" class="tab-content">
            <h1>Calendar</h1>
            <div style="display:flex;gap:1rem;margin-bottom:1rem;">
                <select id="calMonth"></select>
                <select id="calYear"></select>
            </div>
            <div id="calendarGrid"></div>
        </div>

        <!-- Journal Tab -->
        <div id="journal" class="tab-content">
            <h1>Journal Entries</h1>
            <ul id="journalList" class="session-list"></ul>
        </div>
    </div>
    </div>

<!-- Session Execution Modal Overlay -->
    <div id="sessionModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;">
        <div style="background:var(--card);margin:0 auto;max-width:600px;min-height:100vh;position:relative;padding:2rem 1.5rem;">
            <!-- Back Button -->
            <button id="modalBackBtn" style="background:transparent;border:none;color:var(--accent);font-weight:700;cursor:pointer;font-size:1rem;padding:0.5rem 0;margin-bottom:1.5rem;" onclick="closeSessionModal()">‚Üê Back</button>
            
            <!-- Session Header -->
            <div id="modalSessionHeader" style="margin-bottom:2rem;">
                <p id="modalSessionDate" style="color:var(--muted);font-size:0.9rem;margin-bottom:0.5rem;"></p>
                <h2 id="modalSessionTitle" style="font-size:1.4rem;color:#0f2540;margin:0;"></h2>
            </div>
            
            <!-- Items Checklist -->
            <ul id="modalItemsList" style="list-style:none;padding:0;margin:0 0 2rem 0;"></ul>
            
            <!-- Finish Session Button -->
            <button id="finishSessionBtn" style="width:100%;background:var(--accent);color:white;padding:1rem;border-radius:10px;border:none;font-weight:700;font-size:1rem;cursor:pointer;box-shadow:0 8px 20px rgba(26,188,156,0.12);transition:transform .12s ease,box-shadow .12s ease;margin-top:1rem;" onclick="finishSession()">
                Finish Session
            </button>
        </div>
    </div>

    <script>
        function switchTab(tabName, el) {
            const contents = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');

            contents.forEach(content => content.classList.remove('active'));
            buttons.forEach(button => button.classList.remove('active'));

            const target = document.getElementById(tabName);
            if (target) target.classList.add('active');

            // Initialize calendar when calendar tab is opened
            if (tabName === 'calendar') {
                setTimeout(() => {
                    initCalendar();
                }, 50);
            }

            // Render journal list when journal tab is opened
            if (tabName === 'journal') {
                setTimeout(async () => {
                    await window.firebaseRenderJournalList();
                }, 50);
            }

            // If an element was provided (nav button or inline button), mark it active
            if (el) {
                el.classList.add('active');
                // If the element is a nav button with data-tab, nothing else to do
                return;
            }

            // Otherwise try to find a nav button that matches the tabName and mark it active
            const navBtn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.dataset.tab === tabName);
            if (navBtn) navBtn.classList.add('active');
        }

        let designItems = [];
        let editingSessionIndex = null;
        let sessionDataMap = {}; // Map to store session data by ID

        // Make these globally accessible
        window.designItems = designItems;
        window.editingSessionIndex = editingSessionIndex;
        window.sessionDataMap = sessionDataMap;

        function onDesignTypeChange() {
            const type = document.getElementById('designType').value;
            const exerciseGroup = document.getElementById('exerciseGroup');
            const durationGroup = document.getElementById('durationGroup');
            const exerciseLabel = document.getElementById('exerciseLabel');
            if (!type) {
                exerciseGroup.style.display = 'none';
                durationGroup.style.display = 'none';
                return;
            }
            exerciseGroup.style.display = 'block';
            durationGroup.style.display = 'block';
            if (type === 'Conditioning') exerciseLabel.textContent = 'Conditioning Exercise:';
            else if (type === 'Tennis Drills') exerciseLabel.textContent = 'Drill:';
            else if (type === 'Rallies') exerciseLabel.textContent = 'Rally Type:';
            else if (type === 'Match Points') exerciseLabel.textContent = 'Point Drill:';
        }

        function addDesignItem() {
            const type = document.getElementById('designType').value;
            const exercise = document.getElementById('designExercise').value.trim();
            const minutes = parseInt(document.getElementById('designDuration').value, 10);
            if (!type) { alert('Please select a type'); return; }
            if (!exercise) { alert('Please enter the exercise/drill name'); return; }
            if (!minutes || minutes <= 0) { alert('Please enter a valid time in minutes'); return; }
            window.designItems.push({type, exercise, minutes});
            renderDesignItems();
            document.getElementById('morePrompt').style.display = 'block';
        }

        function renderDesignItems() {
            const list = document.getElementById('designItemsList');
            if (!list) return;
            if (window.designItems.length === 0) {
                list.innerHTML = '<li style="color:#666">No items yet</li>';
                return;
            }
            list.innerHTML = window.designItems.map((it,i) => `\n                <li style="margin-bottom:0.5rem;">\n                  <strong>${it.type}</strong> ‚Äî ${it.exercise} ‚Äî ${it.minutes} min\n                  <button style="margin-left:0.75rem;" onclick="removeDesignItem(${i})">Remove</button>\n                </li>`).join('');
        }

        function removeDesignItem(index) {
            window.designItems.splice(index,1);
            renderDesignItems();
            if (window.designItems.length === 0) document.getElementById('morePrompt').style.display = 'none';
        }

        function addAnother() {
            document.getElementById('designExercise').value = '';
            document.getElementById('designDuration').value = '';
            document.getElementById('morePrompt').style.display = 'none';
            document.getElementById('designExercise').focus();
        }

        function finalizeDesignSession() {
            // This will be defined in the module script
            window.firebaseFinalizeDesignSession();
        }

        function renderSessionsList() {
            // This will be defined in the module script
            window.firebaseRenderSessionsList();
        }

        function editSession(docId) {
            // This will be defined in the module script
            window.firebaseEditSession(docId);
        }

        function deleteSession(docId) {
            // This will be defined in the module script
            window.firebaseDeleteSession(docId);
        }

        function planSession() {
            const name = document.getElementById('sessionName').value;
            const date = document.getElementById('sessionDate').value;
            const duration = document.getElementById('sessionDuration').value;
            const type = document.getElementById('sessionType').value;
            
            if (!name || !date || !duration) {
                alert('Please fill in all required fields');
                return;
            }
            
            alert(`Session "${name}" planned for ${date}!`);
            document.querySelector('form').reset();
        }

        // Session Modal Functions
        let currentSessionData = null;
        let currentSessionId = null; // Store the session ID for deletion
        let sessionCheckedItems = {};

        function startSessionById(sessionId) {
            const sessionData = window.sessionDataMap[sessionId];
            if (!sessionData) {
                alert('Session data not found');
                return;
            }
            currentSessionId = sessionId; // Store the ID
            openSessionModal(sessionData);
        }

        function openSessionModal(sessionData) {
            currentSessionData = sessionData;
            sessionCheckedItems = {};

            // Populate header
            document.getElementById('modalSessionDate').textContent = sessionData.date;
            document.getElementById('modalSessionTitle').textContent = 'Session Checklist';

            // Render items
            const list = document.getElementById('modalItemsList');
            list.innerHTML = sessionData.items.map((item, idx) => `
                <li id="item-${idx}">
                    <input type="checkbox" onchange="toggleItemCheck(${idx})">
                    <span class="item-text">${item.type} ‚Äî ${item.exercise} ‚Äî ${item.minutes} min</span>
                </li>
            `).join('');

            // Show modal
            document.getElementById('sessionModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeSessionModal() {
            document.getElementById('sessionModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentSessionData = null;
            currentSessionId = null; // Clear the ID
            sessionCheckedItems = {};
        }

        function toggleItemCheck(index) {
            const checkbox = document.querySelector(`#item-${index} input[type="checkbox"]`);
            const item = document.getElementById(`item-${index}`);

            if (checkbox.checked) {
                sessionCheckedItems[index] = true;
                item.classList.add('checked');
            } else {
                delete sessionCheckedItems[index];
                item.classList.remove('checked');
            }
        }

        function finishSession() {
            if (!currentSessionData) {
                alert('No session data loaded');
                return;
            }
            const totalItems = currentSessionData.items.length;
            const checkedCount = Object.keys(sessionCheckedItems).length;

            if (checkedCount < totalItems) {
                // Show confirm dialog
                const confirmText = `You have ${totalItems - checkedCount} unfinished item(s). Finish anyway?`;
                if (!confirm(confirmText)) {
                    return;
                }
            }

            // Save to history collection
            window.firebaseSaveSessionToHistory(currentSessionData, checkedCount, totalItems, currentSessionId);
        }

        function saveMatchRecord() {
            const date = document.getElementById('matchDate').value;
            const opponent = document.getElementById('opponentName').value.trim();
            const score = document.getElementById('matchScore').value.trim();
            const result = document.getElementById('matchResult').value;

            if (!date) { alert('Please select a match date'); return; }
            if (!opponent) { alert('Please enter opponent name'); return; }
            if (!score) { alert('Please enter the score'); return; }
            if (!result) { alert('Please select the match result'); return; }

            window.firebaseSaveMatchRecord({
                date,
                opponent,
                score,
                result
            });
        }

        function clearTrainingHistory() {
            if (!confirm('Are you sure you want to clear all training session history? This action cannot be undone.')) {
                return;
            }
            window.firebaseClearTrainingHistory();
        }

        function clearMatchHistory() {
            if (!confirm('Are you sure you want to clear all match records? This action cannot be undone.')) {
                return;
            }
            window.firebaseClearMatchHistory();
        }

        // Authentication Functions
        let currentUserId = null;
        let currentUsername = null;

        // Predefined users with passwords
        const demoUsers = {
            'user1': { password: 'password1', userId: 'user1', username: 'User 1' },
            'user2': { password: 'password2', userId: 'user2', username: 'User 2' },
            'user3': { password: 'password3', userId: 'user3', username: 'User 3' }
        };

        function handleSignIn() {
            const username = document.getElementById('signInEmail').value.trim();
            const password = document.getElementById('signInPassword').value.trim();

            if (!username) { alert('Please enter username'); return; }
            if (!password) { alert('Please enter password'); return; }

            // Check credentials
            if (demoUsers[username] && demoUsers[username].password === password) {
                window.firebaseSignIn(username, password);
            } else {
                alert('Invalid username or password');
            }
        }

        function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            window.firebaseLogout();
        }

        document.addEventListener('DOMContentLoaded', function() {
            window.checkAuthState();
        });

    </script>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, where, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAYXyHx7jnCMYgZ6SE8etsXuyPkqRYg_-0",
    authDomain: "tennis-planner-7dd13.firebaseapp.com",
    projectId: "tennis-planner-7dd13",
    storageBucket: "tennis-planner-7dd13.firebasestorage.app",
    messagingSenderId: "912382977591",
    appId: "1:912382977591:web:62110a00fff74b263101b2",
    measurementId: "G-RFV0PV3T43"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);

  // Initialize Firestore
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

window.db = db;
window.storage = storage;
window.addDoc = addDoc;
window.getDocs = getDocs;
window.collection = collection;
window.doc = doc;
window.getDoc = getDoc;
window.updateDoc = updateDoc;
window.deleteDoc = deleteDoc;
window.query = query;
window.where = where;
window.setDoc = setDoc;
window.orderBy = orderBy;
window.ref = ref;
window.uploadBytes = uploadBytes;
window.getDownloadURL = getDownloadURL;

// Authentication Functions
window.checkAuthState = function() {
    const storedUser = localStorage.getItem('currentUser');
    if (storedUser) {
        currentUserId = storedUser;
        const userObj = demoUsers[storedUser];
        currentUsername = userObj ? userObj.username : storedUser;
        document.getElementById('currentUserDisplay').textContent = `üë§ ${currentUsername}`;
        
        // Hide login, show app
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('navbar').style.display = 'block';
        document.getElementById('mainContainer').style.display = 'block';
        
        // Load user data
        setTimeout(async () => {
            await fetchJournalsForUser();
            renderSessionsList();
            window.firebaseRenderHistoryList();
            window.firebaseRenderMatchHistory();
            await window.firebaseRenderJournalList();
            initCalendar();
        }, 500);
        renderDesignItems();
    } else {
        // Show login, hide app
        currentUserId = null;
        currentUsername = null;
        document.getElementById('currentUserDisplay').textContent = '';
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('navbar').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'none';
    }
};

window.firebaseSignIn = async function(username, password) {
    try {
        currentUserId = username;
        const userObj = demoUsers[username];
        currentUsername = userObj ? userObj.username : username;
        
        localStorage.setItem('currentUser', username);
        document.getElementById('currentUserDisplay').textContent = `üë§ ${currentUsername}`;
        
        // Hide login, show app
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('navbar').style.display = 'block';
        document.getElementById('mainContainer').style.display = 'block';
        
        alert(`Welcome, ${currentUsername}!`);
        document.getElementById('signInEmail').value = '';
        document.getElementById('signInPassword').value = '';
        
        // Load user data
        setTimeout(async () => {
            await fetchJournalsForUser();
            renderSessionsList();
            window.firebaseRenderHistoryList();
            window.firebaseRenderMatchHistory();
            await window.firebaseRenderJournalList();
            initCalendar();
        }, 500);
    } catch (error) {
        alert('Sign in failed: ' + error.message);
        console.error(error);
    }
};

window.firebaseLogout = async function() {
    try {
        localStorage.removeItem('currentUser');
        currentUserId = null;
        currentUsername = null;
        document.getElementById('currentUserDisplay').textContent = '';
        
        // Show login, hide app
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('navbar').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'none';
        
        alert('Logged out successfully');
    } catch (error) {
        alert('Logout failed: ' + error.message);
        console.error(error);
    }
};
window.query = query;
window.where = where;

// Firebase-dependent functions
window.firebaseFinalizeDesignSession = async function() {
    const date = document.getElementById('designDate').value;
    if (!date) { alert('Please select a date for the session'); return; }
    if (!window.designItems || window.designItems.length === 0) { alert('Please add at least one type/exercise'); return; }
    
    try {
        const sessionData = {
            date,
            items: (window.designItems || []).slice(),
            created: Date.now(),
            userId: currentUserId
        };
        
        if (window.editingSessionIndex !== null) {
            // Update existing document - validate userId first
            const existingDoc = await getDoc(doc(db, 'sessions', window.editingSessionIndex));
            if (existingDoc.exists() && existingDoc.data().userId !== currentUserId) {
                alert('You do not have permission to edit this session!');
                return;
            }
            await updateDoc(doc(db, 'sessions', window.editingSessionIndex), sessionData);
        } else {
            // Create new document
            await addDoc(collection(db, 'sessions'), sessionData);
        }
        
        window.designItems = [];
        renderDesignItems();
        document.getElementById('designForm').reset();
        document.getElementById('morePrompt').style.display = 'none';
        await window.firebaseRenderSessionsList();
        const btn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.dataset.tab === 'sessions');
        window.editingSessionIndex = null;
        switchTab('sessions', btn || null);
    } catch (error) {
        alert('Error saving session: ' + error.message);
        console.error(error);
    }
};

window.firebaseRenderSessionsList = async function() {
    const listEl = document.getElementById('sessionsList');
    if (!listEl) return;

    const q = query(collection(db, "sessions"), where("userId", "==", currentUserId));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
        listEl.innerHTML = '<li>No sessions planned yet.</li>';
        return;
    }

    let html = "";

    snapshot.forEach(docSnap => {
        const s = docSnap.data();
        const id = docSnap.id;

        const items = (s.items || [])
            .map(it => `<div>${it.type}: ${it.exercise} ‚Äî ${it.minutes} min</div>`)
            .join('');

        // Store session data in map using document ID
        window.sessionDataMap[id] = {date: s.date, items: s.items};

        html += `
    <li>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${s.date}</strong>
        <div>
          <button onclick="window.startSessionById('${id}')" class="submit-btn" style="background:var(--accent);">Start Session</button>
          <button onclick="editSession('${id}')" class="submit-btn">Edit</button>
          <button onclick="deleteSession('${id}')" style="background:#ef4444;border:none;padding:.55rem .8rem;border-radius:8px;color:#fff;cursor:pointer">Delete</button>
        </div>
      </div>
      <div style="margin-top:0.5rem;">${items}</div>
    </li>
`;
    });

    listEl.innerHTML = html;
};

window.firebaseEditSession = async function(docId) {
    try {
        const docRef = doc(db, 'sessions', docId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return alert('Session not found');
        
        const s = docSnap.data();
        
        // Validate userId - prevent users from editing others' sessions
        if (s.userId !== currentUserId) {
            alert('You do not have permission to edit this session!');
            return;
        }
        
        document.getElementById('designDate').value = s.date;
        window.designItems = s.items.slice();
        window.editingSessionIndex = docId;
        renderDesignItems();
        const btn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.dataset.tab === 'design');
        switchTab('design', btn || null);
    } catch (error) {
        alert('Error loading session: ' + error.message);
        console.error(error);
    }
};

window.firebaseDeleteSession = async function(docId) {
    try {
        const docRef = doc(db, 'sessions', docId);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) {
            alert('Session not found!');
            return;
        }
        
        const s = docSnap.data();
        
        // Validate userId - prevent users from deleting others' sessions
        if (s.userId !== currentUserId) {
            alert('You do not have permission to delete this session!');
            return;
        }
        
        if (!confirm('Delete this planned session?')) return;
        
        await deleteDoc(doc(db, 'sessions', docId));
        await window.firebaseRenderSessionsList();
    } catch (error) {
        alert('Error deleting session: ' + error.message);
        console.error(error);
    }
};

window.firebaseSaveSessionToHistory = async function(sessionData, completedCount, totalItems, sessionId) {
    try {
        const historyData = {
            date: sessionData.date,
            items: sessionData.items,
            completedItemsCount: completedCount,
            totalItems: totalItems,
            finishedAtTimestamp: Date.now(),
            userId: currentUserId
        };

        await addDoc(collection(db, 'history'), historyData);

        // Delete the session from sessions collection using the stored ID
        if (sessionId) {
            await deleteDoc(doc(db, 'sessions', sessionId));
        }

        alert('Session saved to history!');
        closeSessionModal();
        await window.firebaseRenderSessionsList(); // Refresh sessions list
        await window.firebaseRenderHistoryList(); // Refresh history list
    } catch (error) {
        alert('Error saving session: ' + error.message);
        console.error(error);
    }
};

window.firebaseRenderHistoryList = async function() {
    const listEl = document.getElementById('historyList');
    if (!listEl) return;

    const q = query(collection(db, 'history'), where("userId", "==", currentUserId));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
        listEl.innerHTML = '<li style="color:#666;padding:1rem;">No completed sessions yet.</li>';
        return;
    }

        let html = "";
        await fetchJournalsForUser();
        snapshot.forEach(docSnap => {
                const h = docSnap.data();
                const completionPercentage = h.totalItems > 0 ? Math.round((h.completedItemsCount / h.totalItems) * 100) : 0;
                const finishedDate = new Date(h.finishedAtTimestamp).toLocaleString();
                const items = (h.items || [])
                        .map(it => `<div>${it.type}: ${it.exercise} ‚Äî ${it.minutes} min</div>`)
                        .join('');
                const journalBtnText = journalMapByRecordId[docSnap.id] ? 'Edit Journal' : 'Add Journal';
                const journalBtn = `<button class='submit-btn' style='background:#1abc9c;margin-top:0.5rem;' onclick='openJournalForRecord("session", "${docSnap.id}", "${h.date}")'>${journalBtnText}</button>`;
                html += `
        <li>
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                    <strong>${h.date}</strong>
                    <p style="color:var(--muted);font-size:0.85rem;margin:0.3rem 0 0 0;">Completed: ${h.completedItemsCount}/${h.totalItems} items (${completionPercentage}%)</p>
                    <p style="color:var(--muted);font-size:0.8rem;margin:0.2rem 0 0 0;">${finishedDate}</p>
                    ${journalBtn}
                </div>
            </div>
            <div style="margin-top:0.5rem;">${items}</div>
        </li>
`;
        });
        listEl.innerHTML = html;
};

window.firebaseSaveMatchRecord = async function(matchData) {
    try {
        const matchRecord = {
            date: matchData.date,
            opponent: matchData.opponent,
            score: matchData.score,
            result: matchData.result,
            savedAtTimestamp: Date.now(),
            userId: currentUserId
        };

        await addDoc(collection(db, 'matches'), matchRecord);

        alert('Match record saved!');
        document.getElementById('matchForm').reset();
        await window.firebaseRenderMatchHistory(); initCalendar();
    } catch (error) {
        alert('Error saving match record: ' + error.message);
        console.error(error);
    }
};

window.firebaseRenderMatchHistory = async function() {
    const listEl = document.getElementById('matchHistoryList');
    if (!listEl) return;

    const q = query(collection(db, 'matches'), where("userId", "==", currentUserId));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
        listEl.innerHTML = '<li style="color:#666;padding:1rem;">No match records yet.</li>';
        return;
    }


        let html = "";
        await fetchJournalsForUser();
        snapshot.forEach(docSnap => {
            const m = docSnap.data();
            const savedDate = new Date(m.savedAtTimestamp).toLocaleString();
            const resultColor = m.result === 'Win' ? '#10b981' : m.result === 'Loss' ? '#ef4444' : '#f59e0b';
            const journalBtnText = journalMapByRecordId[docSnap.id] ? 'Edit Journal' : 'Add Journal';
            const journalBtn = `<button class='submit-btn' style='background:#1abc9c;margin-top:0.5rem;' onclick='openJournalForRecord("match", "${docSnap.id}", "${m.date}")'>${journalBtnText}</button>`;
            html += `
        <li>
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="flex:1;">
              <strong>${m.date}</strong> vs <strong>${m.opponent}</strong>
              <p style="color:var(--muted);font-size:0.85rem;margin:0.3rem 0 0 0;">Score: ${m.score}</p>
              <p style="color:${resultColor};font-size:0.9rem;font-weight:600;margin:0.3rem 0 0 0;">${m.result}</p>
              <p style="color:var(--muted);font-size:0.8rem;margin:0.2rem 0 0 0;">${savedDate}</p>
              ${journalBtn}
            </div>
          </div>
        </li>
    `;
        });
        listEl.innerHTML = html;
};

window.firebaseClearTrainingHistory = async function() {
    try {
        const q = query(collection(db, 'history'), where("userId", "==", currentUserId));
        const snapshot = await getDocs(q);
        const deletePromises = [];
        
        snapshot.forEach(docSnap => {
            deletePromises.push(deleteDoc(doc(db, 'history', docSnap.id)));
        });
        
        await Promise.all(deletePromises);
        
        alert('Training history cleared!');
        await window.firebaseRenderHistoryList();
    } catch (error) {
        alert('Error clearing training history: ' + error.message);
        console.error(error);
    }
};

window.firebaseClearMatchHistory = async function() {
    try {
        const q = query(collection(db, 'matches'), where("userId", "==", currentUserId));
        const snapshot = await getDocs(q);
        const deletePromises = [];
        
        snapshot.forEach(docSnap => {
            deletePromises.push(deleteDoc(doc(db, 'matches', docSnap.id)));
        });
        
        await Promise.all(deletePromises);
        
        alert('Match history cleared!');
        await window.firebaseRenderMatchHistory(); initCalendar();
    } catch (error) {
        alert('Error clearing match history: ' + error.message);
        console.error(error);
    }
};

// TEST FUNCTIONS
window.saveSession = async function(session){
    await addDoc(collection(db,"sessions"), session);
    console.log("Saved:", session);
}

window.loadSessions = async function(){
    const snapshot = await getDocs(collection(db,"sessions"));
    snapshot.forEach(doc => console.log(doc.data()));
}

</script>

<!-- Journal Modal HTML (replaces previous modal if any) -->
<div id="journalEntryModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:100;align-items:center;justify-content:center;">
    <div id="journalModalBox" class="journal-modal-box">
        <h2 id="journalModalTitle">Journal Entry</h2>
        <textarea id="journalEntryTextarea" placeholder="Write your thoughts..."></textarea>
        <div>
            <label style="display:block;margin-bottom:0.5rem;color:#233348;font-weight:600;font-size:.95rem">Voice Note (optional)</label>
            <div style="display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center;">
                <button class="submit-btn" id="startRecordingVoiceBtn" style="background:#ef4444;" onclick="startVoiceRecording()">üé§ Start Recording</button>
                <button class="submit-btn" id="stopRecordingVoiceBtn" style="background:#f59e0b;display:none;" onclick="stopVoiceRecording()">‚èπ Stop</button>
                <span id="recordingTimer" style="color:#ef4444;font-weight:600;font-size:0.9rem;display:none;">0:00</span>
            </div>
            <audio id="voicePreviewAudio" style="display:none;width:100%;margin-top:1rem;" controls></audio>
            <div id="voicePreviewContainer" style="display:none;margin-top:1rem;padding:0.8rem;background:#f1f5f9;border-radius:10px;">
                <p style="color:#233348;font-weight:600;font-size:0.9rem;margin:0 0 0.5rem 0;">Voice Note Preview:</p>
                <audio id="voicePlayback" style="width:100%;" controls></audio>
                <button class="submit-btn" style="background:#ef4444;margin-top:0.5rem;padding:0.5rem 0.8rem;font-size:0.85rem;" onclick="clearVoiceRecording()">Clear Voice Note</button>
            </div>
        </div>
        <div style="display:flex;gap:0.7rem;">
            <button class="submit-btn" id="saveJournalBtn" onclick="saveJournalEntry()">Save</button>
            <button class="submit-btn" style="background:#67748a;" onclick="closeJournalEntryModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
// --- Journal Global State ---
let currentJournalContext = null; // { type, recordId, date }
let currentJournalDocId = null;
let journalMapByRecordId = {}; // { [recordId]: { docId, ...data } }
let mediaRecorder = null;
let recordingChunks = [];
let recordingStartTime = null;
let recordingTimerInterval = null;
let currentVoiceBlob = null;

// --- Modal UI Functions ---
function openJournalForRecord(type, recordId, date) {
    currentJournalContext = { type, recordId, date };
    currentJournalDocId = null;
    clearVoiceRecording();
    const modal = document.getElementById('journalEntryModal');
    const textarea = document.getElementById('journalEntryTextarea');
    const title = document.getElementById('journalModalTitle');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('active');
        textarea.focus();
        window.scrollTo({top:0,behavior:'smooth'});
    }, 10);
    // Title
    title.textContent = (journalMapByRecordId[recordId]) ? 'Edit Journal' : 'Add Journal';
    textarea.value = '';
    // Query Firestore for existing journal
    const journal = journalMapByRecordId[recordId];
    if (journal) {
        textarea.value = journal.text;
        currentJournalDocId = journal.docId;
        if (journal.voiceUrl) {
            document.getElementById('voicePlayback').src = journal.voiceUrl;
            document.getElementById('voicePreviewContainer').style.display = 'block';
            currentVoiceBlob = null; // Clear local blob for edit
        }
    } else {
        textarea.value = '';
        currentJournalDocId = null;
    }
}

function closeJournalEntryModal() {
    const modal = document.getElementById('journalEntryModal');
    modal.classList.remove('active');
    setTimeout(() => { modal.style.display = 'none'; }, 180);
    currentJournalContext = null;
    currentJournalDocId = null;
    clearVoiceRecording();
}

// --- Voice Recording Functions ---
async function startVoiceRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        recordingChunks = [];
        recordingStartTime = Date.now();
        recordingTimerInterval = setInterval(updateRecordingTimer, 100);
        
        mediaRecorder.ondataavailable = (event) => {
            recordingChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordingChunks, { type: 'audio/webm' });
            currentVoiceBlob = blob;
            const url = URL.createObjectURL(blob);
            showVoicePlayback(url);
            clearInterval(recordingTimerInterval);
            document.getElementById('recordingTimer').style.display = 'none';
        };
        
        mediaRecorder.start();
        document.getElementById('startRecordingVoiceBtn').style.display = 'none';
        document.getElementById('stopRecordingVoiceBtn').style.display = 'block';
        document.getElementById('recordingTimer').style.display = 'inline';
    } catch (error) {
        alert('Microphone access denied: ' + error.message);
    }
}

function stopVoiceRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        document.getElementById('stopRecordingVoiceBtn').style.display = 'none';
        document.getElementById('startRecordingVoiceBtn').style.display = 'block';
    }
}

function updateRecordingTimer() {
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const mins = Math.floor(elapsed / 60);
    const secs = elapsed % 60;
    document.getElementById('recordingTimer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
}

function showVoicePlayback(url) {
    document.getElementById('voicePlayback').src = url;
    document.getElementById('voicePreviewContainer').style.display = 'block';
}

function clearVoiceRecording() {
    currentVoiceBlob = null;
    document.getElementById('voicePreviewContainer').style.display = 'none';
    document.getElementById('voicePlayback').src = '';
    document.getElementById('recordingTimer').textContent = '0:00';
}

async function saveJournalEntry() {
    const textarea = document.getElementById('journalEntryTextarea');
    let text = textarea.value.trim();
    if (!text && !currentVoiceBlob) { textarea.focus(); alert('Please add text or record a voice note'); return; }
    
    const { type, recordId, date } = currentJournalContext;
    let voiceUrl = null;
    
    // Upload voice to Firebase Storage if exists
    if (currentVoiceBlob) {
        try {
            const fileName = `journals/${currentUserId}/${recordId}_${Date.now()}.webm`;
            const fileRef = ref(storage, fileName);
            await uploadBytes(fileRef, currentVoiceBlob);
            voiceUrl = await getDownloadURL(fileRef);
        } catch (error) {
            alert('Error uploading voice: ' + error.message);
            return;
        }
    }
    
    const journalsRef = collection(db, 'journals');
    if (currentJournalDocId) {
        // Update
        const updateData = { text };
        if (voiceUrl) updateData.voiceUrl = voiceUrl;
        await updateDoc(doc(db, 'journals', currentJournalDocId), updateData);
    } else {
        // Add
        const docData = {
            userId: currentUserId,
            type,
            recordId,
            date,
            text,
            createdAt: Date.now()
        };
        if (voiceUrl) docData.voiceUrl = voiceUrl;
        await addDoc(journalsRef, docData);
    }
    closeJournalEntryModal();
    await refreshAllJournalUI();
}

// --- Refresh Logic ---
async function refreshAllJournalUI() {
    await fetchJournalsForUser();
    if (window.firebaseRenderHistoryList) await window.firebaseRenderHistoryList();
    if (window.firebaseRenderMatchHistory) await window.firebaseRenderMatchHistory();
    if (window.firebaseRenderJournalList) await window.firebaseRenderJournalList();
}

// --- Fetch all journals for user and build map ---
async function fetchJournalsForUser() {
    journalMapByRecordId = {};
    const q = query(collection(db, 'journals'), where('userId', '==', currentUserId));
    const snapshot = await getDocs(q);
    snapshot.forEach(docSnap => {
        const data = docSnap.data();
        journalMapByRecordId[data.recordId] = { ...data, docId: docSnap.id };
    });
}

// --- Journal Tab Renderer ---
window.firebaseRenderJournalList = async function() {
    const listEl = document.getElementById('journalList');
    if (!listEl) return;
    
    try {
        const q = query(collection(db, 'journals'), where('userId', '==', currentUserId));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            listEl.innerHTML = '<li style="color:#666;padding:1.5rem;text-align:center;">No journal entries yet.</li>';
            return;
        }
        
        // Convert snapshot docs to array
        const journalArray = snapshot.docs.map(docSnap => ({
            ...docSnap.data(),
            docId: docSnap.id
        }));
        
        // Sort by createdAt descending in JavaScript
        journalArray.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        
        let html = '';
        journalArray.forEach(j => {
            const typeColor = j.type === 'session' ? '#ef4444' : '#3b82f6';
            const voiceBtn = j.voiceUrl ? `<audio style='width:100%;max-height:40px;margin-top:0.5rem;' controls><source src='${j.voiceUrl}' type='audio/webm'></audio>` : '';
            html += `<li>
              <div style='display:flex;justify-content:space-between;align-items:flex-start;gap:1.2rem;'>
                <div style='flex:1;'>
                  <div style='font-size:1.08rem;font-weight:600;color:#0f2540;'>${j.date} <span style='background:${typeColor};color:white;padding:0.3rem 0.6rem;border-radius:6px;font-size:0.85rem;font-weight:500;'>${j.type}</span></div>
                  <div style='color:var(--muted);font-size:1.01rem;margin:0.5rem 0 0 0;white-space:pre-line;'>${j.text.length > 180 ? j.text.slice(0,180)+'...' : j.text}</div>
                  ${voiceBtn}
                </div>
                <button class='submit-btn' style='background:#1abc9c;margin-left:1rem;flex-shrink:0;' onclick='openJournalForRecord("${j.type}", "${j.recordId}", "${j.date}")'>Edit</button>
              </div>
            </li>`;
        });
        listEl.innerHTML = html;
    } catch (error) {
        console.error('Error rendering journal list:', error);
        listEl.innerHTML = '<li style="color:#ef4444;padding:1.5rem;text-align:center;">Error loading journal entries. Check console.</li>';
    }
}
</script>

<script>
let calTrainDates={}, calMatchDates={};

function initCalendar(){
    const m=document.getElementById("calMonth");
    const y=document.getElementById("calYear");
    if(!m || !y) {
        console.error('Calendar elements not found');
        return;
    }
    
    // Clear previous options
    m.innerHTML = '';
    y.innerHTML = '';
    
    const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    months.forEach((mo,i)=>{
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = mo;
        m.appendChild(opt);
    });
    
    const cy=new Date().getFullYear();
    for(let yr=cy-2;yr<=cy+2;yr++) {
        const opt = document.createElement('option');
        opt.value = yr;
        opt.textContent = yr;
        y.appendChild(opt);
    }
    
    const now=new Date();
    m.value=now.getMonth(); 
    y.value=now.getFullYear();
    
    m.onchange=renderCalendar; 
    y.onchange=renderCalendar;
    
    loadCalendarData();
}

async function loadCalendarData(){
    try {
        calTrainDates={}; 
        calMatchDates={};
        
        if(!currentUserId) {
            console.log('No user logged in');
            renderCalendar();
            return;
        }
        
        const hSnap=await getDocs(query(collection(db,"history"), where("userId","==",currentUserId)));
        hSnap.forEach(d=> {
            const dateStr = d.data().date;
            if(dateStr) {
                calTrainDates[dateStr]=true;
                console.log('Training date:', dateStr);
            }
        });
        
        const mSnap=await getDocs(query(collection(db,"matches"), where("userId","==",currentUserId)));
        mSnap.forEach(d=> {
            const dateStr = d.data().date;
            if(dateStr) {
                calMatchDates[dateStr]=true;
                console.log('Match date:', dateStr);
            }
        });
        
        renderCalendar();
    } catch (error) {
        console.error('Error loading calendar data:', error);
        renderCalendar();
    }
}

function renderCalendar(){
    const monthEl=document.getElementById("calMonth");
    const yearEl=document.getElementById("calYear");
    
    if(!monthEl || !yearEl) {
        console.error('Calendar selectors not found');
        return;
    }
    
    const month=parseInt(monthEl.value);
    const year=parseInt(yearEl.value);
    
    const first=new Date(year,month,1);
    const last=new Date(year,month+1,0);
    const start=first.getDay();
    const days=last.getDate();
    const grid=document.getElementById("calendarGrid");
    
    if(!grid) {
        console.error('Calendar grid not found');
        return;
    }
    
    grid.innerHTML="";
    
    // Create header row with day names
    const headerRow=document.createElement("div"); 
    headerRow.className="calendar-row";
    const dayNames=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    dayNames.forEach(day=>{
        const dayCell=document.createElement("div");
        dayCell.className="calendar-cell";
        dayCell.textContent=day;
        dayCell.style.fontWeight="700";
        dayCell.style.color="#0f2540";
        dayCell.style.background="transparent";
        headerRow.appendChild(dayCell);
    });
    grid.appendChild(headerRow);
    
    let row=document.createElement("div"); 
    row.className="calendar-row";
    
    // Add empty cells for days before month starts
    for(let i=0;i<start;i++) {
        const emptyCell=document.createElement("div");
        emptyCell.className="calendar-cell";
        emptyCell.style.background='transparent';
        row.appendChild(emptyCell);
    }
    
    // Add date cells
    for(let d=1;d<=days;d++){
        const key=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const cell=document.createElement("div");
        cell.className="calendar-cell";
        
        if(calTrainDates[key]) {
            cell.classList.add("cal-train");
        } else if(calMatchDates[key]) {
            cell.classList.add("cal-match");
        }
        
        cell.textContent=d;
        row.appendChild(cell);
        
        if((start+d)%7===0){ 
            grid.appendChild(row); 
            row=document.createElement("div"); 
            row.className="calendar-row"; 
        }
    }
    
    // Append final row if it has cells
    if(row.children.length > 0) grid.appendChild(row);
    
    console.log('Calendar rendered for', month, year);
}
</script>

</body>
</html>
